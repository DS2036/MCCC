<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>Brain App - Personal Knowledge System</title>
    <style>
        :root {
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-panel: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --highlight-dim: #a33347;
            --text: #eaeaea;
            --text-muted: #8a8a9a;
            --success: #4ade80;
            --warning: #fbbf24;
            --border: #2a2a4a;
            --code-bg: #0d1117;
            --ai-purple: #8b5cf6;
            --ai-blue: #3b82f6;
            --install-green: #22c55e;
            --terminal-green: #00ff00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        /* macOS Titlebar */
        .titlebar {
            -webkit-app-region: drag;
            height: 28px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding-left: 80px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .titlebar-title { flex: 1; text-align: center; margin-right: 80px; }

        /* Layout */
        .app-container {
            display: flex;
            height: calc(100vh - 28px);
        }

        .sidebar {
            width: 300px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-panel {
            width: 350px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s;
        }

        .right-panel.collapsed { width: 40px; }
        .right-panel.collapsed .panel-content { display: none; }
        .right-panel.collapsed .panel-header span { display: none; }

        /* Sidebar Header */
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .restart-btn {
            margin-left: auto;
            padding: 0.2rem 0.4rem;
            background: var(--accent);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .restart-btn:hover {
            background: var(--highlight);
            transform: rotate(180deg);
        }

        /* Claude CLI Status Indicator */
        .cli-indicator {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.65rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .cli-indicator:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.status-checking {
            background: #f59e0b;
            box-shadow: 0 0 6px #f59e0b;
        }

        .status-dot.status-connected {
            background: #10b981;
            box-shadow: 0 0 6px #10b981;
            animation: none;
        }

        .status-dot.status-disconnected {
            background: #ef4444;
            box-shadow: 0 0 6px #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
            margin-top: 0.75rem;
        }

        .stat-box {
            background: var(--accent);
            padding: 0.4rem;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--highlight); }
        .stat-label { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; }

        /* Sidebar Toggle */
        .sidebar-toggle {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-toggle-btn {
            flex: 1;
            padding: 0.6rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .sidebar-toggle-btn:hover { background: var(--accent); color: var(--text); }
        .sidebar-toggle-btn.active { color: var(--highlight); border-bottom-color: var(--highlight); background: rgba(233, 69, 96, 0.1); }

        /* Content Lists */
        .content-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.25rem;
        }

        /* Collapsible Category */
        .category-section { margin-bottom: 0.25rem; }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .category-header:hover { background: var(--accent); }

        .category-header .chevron {
            margin-left: auto;
            transition: transform 0.2s;
            font-size: 0.6rem;
        }

        .category-header.collapsed .chevron { transform: rotate(-90deg); }

        .category-items { overflow: hidden; transition: max-height 0.3s; }
        .category-items.collapsed { max-height: 0 !important; }

        .list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            padding-left: 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.1rem;
            border-left: 2px solid transparent;
        }

        .list-item:hover { background: var(--accent); }
        .list-item.active { background: rgba(233, 69, 96, 0.2); border-left-color: var(--highlight); }

        .list-item-icon { font-size: 1rem; }
        .list-item-info { flex: 1; min-width: 0; }
        .list-item-title { font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-meta { font-size: 0.65rem; color: var(--text-muted); margin-top: 0.1rem; }

        .delete-btn {
            opacity: 0;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 0.3rem;
            transition: all 0.2s;
            line-height: 1;
        }
        .list-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #ef4444; transform: scale(1.2); }

        .move-btn {
            opacity: 0;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0 0.2rem;
            transition: all 0.2s;
        }
        .list-item:hover .move-btn { opacity: 1; }
        .move-btn:hover { color: var(--accent); }

        .folder-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.85rem;
        }
        .folder-header:hover { background: var(--accent); }
        .folder-header .folder-actions-btns {
            margin-left: auto;
            display: flex;
            gap: 0.3rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .folder-header:hover .folder-actions-btns { opacity: 1; }
        .folder-action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.1rem 0.3rem;
        }
        .folder-action-btn:hover { color: var(--highlight); }

        .folder-menu-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }
        .folder-menu-item:hover { background: var(--accent); }

        .folder-items { padding-left: 0.75rem; }

        .folder-status { font-size: 0.6rem; padding: 0.1rem 0.3rem; border-radius: 3px; }
        .status-active { background: var(--install-green); color: white; }
        .status-setup { background: var(--warning); color: black; }

        /* Main Header */
        .main-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 1rem;
        }

        .tab-bar { display: flex; gap: 0.25rem; }

        .tab {
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab:hover { color: var(--text); background: var(--accent); }
        .tab.active { color: var(--highlight); border-bottom-color: var(--highlight); }

        /* Content Panel */
        .content-panel { flex: 1; overflow-y: auto; padding: 1rem; }
        .panel-hidden { display: none; }

        /* Note Styles */
        .note-header { margin-bottom: 1.5rem; }
        .note-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem; }

        .note-badges { display: flex; flex-wrap: wrap; gap: 0.4rem; }

        .badge {
            padding: 0.25rem 0.5rem;
            background: var(--accent);
            border-radius: 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .badge-category { background: var(--highlight); color: white; }
        .badge-success { background: var(--install-green); color: white; }
        .badge-warning { background: var(--warning); color: black; }

        /* Section */
        .note-section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .section-content { color: var(--text); line-height: 1.5; font-size: 0.85rem; }

        /* Buttons */
        .btn {
            padding: 0.4rem 0.75rem;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--accent);
            color: var(--text);
        }

        .btn:hover { background: var(--highlight); border-color: var(--highlight); }
        .btn-install { background: var(--install-green); border-color: var(--install-green); color: white; }
        .btn-install:hover { background: #16a34a; }

        /* Code Block */
        .code-block {
            background: var(--code-bg);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .code-block pre {
            padding: 0.75rem;
            overflow-x: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            color: var(--text);
        }

        /* Data Table */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .data-table th, .data-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background: var(--accent); color: var(--text-muted); font-weight: 600; }
        .data-table tr:hover { background: var(--accent); }

        /* Install Item */
        .install-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-panel);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }

        .install-item.installed { border-color: var(--install-green); background: rgba(34, 197, 94, 0.1); }
        .install-icon { font-size: 1.25rem; }
        .install-info { flex: 1; }
        .install-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 0.15rem; }
        .install-desc { font-size: 0.7rem; color: var(--text-muted); }
        .install-actions { display: flex; gap: 0.4rem; }

        /* Right Panel */
        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .panel-header:hover { background: var(--accent); }
        .panel-toggle { margin-left: auto; font-size: 0.8rem; }

        .panel-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Terminal */
        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--code-bg);
            border-bottom: 1px solid var(--border);
        }

        .terminal-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .terminal-header .chevron { margin-left: auto; transition: transform 0.2s; }
        .terminal-header.collapsed .chevron { transform: rotate(-90deg); }

        .terminal-output {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.7rem;
            line-height: 1.4;
            color: var(--terminal-green);
            min-height: 150px;
            max-height: 200px;
        }

        .terminal-output.collapsed { display: none; }

        .terminal-line { margin-bottom: 0.25rem; }
        .terminal-line.error { color: var(--highlight); }
        .terminal-line.info { color: var(--ai-blue); }
        .terminal-line.success { color: var(--install-green); }

        .terminal-input-line {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
        }

        .terminal-prompt { color: var(--ai-purple); margin-right: 0.5rem; font-family: monospace; font-size: 0.75rem; }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            outline: none;
        }

        /* DevTools Panel */
        .devtools-container { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        .devtools-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .devtools-header .chevron { margin-left: auto; transition: transform 0.2s; }
        .devtools-header.collapsed .chevron { transform: rotate(-90deg); }

        .devtools-output {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.7rem;
            background: var(--code-bg);
        }

        .devtools-output.collapsed { display: none; }

        /* Gemini Analysis Styles */
        .gemini-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-dark);
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
        }

        .status-indicator { font-size: 0.6rem; }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--highlight);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .analysis-content {
            background: var(--bg-dark);
            border-radius: 6px;
            padding: 1rem;
            font-size: 0.85rem;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .analysis-content h2 {
            color: var(--highlight);
            font-size: 1rem;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.3rem;
        }

        .analysis-content h3 {
            color: var(--ai-blue);
            font-size: 0.9rem;
            margin-top: 1rem;
            margin-bottom: 0.4rem;
        }

        .analysis-content pre {
            background: var(--code-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            overflow-x: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            margin: 0.5rem 0;
        }

        .analysis-content code {
            background: var(--code-bg);
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
        }

        .analysis-content ul, .analysis-content ol {
            margin-left: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .analysis-content li { margin-bottom: 0.3rem; }

        .analysis-content strong { color: var(--warning); }

        .transcript-content {
            background: var(--bg-dark);
            border-radius: 6px;
            padding: 1rem;
            font-size: 0.8rem;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .transcript-line {
            display: flex;
            gap: 0.75rem;
            padding: 0.3rem 0;
            border-bottom: 1px solid var(--border);
        }

        .transcript-time {
            color: var(--ai-purple);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.7rem;
            min-width: 50px;
        }

        .transcript-text { flex: 1; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.8rem;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-color: var(--install-green); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Notes textarea */
        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.8rem;
            resize: vertical;
            margin-top: 0.4rem;
        }

        .notes-textarea:focus { outline: none; border-color: var(--highlight); }

        /* Star Rating */
        .star-rating { display: flex; gap: 0.2rem; margin-top: 0.75rem; }
        .star { font-size: 1.25rem; cursor: pointer; color: var(--border); transition: color 0.2s; }
        .star.filled, .star:hover { color: var(--warning); }

        /* Quick Actions */
        .quick-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        .quick-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .quick-action-btn:hover { background: var(--accent); border-color: var(--ai-purple); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.25rem;
        }
        .modal-close:hover { color: var(--danger); }

        .modal-body { margin-bottom: 1rem; }

        .modal-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--highlight);
        }

        .modal-input-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .modal-footer {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .analysis-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .analysis-type-btn {
            flex: 1;
            min-width: 100px;
            padding: 0.6rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .analysis-type-btn:hover { border-color: var(--highlight); }
        .analysis-type-btn.active {
            background: var(--highlight);
            color: var(--bg-primary);
            border-color: var(--highlight);
        }
    </style>
</head>
<body>
    <div class="titlebar">
        <span class="titlebar-title">Brain App - Personal Knowledge System</span>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>üß†</span>
                    <span>Brain App</span>
                    <div id="claudeCliIndicator" class="cli-indicator" title="Claude Code CLI Status" onclick="showClaudeCliDetails()">
                        <span id="cliStatusDot" class="status-dot status-checking"></span>
                        <span id="cliStatusLabel">CLI</span>
                    </div>
                    <div id="systemStatsIndicator" class="cli-indicator" title="Systeem Status" onclick="showSystemStats()">
                        <span id="sysStatusDot" class="status-dot status-connected"></span>
                        <span id="sysStatusLabel">SYS</span>
                    </div>
                    <button class="restart-btn" onclick="restartApp()" title="Herstart App">üîÑ</button>
                </div>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-value" id="stat-videos">2</div>
                        <div class="stat-label">Content</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-folders">12</div>
                        <div class="stat-label">Folders</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-items">11</div>
                        <div class="stat-label">Items</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Toggle -->
            <div class="sidebar-toggle">
                <button class="sidebar-toggle-btn active" data-view="videos" onclick="switchSidebarView('videos')">
                    üì• Input Content
                </button>
                <button class="sidebar-toggle-btn" data-view="brein" onclick="switchSidebarView('brein')">
                    üß† Brein
                </button>
                <button class="sidebar-toggle-btn" data-view="anthropic" onclick="switchSidebarView('anthropic')">
                    ü§ñ Claude
                </button>
            </div>

            <!-- Mijn Brein List -->
            <div class="content-list" id="breinList" style="display: none;">
                <!-- Dynamisch gevuld met collapsible categories -->
            </div>

            <!-- Anthropic/Claude Code List -->
            <div class="content-list" id="anthropicList" style="display: none;">
                <!-- Dynamisch gevuld met commands, skills, agents -->
            </div>

            <!-- Video List (hidden by default) -->
            <div class="content-list" id="videoList">
            </div>
        </aside>

        <!-- Custom Prompt Modal (Electron doesn't support prompt()) -->
        <div class="modal-overlay" id="promptModal">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <span class="modal-title" id="promptModalTitle">Invoer</span>
                    <button class="modal-close" onclick="closePromptModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <label class="modal-input-label" id="promptModalLabel">Voer een waarde in:</label>
                    <input type="text" class="modal-input" id="promptModalInput" placeholder="">
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closePromptModal()">Annuleren</button>
                    <button class="btn btn-install" onclick="submitPromptModal()">OK</button>
                </div>
            </div>
        </div>

        <!-- Input Content Modal -->
        <div class="modal-overlay" id="inputModal">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title" id="modalTitle">Nieuwe Content Toevoegen</span>
                    <button class="modal-close" onclick="closeInputModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- YouTube Input - SIMPLIFIED: Only upload info -->
                    <div id="youtubeInputSection">
                        <label class="modal-input-label">YouTube URL</label>
                        <input type="text" class="modal-input" id="youtubeUrlInput" placeholder="https://www.youtube.com/watch?v=...">

                        <label class="modal-input-label">Titel (optioneel - wordt automatisch opgehaald)</label>
                        <input type="text" class="modal-input" id="contentTitleInput" placeholder="Laat leeg voor automatische titel">

                        <label class="modal-input-label">Categorie</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <select class="modal-input" id="contentCategorySelect" style="flex: 1; margin-bottom: 0;" onchange="handleCategoryChange()">
                                <option value="YouTube">YouTube</option>
                                <option value="AI Development">ü§ñ AI Development</option>
                                <option value="Tutorials">Tutorials</option>
                                <option value="Code Reviews">Code Reviews</option>
                                <option value="Documentatie">Documentatie</option>
                                <option value="__new__">+ Nieuwe categorie maken...</option>
                            </select>
                        </div>
                        <input type="text" class="modal-input" id="newCategoryInput" placeholder="Naam van nieuwe categorie..." style="display: none;">

                        <label class="modal-input-label">Opslaan in Map (optioneel)</label>
                        <select class="modal-input folder-select" id="youtubeFolderSelect" style="margin-bottom: 0;">
                            <option value="">-- Geen map (root) --</option>
                        </select>

                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                            üí° Na toevoegen: selecteer de video in de sidebar en ga naar <strong>Analyseer</strong> tab voor analyse opties.
                        </p>
                    </div>

                    <!-- Audio Input - SIMPLIFIED: Only upload/record -->
                    <div id="audioInputSection" style="display: none;">
                        <label class="modal-input-label">Kies een optie:</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="btn" onclick="selectAudioFile()" style="flex: 1;">
                                üìÅ Bestand Kiezen
                            </button>
                            <button class="btn" onclick="startAudioRecording()" id="recordAudioBtn" style="flex: 1; background: linear-gradient(135deg, #e74c3c, #c0392b);">
                                üéôÔ∏è Nu Opnemen
                            </button>
                        </div>

                        <!-- Recording Controls -->
                        <div id="audioRecordingControls" style="display: none; margin-bottom: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                            <div id="recordingIndicator" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="width: 12px; height: 12px; background: #e74c3c; border-radius: 50%; animation: pulse 1s infinite;"></span>
                                <span id="recordingTime" style="font-family: monospace; font-size: 1.2rem;">00:00</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn" onclick="stopAudioRecording()" style="background: #27ae60;">
                                    ‚èπÔ∏è Stop & Opslaan
                                </button>
                                <button class="btn" onclick="cancelAudioRecording()" style="background: #e74c3c;">
                                    ‚ùå Annuleren
                                </button>
                            </div>
                        </div>

                        <input type="text" class="modal-input" id="audioFileInput" placeholder="Geselecteerd/opgenomen bestand..." readonly>

                        <label class="modal-input-label">Titel</label>
                        <input type="text" class="modal-input" id="audioTitleInput" placeholder="Audio titel (bijv: Meeting Notes, Interview)">

                        <label class="modal-input-label">Categorie</label>
                        <select class="modal-input" id="audioCategorySelect" style="margin-bottom: 0.5rem;">
                            <option value="Audio">Audio</option>
                            <option value="Meetings">Meetings / Gesprekken</option>
                            <option value="Interviews">Interviews</option>
                            <option value="Notities">Voice Notities</option>
                        </select>

                        <label class="modal-input-label">Opslaan in Map (optioneel)</label>
                        <select class="modal-input folder-select" id="audioFolderSelect" style="margin-bottom: 0;">
                            <option value="">-- Geen map (root) --</option>
                        </select>

                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                            üí° Na toevoegen: selecteer de audio in de sidebar en ga naar <strong>Analyseer</strong> tab voor transcriptie en analyse opties.
                        </p>
                    </div>

                    <!-- Video File Input (hidden by default) -->
                    <div id="videoInputSection" style="display: none;">
                        <label class="modal-input-label">Kies een optie:</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="btn" onclick="selectVideoFile()" style="flex: 1;">
                                üìÅ Bestand Kiezen
                            </button>
                            <button class="btn" onclick="startVideoRecording()" id="recordVideoBtn" style="flex: 1; background: linear-gradient(135deg, #3498db, #2980b9);">
                                üé• Opnemen
                            </button>
                        </div>

                        <!-- Video Recording Controls -->
                        <div id="videoRecordingControls" style="display: none; margin-bottom: 1rem;">
                            <video id="videoPreview" style="width: 100%; max-height: 200px; background: #000; border-radius: 8px; margin-bottom: 0.5rem;" autoplay muted></video>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 12px; height: 12px; background: #e74c3c; border-radius: 50%; animation: pulse 1s infinite;"></span>
                                <span id="videoRecordingTime" style="font-family: monospace; font-size: 1.2rem;">00:00</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn" onclick="stopVideoRecording()" style="background: #27ae60;">
                                    ‚èπÔ∏è Stop
                                </button>
                                <button class="btn" onclick="cancelVideoRecording()" style="background: #e74c3c;">
                                    ‚ùå Annuleren
                                </button>
                            </div>
                        </div>

                        <input type="text" class="modal-input" id="videoFileInput" placeholder="Geselecteerd/opgenomen bestand..." readonly>

                        <label class="modal-input-label">Titel</label>
                        <input type="text" class="modal-input" id="videoTitleInput" placeholder="Video titel">

                        <label class="modal-input-label">Categorie</label>
                        <select class="modal-input" id="videoCategorySelect" style="margin-bottom: 0.5rem;">
                            <option value="Video">Video</option>
                            <option value="Screen Recording">Screen Recording</option>
                            <option value="Tutorials">Tutorials</option>
                        </select>

                        <label class="modal-input-label">Opslaan in Map (optioneel)</label>
                        <select class="modal-input folder-select" id="videoFolderSelect" style="margin-bottom: 0;">
                            <option value="">-- Geen map (root) --</option>
                        </select>

                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                            üí° Na toevoegen: selecteer de video in de sidebar en ga naar <strong>Analyseer</strong> tab voor analyse opties.
                        </p>
                    </div>

                    <!-- Document Input - SIMPLIFIED: Only upload info -->
                    <div id="documentInputSection" style="display: none;">
                        <!-- Multi-document Upload -->
                        <label class="modal-input-label">Documenten (meerdere mogelijk)</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <button class="btn" onclick="selectDocumentFiles()" style="flex: 1;">
                                üìÅ Selecteer Bestanden
                            </button>
                            <button class="btn" onclick="clearDocumentFiles()" style="width: auto; padding: 0.5rem 1rem;">
                                üóëÔ∏è
                            </button>
                        </div>
                        <div id="documentFilesList" style="max-height: 120px; overflow-y: auto; background: var(--bg-primary); border-radius: 6px; padding: 0.5rem; margin-bottom: 0.75rem; font-size: 0.8rem;">
                            <span style="color: var(--text-muted);">Geen bestanden geselecteerd</span>
                        </div>
                        <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                            Ondersteund: PDF, TXT, MD, DOCX, JSON, CSV, XML, HTML
                        </p>

                        <label class="modal-input-label">Project Titel</label>
                        <input type="text" class="modal-input" id="documentTitleInput" placeholder="Bijv: Trading Bot Specificaties" style="margin-bottom: 0.75rem;">

                        <label class="modal-input-label">Categorie</label>
                        <select class="modal-input" id="documentCategorySelect" style="margin-bottom: 0.5rem;">
                            <option value="Documenten">Documenten</option>
                            <option value="Specificaties">Specificaties</option>
                            <option value="AI Development">ü§ñ AI Development</option>
                            <option value="Documentatie">Documentatie</option>
                        </select>

                        <label class="modal-input-label">Opslaan in Map (optioneel)</label>
                        <select class="modal-input folder-select" id="documentFolderSelect" style="margin-bottom: 0;">
                            <option value="">-- Geen map (root) --</option>
                        </select>

                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                            üí° Na toevoegen: selecteer het document in de sidebar en ga naar <strong>Analyseer</strong> tab voor analyse opties.
                        </p>
                    </div>

                    <!-- Progress -->
                    <div id="modalProgress" style="display: none; margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; background: var(--bg-primary); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="modalProgressBar" style="background: var(--highlight); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <span id="modalProgressPercent" style="font-size: 0.85rem; font-weight: 600; color: var(--highlight); min-width: 45px; text-align: right;">0%</span>
                        </div>
                        <div id="modalProgressText" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem; text-align: center;">
                            Analyseren...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeInputModal()">Annuleren</button>
                    <button class="btn btn-install" id="modalSubmitBtn" onclick="submitInputContent()">
                        ‚ûï Toevoegen
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="tab-bar">
                    <button class="tab active" data-tab="analyze">üî¨ Analyseer</button>
                    <button class="tab" data-tab="overview">üìã Overview</button>
                    <button class="tab" data-tab="install">üöÄ Installeer</button>
                    <button class="tab" data-tab="code">üíª Code</button>
                    <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
                </div>
            </header>

            <!-- Overview Panel -->
            <div class="content-panel panel-hidden" id="panel-overview">
                <div id="overviewContent"></div>

                <!-- FASE 2: Document Samenvatting & Specificaties (voor documenten) -->
                <div id="docFase2Section" class="note-section" style="display: none;">
                    <h2 class="section-title">üìä FASE 2: Samenvatting & Specificaties</h2>
                    <div class="section-content">
                        <!-- Selected Document Info -->
                        <div id="fase2DocInfo" style="padding: 0.75rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.25rem;" id="fase2DocTitle">Document</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted);" id="fase2AnalysesCount">Voltooide analyses: 0</p>
                        </div>

                        <!-- Samenvatting Generator -->
                        <div style="border: 1px solid var(--ai-purple); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05));">
                            <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: var(--ai-purple);">
                                üìù Gecombineerde Samenvatting
                            </h3>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                                Combineer alle voltooide analyses tot √©√©n coherent overzicht met de belangrijkste bevindingen.
                            </p>
                            <button id="generateSummaryBtn" class="btn btn-install" onclick="generateDocSummary()" style="width: 100%; font-size: 0.9rem; padding: 0.75rem;">
                                üìä Genereer Samenvatting
                            </button>
                            <div id="docSummaryStatus" style="margin-top: 0.5rem;"></div>
                        </div>

                        <!-- Samenvatting Preview -->
                        <div id="docSummaryPreview" style="display: none; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; background: var(--bg-secondary); margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                <h3 style="margin: 0; font-size: 1rem;">üìã Samenvatting</h3>
                                <button class="btn" onclick="copySummaryToClipboard()" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">üìã Kopieer</button>
                            </div>
                            <div id="docSummaryContent" style="font-size: 0.85rem; line-height: 1.6; max-height: 300px; overflow-y: auto; white-space: pre-wrap;"></div>
                        </div>

                        <!-- Specificaties Extractor -->
                        <div style="border: 1px solid var(--success); border-radius: 10px; padding: 1rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.05));">
                            <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: var(--success);">
                                üìã Technische Specificaties
                            </h3>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                                Extraheer alle technische specs, requirements en parameters uit de analyses.
                            </p>
                            <button id="extractSpecsBtn" class="btn btn-install" onclick="extractDocSpecs()" style="width: 100%; font-size: 0.9rem; padding: 0.75rem; background: var(--success);">
                                üîß Extraheer Specificaties
                            </button>
                            <div id="docSpecsStatus" style="margin-top: 0.5rem;"></div>
                        </div>

                        <!-- Specificaties Preview -->
                        <div id="docSpecsPreview" style="display: none; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; background: var(--bg-secondary); margin-top: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                <h3 style="margin: 0; font-size: 1rem;">üîß Specificaties</h3>
                                <button class="btn" onclick="copySpecsToClipboard()" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">üìã Kopieer</button>
                            </div>
                            <div id="docSpecsContent" style="font-size: 0.85rem; line-height: 1.6; max-height: 300px; overflow-y: auto; white-space: pre-wrap;"></div>
                        </div>

                        <!-- Requirement Note -->
                        <div id="fase2RequirementNote" style="margin-top: 1rem; padding: 0.75rem; background: rgba(251, 191, 36, 0.1); border: 1px solid var(--warning); border-radius: 8px;">
                            <p style="font-size: 0.8rem; color: var(--warning); margin: 0;">
                                ‚ö†Ô∏è Voer eerst analyses uit in de Analyseer tab om samenvattingen te kunnen genereren.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analyze Panel - DYNAMIC based on selected content type - DEFAULT VISIBLE -->
            <div class="content-panel" id="panel-analyze">
                <!-- No Content Selected Message -->
                <div id="noContentSelected" class="note-section">
                    <div class="section-content" style="text-align: center; padding: 3rem 1rem;">
                        <span style="font-size: 3rem; opacity: 0.5;">üìã</span>
                        <h3 style="margin: 1rem 0 0.5rem; color: var(--text-muted);">Selecteer content om te analyseren</h3>
                        <p style="color: var(--text-muted); font-size: 0.85rem;">
                            Kies een item uit de sidebar links om analyse opties te zien.
                        </p>
                    </div>
                </div>

                <!-- YouTube Analysis Options -->
                <div id="youtubeAnalysisSection" class="note-section" style="display: none;">
                    <h2 class="section-title">üé¨ YouTube Video Analyseren</h2>
                    <div class="section-content">
                        <!-- Selected Content Info -->
                        <div id="ytSelectedInfo" style="padding: 0.75rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.25rem;" id="ytSelectedTitle">Video titel</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted);" id="ytSelectedUrl">URL</p>
                        </div>

                        <!-- Analysis Engine Selection -->
                        <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Analyse Methode</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="analysis-type-btn" id="analyzeYtEngineTranscript" data-yt-engine="transcript" onclick="selectYouTubeEngine('transcript')" style="flex: 1;">
                                ü§ñ Transcript (Claude CLI)
                            </button>
                            <button class="analysis-type-btn active" id="analyzeYtEngineVisual" data-yt-engine="visual" onclick="selectYouTubeEngine('visual')" style="flex: 1;">
                                üëÅÔ∏è Visueel (Gemini)
                            </button>
                        </div>

                        <!-- Claude CLI Info -->
                        <div id="analyzeTranscriptEngineInfo" style="display: none; padding: 0.75rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid var(--ai-purple); border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.75rem; color: var(--ai-purple); font-weight: 600; margin-bottom: 0.3rem;">
                                ü§ñ Claude Code CLI - Transcript
                            </p>
                            <p style="font-size: 0.7rem; color: var(--text-muted);">
                                Analyseert het YouTube transcript met Claude CLI. Snel voor tutorials, uitleg en gesproken content.
                            </p>
                        </div>

                        <!-- Gemini Visual Info -->
                        <div id="analyzeVisualEngineInfo" style="padding: 0.75rem; background: rgba(66, 133, 244, 0.1); border: 1px solid #4285f4; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 0.75rem; color: #4285f4; font-weight: 600; margin-bottom: 0.3rem;">
                                üëÅÔ∏è Gemini Visuele Analyse - Voor Code uit Beeld
                            </p>
                            <p style="font-size: 0.7rem; color: var(--text-muted);">
                                Download video, splits in segmenten, analyseert elk frame visueel. Ideaal voor code die op scherm wordt getypt.
                            </p>
                            <p style="font-size: 0.65rem; color: var(--warning); margin-top: 0.3rem;">
                                ‚ö†Ô∏è Dit kan 15-30+ minuten duren voor lange video's.
                            </p>
                        </div>

                        <!-- Analysis Type -->
                        <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Analyse Type</label>
                        <div class="analysis-type-selector" style="margin-bottom: 1rem;">
                            <button class="analysis-type-btn" data-type="full" onclick="selectAnalysisType('full')">
                                üìä Volledig
                            </button>
                            <button class="analysis-type-btn active" data-type="technical-deepdive" onclick="selectAnalysisType('technical-deepdive')">
                                üîß Tech Deep-Dive
                            </button>
                            <button class="analysis-type-btn" data-type="code-extraction" onclick="selectAnalysisType('code-extraction')">
                                üíª Code Extract
                            </button>
                            <button class="analysis-type-btn" data-type="tutorial" onclick="selectAnalysisType('tutorial')">
                                üìö Tutorial
                            </button>
                        </div>

                        <!-- Visual Analysis Options (shown by default) -->
                        <div id="analyzeVisualOptions" style="display: block;">
                            <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Video Kwaliteit</label>
                            <select id="analyzeVideoQualitySelect" style="width: 100%; padding: 0.6rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.9rem; margin-bottom: 1rem;">
                                <option value="1080" selected>1080p (Verplicht voor code leesbaarheid)</option>
                            </select>

                            <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Segment Duur</label>
                            <select id="analyzeChunkDurationSelect" style="width: 100%; padding: 0.6rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.9rem; margin-bottom: 1rem;">
                                <option value="3" selected>3 minuten (Aanbevolen - beste detail)</option>
                                <option value="5">5 minuten (Balans)</option>
                                <option value="10">10 minuten (Sneller)</option>
                            </select>
                        </div>

                        <!-- Extra Context -->
                        <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Extra Context (optioneel)</label>
                        <textarea id="analyzeContextInput" placeholder="Specifieke instructies voor de analyse..." style="width: 100%; padding: 0.6rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.9rem; height: 80px; resize: vertical; margin-bottom: 1rem;"></textarea>

                        <!-- Action Button -->
                        <button class="btn btn-install" onclick="analyzeSelectedContent()" style="width: 100%;">
                            üöÄ Start Analyse
                        </button>
                    </div>
                </div>

                <!-- Document Analysis Options - 3-FASE WORKFLOW -->
                <div id="documentAnalysisSection" class="note-section" style="display: none;">
                    <h2 class="section-title">üìÑ Document Analyse Workflow</h2>
                    <div class="section-content">
                        <!-- Selected Content Info -->
                        <div id="docSelectedInfo" style="padding: 0.75rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.25rem;" id="docSelectedTitle">Document titel</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted);" id="docSelectedFiles">Bestanden</p>
                        </div>

                        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                        <!-- ANALYSEER TAB: ALLEEN FASE 1 - ALLE ANALYSES -->
                        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

                        <!-- Nieuwe Analyse Formulier - Altijd zichtbaar bovenaan -->
                        <div style="border: 1px solid var(--ai-blue); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.05));">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--ai-blue);">
                                üî¨ Nieuwe Analyse Configureren
                            </h3>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Perspectief (optioneel)</label>
                                    <select id="newAnalysisPersona" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem;">
                                        <option value="">-- Geen specifiek perspectief --</option>
                                        <option value="engineer">üîß Burgerlijk Ingenieur</option>
                                        <option value="developer">üë®‚Äçüíª Software Developer</option>
                                        <option value="architect">üèóÔ∏è Software Architect</option>
                                        <option value="analyst">üìä Business Analyst</option>
                                        <option value="researcher">üî¨ Onderzoeker</option>
                                        <option value="student">üéì Student</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Type Analyse (optioneel)</label>
                                    <select id="newAnalysisType" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem;">
                                        <option value="">-- Geen specifiek type --</option>
                                        <option value="readable">üìñ Leesbaar (PDF-vriendelijk)</option>
                                        <option value="summary">üìù Samenvatting</option>
                                        <option value="technical">üîß Technische Analyse</option>
                                        <option value="business">üíº Business Analyse</option>
                                        <option value="data-extraction">üìä Data Extractie</option>
                                        <option value="requirements">üìã Requirements Analyse</option>
                                        <option value="risk">‚ö†Ô∏è Risico Analyse</option>
                                        <option value="implementation">üöÄ Implementatie Plan</option>
                                    </select>
                                </div>
                            </div>

                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Extra Instructies (optioneel)</label>
                                <textarea id="newAnalysisInstructions" placeholder="Specifieke vragen of focus punten voor deze analyse..." style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem; height: 60px; resize: vertical;"></textarea>
                            </div>

                            <button class="btn btn-install" onclick="runNewAnalysis()" style="width: 100%; font-size: 0.9rem; padding: 0.75rem;">
                                üöÄ Start Analyse
                            </button>

                            <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 0.5rem;">
                                Kies een Perspectief + Type combinatie, of laat leeg voor algemene analyse
                            </p>
                        </div>

                        <!-- Actieve Analyse Log -->
                        <div id="activeAnalysisLog" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-dark); border-radius: 8px; border-left: 4px solid var(--ai-blue);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                                <span id="activeAnalysisName" style="font-size: 0.9rem; font-weight: 600;">Analyse bezig...</span>
                            </div>
                            <div id="activeAnalysisProgress" style="font-size: 0.8rem; color: var(--text-muted); max-height: 80px; overflow-y: auto;"></div>
                        </div>

                        <!-- Alle Analyses Lijst - GROOT VAK -->
                        <div style="border: 1px solid var(--border); border-radius: 10px; padding: 1rem; background: var(--bg-secondary);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                <h3 style="margin: 0; font-size: 1rem;">
                                    üìã Uitgevoerde Analyses
                                </h3>
                                <span id="analysesCount" style="background: var(--ai-blue); color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem;">0</span>
                            </div>

                            <div id="docAnalysesList" style="min-height: 200px; max-height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem;">
                                <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 2rem;">
                                    Nog geen analyses uitgevoerd.<br>
                                    <span style="font-size: 0.8rem;">Configureer hierboven een analyse en klik op "Start Analyse"</span>
                                </p>
                            </div>
                        </div>

                        <!-- Hidden panel for backward compatibility -->
                        <div id="newAnalysisPanel" style="display: none;"></div>

                        <!-- Legacy support -->
                        <input type="hidden" id="analyzeDocPersonaSelect" value="engineer">
                        <input type="hidden" id="analyzeDocGoalSelect" value="build-app">
                        <input type="hidden" id="analyzeClaudeBuildToggle" checked>
                        <textarea id="analyzeDocInstructionsInput" style="display: none;"></textarea>
                    </div>
                </div>

                <!-- Video/Audio Analysis Options -->
                <div id="videoAudioAnalysisSection" class="note-section" style="display: none;">
                    <h2 class="section-title" id="videoAudioSectionTitle">üé• Video Analyseren</h2>
                    <div class="section-content">
                        <!-- Selected Content Info -->
                        <div id="videoAudioSelectedInfo" style="padding: 0.75rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.25rem;" id="videoAudioSelectedTitle">Titel</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted);" id="videoAudioSelectedFile">Bestand</p>
                        </div>

                        <!-- What do you want to do with this? -->
                        <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Wat wil je doen?</label>
                        <select id="videoAudioGoalSelect" style="width: 100%; padding: 0.6rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.9rem; margin-bottom: 1rem;">
                            <option value="transcribe">üìù Transcriberen (tekst van audio/video)</option>
                            <option value="summarize">üìã Samenvatting maken</option>
                            <option value="extract-info">üîç Informatie extraheren</option>
                            <option value="meeting-notes">üìä Meeting notes / Actiepunten</option>
                            <option value="technical">üîß Technische analyse</option>
                        </select>

                        <!-- Analysis Type -->
                        <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Detail Niveau</label>
                        <div class="analysis-type-selector" style="margin-bottom: 1rem;">
                            <button class="analysis-type-btn" data-type="full" onclick="selectAnalysisType('full')">
                                üìä Volledig
                            </button>
                            <button class="analysis-type-btn active" data-type="technical-deepdive" onclick="selectAnalysisType('technical-deepdive')">
                                üîß Gedetailleerd
                            </button>
                            <button class="analysis-type-btn" data-type="summary" onclick="selectAnalysisType('summary')">
                                üìù Compact
                            </button>
                        </div>

                        <!-- Extra instructions -->
                        <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.85rem;">Extra Instructies (optioneel)</label>
                        <textarea id="videoAudioInstructionsInput" placeholder="Bijv: Focus op de beslissingen, negeer small talk..." style="width: 100%; padding: 0.6rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.9rem; height: 60px; resize: vertical; margin-bottom: 1rem;"></textarea>

                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; padding: 0.5rem; background: rgba(66, 133, 244, 0.1); border-radius: 6px;">
                            üëÅÔ∏è Audio/video wordt geanalyseerd met <strong>Gemini</strong> voor spraak-naar-tekst en inhoudsanalyse.
                        </p>

                        <!-- Action Button -->
                        <button class="btn btn-install" onclick="analyzeSelectedContent()" style="width: 100%;">
                            üöÄ Start Analyse
                        </button>
                    </div>
                </div>

                <!-- Analysis Progress -->
                <div id="analysisProgressSection" class="note-section" style="display: none;">
                    <h2 class="section-title">‚è≥ Analyse Bezig...</h2>
                    <div class="section-content">
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span id="analyzeProgressIcon" style="font-size: 1.5rem;">üîÑ</span>
                                <span id="analyzeProgressMessage" style="font-size: 0.9rem;">Voorbereiden...</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; background: var(--bg-dark); border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div id="analyzeProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--ai-purple), var(--ai-blue)); width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <span id="analyzeProgressPercent" style="font-size: 0.85rem; font-weight: 600; color: var(--ai-purple); min-width: 45px; text-align: right;">0%</span>
                            </div>
                            <p id="analyzeProgressDetail" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;"></p>
                        </div>
                        <button class="btn" onclick="cancelAnalysis()" style="width: 100%; background: var(--warning);">
                            ‚ùå Annuleren
                        </button>
                    </div>
                </div>

                <!-- LEGACY: Analysis Results - Now only used for YouTube/Video/Audio (documents use unified card system) -->
                <div class="note-section" id="analysisResultsSection" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="section-title">üìä Analyse Resultaat</h2>
                        <div style="display: flex; gap: 0.4rem;">
                            <button class="btn" onclick="copyLegacyAnalysisToClipboard()" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">üìã Kopieer</button>
                            <button class="btn" onclick="saveLegacyAnalysisToObsidian()" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">üíæ Obsidian</button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="analysisMetadata" style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg-dark); border-radius: 6px; font-size: 0.75rem; color: var(--text-muted);"></div>
                        <div id="analysisResults" class="analysis-content"></div>
                    </div>
                </div>

                <!-- Transcript Section -->
                <div class="note-section" id="transcriptSection" style="display: none;">
                    <h2 class="section-title">üìù Video Transcript</h2>
                    <div class="section-content">
                        <div id="transcriptContent" class="transcript-content"></div>
                    </div>
                </div>
            </div>

            <!-- Install Panel -->
            <div class="content-panel panel-hidden" id="panel-install">
                <div id="installContent"></div>

                <!-- FASE 3: App Building (voor documenten) -->
                <div id="docFase3Section" class="note-section" style="display: none;">
                    <h2 class="section-title">üöÄ FASE 3: App Building</h2>
                    <div class="section-content">
                        <!-- Selected Document Info -->
                        <div id="fase3DocInfo" style="padding: 0.75rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.25rem;" id="fase3DocTitle">Document</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted);" id="fase3AnalysesInfo">Analyses & Samenvatting status</p>
                        </div>

                        <!-- Build Options Panel -->
                        <div id="buildOptionsPanel" style="border: 1px solid var(--highlight); border-radius: 10px; padding: 1rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(251, 191, 36, 0.05));">
                            <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: var(--highlight);">
                                üèóÔ∏è Build Configuratie
                            </h3>

                            <!-- App Type Selection -->
                            <div style="margin-bottom: 1rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Type Applicatie</label>
                                <select id="buildAppType" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem;">
                                    <option value="web-app">üåê Web Applicatie (React/Vue/HTML)</option>
                                    <option value="electron">üíª Desktop App (Electron)</option>
                                    <option value="api">‚ö° API/Backend (Node.js/Python)</option>
                                    <option value="cli">üîß CLI Tool</option>
                                    <option value="dashboard">üìä Dashboard</option>
                                    <option value="automation">ü§ñ Automatisering Script</option>
                                </select>
                            </div>

                            <!-- Tech Stack -->
                            <div style="margin-bottom: 1rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Tech Stack (optioneel)</label>
                                <input type="text" id="buildTechStack" placeholder="bv. React, TypeScript, Tailwind, Node.js..." style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem;">
                            </div>

                            <!-- Extra Build Instructions -->
                            <div style="margin-bottom: 1rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Extra Build Instructies (optioneel)</label>
                                <textarea id="buildInstructions" placeholder="Specifieke features, styling preferences, integrations..." style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem; height: 80px; resize: vertical;"></textarea>
                            </div>

                            <!-- Build Button -->
                            <button id="buildAppBtn" class="btn btn-install" onclick="buildAppFromAnalysis()" style="width: 100%; font-size: 0.9rem; padding: 0.75rem; background: var(--highlight);">
                                üöÄ Start App Building
                            </button>
                            <div id="buildStatus" style="margin-top: 0.5rem;"></div>
                        </div>

                        <!-- Active Build Log -->
                        <div id="activeBuildLog" style="display: none; margin-top: 1rem; padding: 0.75rem; background: var(--bg-dark); border-radius: 8px; border-left: 4px solid var(--highlight);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                                <span id="activeBuildName" style="font-size: 0.9rem; font-weight: 600;">Building...</span>
                            </div>
                            <div id="activeBuildProgress" style="font-size: 0.8rem; color: var(--text-muted); max-height: 150px; overflow-y: auto;"></div>
                        </div>

                        <!-- Build Result -->
                        <div id="buildResult" style="display: none; margin-top: 1rem; border: 1px solid var(--success); border-radius: 10px; padding: 1rem; background: rgba(34, 197, 94, 0.1);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                <h3 style="margin: 0; font-size: 1rem; color: var(--success);">‚úÖ Build Voltooid</h3>
                            </div>
                            <p id="buildResultPath" style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;"></p>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn" onclick="openBuildFolder()" style="font-size: 0.75rem;">üìÇ Open Map</button>
                                <button class="btn" onclick="openBuildInTerminal()" style="font-size: 0.75rem;">üíª Open Terminal</button>
                            </div>
                        </div>

                        <!-- Requirement Note -->
                        <div id="fase3RequirementNote" style="margin-top: 1rem; padding: 0.75rem; background: rgba(251, 191, 36, 0.1); border: 1px solid var(--warning); border-radius: 8px;">
                            <p style="font-size: 0.8rem; color: var(--warning); margin: 0;">
                                ‚ö†Ô∏è Genereer eerst een samenvatting in de Overview tab voordat je een app kunt bouwen.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Panel -->
            <div class="content-panel panel-hidden" id="panel-code">
                <div id="codeContent"></div>
            </div>

            <!-- Settings Panel -->
            <div class="content-panel panel-hidden" id="panel-settings">
                <!-- Gemini API Settings -->
                <div class="note-section">
                    <h2 class="section-title">ü§ñ Gemini AI Configuratie</h2>
                    <div class="section-content">
                        <!-- API Key Status -->
                        <div id="geminiKeyStatus" style="padding: 0.75rem; background: var(--bg-dark); border-radius: 8px; font-size: 0.85rem; margin-bottom: 1rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span id="geminiStatusIcon" style="font-size: 1.2rem;">‚è≥</span>
                                <span id="geminiStatusText">Controleren...</span>
                            </div>
                        </div>

                        <!-- API Key Input -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.85rem;">
                                Gemini API Key
                            </label>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="password" id="geminiApiKeyInput" placeholder="AIzaSy..." style="flex: 1; padding: 0.6rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.9rem; font-family: monospace;">
                                <button class="btn" onclick="toggleApiKeyVisibility()" style="padding: 0.6rem;" title="Toon/verberg">üëÅÔ∏è</button>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-install" onclick="saveGeminiApiKey()" style="flex: 1;">
                                    üíæ API Key Opslaan
                                </button>
                                <button class="btn" onclick="testGeminiConnection()" style="flex: 1;">
                                    üß™ Test Verbinding
                                </button>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Nog geen API key? <a href="#" onclick="window.brain.openUrl('https://aistudio.google.com/apikey'); return false;" style="color: var(--ai-blue); text-decoration: underline;">Haal er een op bij Google AI Studio</a> (gratis)
                            </p>
                        </div>

                        <!-- Model Selection -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.85rem;">
                                Gemini Model
                            </label>
                            <select id="geminiModelSettings" onchange="saveGeminiModel()" style="width: 100%; padding: 0.6rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash (Snel, aanbevolen)</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash (Stabiel)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro (Krachtig)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Path Settings -->
                <div class="note-section">
                    <h2 class="section-title">üìÅ Paden</h2>
                    <div class="section-content">
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.8rem;">Obsidian Vault</label>
                            <input type="text" id="obsidianPath" value="/Users/franky13m3/Documents/OBSIDIAN MD TOP" style="width: 100%; padding: 0.4rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 0.8rem;">
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.8rem;">Documents Folder</label>
                            <input type="text" id="documentsPath" value="/Users/franky13m3/Documents" style="width: 100%; padding: 0.4rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 0.8rem;">
                        </div>
                        <button class="btn btn-install" onclick="selectObsidianVault()">üìÅ Selecteer Vault</button>
                    </div>
                </div>

                <!-- Backup System -->
                <div class="note-section">
                    <h2 class="section-title">üíæ Backup Systeem</h2>
                    <div class="section-content">
                        <!-- App Version -->
                        <div id="appVersionInfo" style="padding: 0.5rem; background: linear-gradient(135deg, var(--accent), rgba(139, 92, 246, 0.3)); border-radius: 6px; margin-bottom: 1rem; font-size: 0.8rem;">
                            <strong>Brain App v1.2.0</strong> - 6 januari 2026
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                                Claude Code CLI Integration ‚Ä¢ Document AI ‚Ä¢ Persona
                            </div>
                        </div>

                        <!-- Create Backup -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.8rem;">Nieuwe Backup</label>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" id="backupNameInput" placeholder="Backup naam (optioneel)" style="flex: 1; padding: 0.4rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 0.8rem;">
                            </div>
                            <input type="text" id="backupDescInput" placeholder="Beschrijving (optioneel)" style="width: 100%; padding: 0.4rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 0.8rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-install" onclick="createBackup()" style="flex: 1;">üíæ Maak Backup</button>
                                <button class="btn" onclick="exportToObsidian()" style="background: var(--ai-purple);">üìö Export naar Obsidian</button>
                            </div>
                        </div>

                        <!-- Backup List -->
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.8rem;">Beschikbare Backups</label>
                            <div id="backupList" style="max-height: 200px; overflow-y: auto;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">Laden...</div>
                            </div>
                        </div>

                        <button class="btn" onclick="loadBackupList()" style="width: 100%; background: var(--accent);">üîÑ Ververs Lijst</button>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="note-section">
                    <h2 class="section-title">üßπ Data Beheer</h2>
                    <div class="section-content">
                        <div id="dataStats" style="padding: 0.75rem; background: var(--bg-dark); border-radius: 8px; margin-bottom: 1rem; font-size: 0.8rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <div>üì¶ Content items: <strong id="statContentCount">0</strong></div>
                                <div>üìÅ Mappen: <strong id="statFolderCount">0</strong></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <button class="btn" onclick="showContentManager()" style="width: 100%; margin-bottom: 0.5rem;">
                                üìã Content Manager
                            </button>
                            <button class="btn" onclick="removeDuplicates()" style="width: 100%; margin-bottom: 0.5rem;">
                                üîÑ Verwijder Duplicaten
                            </button>
                            <button class="btn" onclick="clearAllContent()" style="width: 100%; background: #ef4444;">
                                üóëÔ∏è Wis ALLE Content
                            </button>
                        </div>

                        <p style="font-size: 0.7rem; color: var(--text-muted);">
                            ‚ö†Ô∏è "Wis ALLE Content" verwijdert al je opgeslagen items permanent. Maak eerst een backup!
                        </p>
                    </div>
                </div>

                <!-- About -->
                <div class="note-section">
                    <h2 class="section-title">‚ÑπÔ∏è Over Brain App</h2>
                    <div class="section-content">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                            Personal Knowledge Operating System voor video analyse, Claude Code configuratie, en kennisbeheer.
                        </p>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">
                            <div>Versie: 1.5.2</div>
                            <div>Build: 6 januari 2026</div>
                            <div>Electron + Gemini AI + Claude CLI</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel: Terminal + DevTools -->
        <aside class="right-panel" id="rightPanel">
            <div class="panel-header" onclick="toggleRightPanel()">
                <span>üõ†Ô∏è</span>
                <span>Tools</span>
                <span class="panel-toggle">‚óÄ</span>
            </div>
            <div class="panel-content">
                <!-- Terminal -->
                <div class="terminal-container">
                    <div class="terminal-header" onclick="toggleTerminal()">
                        <span>‚å®Ô∏è Terminal</span>
                        <span class="chevron">‚ñº</span>
                    </div>
                    <div class="terminal-output" id="terminalOutput">
                        <div class="terminal-line info">Brain App Terminal v1.0</div>
                        <div class="terminal-line">Type 'help' for commands</div>
                    </div>
                    <div class="terminal-input-line">
                        <span class="terminal-prompt">‚ùØ</span>
                        <input type="text" class="terminal-input" id="terminalInput" placeholder="Enter command..." onkeydown="handleTerminalInput(event)">
                    </div>
                </div>

                <!-- DevTools -->
                <div class="devtools-container">
                    <div class="devtools-header" onclick="toggleDevTools()">
                        <span>üîß DevTools</span>
                        <span class="chevron">‚ñº</span>
                    </div>
                    <div class="devtools-output" id="devtoolsOutput">
                        <div style="color: var(--text-muted);">[Console output appears here]</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // ============================================
        // DATA
        // ============================================
        const mijnBreinData = {
            documentsPath: '/Users/franky13m3/Documents',
            obsidianPath: '/Users/franky13m3/Documents/OBSIDIAN MD TOP',
            claudePath: '/Users/franky13m3/.claude',
            folders: [
                { id: 'claude-code', name: 'Claude Code Mac Sync', icon: 'ü§ñ', category: 'AI & Dev', status: 'active', path: 'Claude Code Mac Sync', description: 'Claude Code config & sync' },
                { id: 'claude-sdk', name: 'Claude Code SDK', icon: 'üîß', category: 'AI & Dev', status: 'active', path: 'Claude Code SDK', description: 'Agent SDK development' },
                { id: 'brain-app', name: '_Brain-App', icon: 'üß†', category: 'AI & Dev', status: 'active', path: 'Claude Code developement File/_Brain-App', description: 'Deze app!' },
                { id: 'blackfuel', name: 'BlackFuel Whiskey', icon: 'ü•É', category: 'Business', status: 'active', path: 'BlackFuel Whiskey TOP', description: 'Whiskey project' },
                { id: 'solarnation', name: 'Solarnation', icon: '‚òÄÔ∏è', category: 'Business', status: 'active', path: 'Solarnation recent', description: 'Solar energy' },
                { id: 'econation', name: 'Econation', icon: 'üå±', category: 'Business', status: 'setup', path: 'Econation top from Mocha', description: 'Eco-business' },
                { id: 'facenews', name: 'FaceNewsMedia', icon: 'üì∞', category: 'Business', status: 'setup', path: 'FaceNewsMedia  TOP New', description: 'Media platform' },
                { id: 'channel-zero', name: 'Channel Zero', icon: 'üé∏', category: 'Music', status: 'active', path: 'channel_zero_logo', description: 'Band assets' },
                { id: 'music-april', name: 'Music 2025', icon: 'üéµ', category: 'Music', status: 'active', path: 'Music APRIL 2025 alles TOP', description: 'Production files' },
                { id: 'native-instruments', name: 'Native Instruments', icon: 'üéπ', category: 'Music', status: 'active', path: 'Native Instruments', description: 'Plugins & presets' },
                { id: 'obsidian', name: 'Obsidian Vault', icon: 'üìö', category: 'Knowledge', status: 'active', path: 'OBSIDIAN MD TOP', description: 'Knowledge base' },
                { id: 'github', name: 'GitHub Projects', icon: 'üêô', category: 'Knowledge', status: 'active', path: 'GitHub', description: 'Local repos' },
            ],
            claudeConfig: [
                { name: 'commands/', icon: '‚ö°', count: 8, status: 'active' },
                { name: 'skills/', icon: 'üéØ', count: 4, status: 'active' },
                { name: 'agents/', icon: 'ü§ñ', count: 3, status: 'active' },
                { name: 'CLAUDE.md', icon: 'üìÑ', count: 1, status: 'active' },
            ]
        };

        // ============================================
        // ANTHROPIC / CLAUDE CODE DATA
        // ============================================
        const anthropicData = {
            commands: [
                { id: 'cmd-health-check', name: '/health-check', icon: 'üè•', description: 'Context gezondheid analyse', status: 'installed', file: 'health-check.md',
                  summary: 'Voer grondige gezondheidscheck uit van sessie en project. Detecteert context overload, grote bestanden, en herhalingen.' },
                { id: 'cmd-analyze-video', name: '/analyze-video', icon: 'üé¨', description: 'Video analyse met Gemini', status: 'installed', file: 'analyze-video.md',
                  summary: 'Analyseer YouTube video met Gemini, sla op in Obsidian met relevantie check.' },
                { id: 'cmd-start', name: '/start', icon: 'üöÄ', description: 'Sessie context laden', status: 'installed', file: 'start.md',
                  summary: 'Laad project context en start nieuwe sessie.' },
                { id: 'cmd-workstatus', name: '/workstatus', icon: 'üìä', description: 'Project status overzicht', status: 'installed', file: 'workstatus.md',
                  summary: 'Toon overzicht van huidige project status.' },
                { id: 'cmd-smart-tools', name: '/smart-tools', icon: 'üß∞', description: 'Smart tooling configuratie', status: 'installed', file: 'smart-tools.md',
                  summary: 'Configureer en beheer smart tools.' },
                { id: 'cmd-ide-setup', name: '/ide-setup', icon: 'üíª', description: 'IDE configuratie', status: 'installed', file: 'ide-setup.md',
                  summary: 'Setup en configureer IDE integratie.' },
                { id: 'cmd-franky', name: '/franky', icon: 'üë§', description: 'Franky persona activeren', status: 'installed', file: 'franky.md',
                  summary: 'Activeer de Franky developer persona.' },
                { id: 'cmd-wiggins', name: '/wiggins-loop', icon: 'üîÑ', description: 'Wiggins loop pattern', status: 'installed', file: 'wiggins-loop.md',
                  summary: 'Iteratieve development loop pattern.' }
            ],
            skills: [
                { id: 'skill-fullstack', name: 'Full-Stack Web', icon: 'üåê', description: 'Complete web apps bouwen', status: 'installed', file: 'full-stack-web.md',
                  summary: 'Bouw complete web applicaties met Next.js, React, TypeScript, Prisma, en email integratie.' },
                { id: 'skill-database', name: 'Database Architect', icon: 'üóÑÔ∏è', description: 'Database ontwerp & queries', status: 'installed', file: 'database-architect.md',
                  summary: 'Ontwerp database schema\'s, schrijf queries, optimaliseer performance.' },
                { id: 'skill-email', name: 'Email Automation', icon: 'üìß', description: 'Email workflows & templates', status: 'installed', file: 'email-automation.md',
                  summary: 'Transactional emails, templates, en automation workflows.' },
                { id: 'skill-project', name: 'Project Detector', icon: 'üîç', description: 'Project type detectie', status: 'installed', file: 'project-detector.md',
                  summary: 'Detecteer project type en laad juiste configuratie.' }
            ],
            agents: [
                { id: 'agent-franky', name: 'Franky Super Dev', icon: 'ü¶∏', description: 'Hoofd developer persona', status: 'installed', file: 'franky-super-dev.md',
                  summary: 'Senior full-stack developer die andere agents co√∂rdineert. Expertise in Next.js, databases, automation.' },
                { id: 'agent-database', name: 'Database Specialist', icon: 'üóÉÔ∏è', description: 'Database expert', status: 'installed', file: 'database-specialist.md',
                  summary: 'Specialist voor complexe schema\'s, queries, en database optimalisatie.' },
                { id: 'agent-frontend', name: 'Frontend Expert', icon: 'üé®', description: 'UI/UX specialist', status: 'installed', file: 'frontend-expert.md',
                  summary: 'Expert in React components, styling, en user experience.' },
                { id: 'agent-automation', name: 'Automation Engineer', icon: '‚öôÔ∏è', description: 'Workflow automation', status: 'installed', file: 'automation-engineer.md',
                  summary: 'Bouw automation workflows, integrations, en background jobs.' }
            ],
            // Online resources voor nieuwe commands/skills/agents
            marketplace: [
                { id: 'mp-git-workflow', name: '/git-workflow', icon: 'üîÄ', type: 'command', description: 'Git branch & PR workflow', status: 'available',
                  source: 'community', summary: 'Automatiseer git branch creatie, commits, en pull requests.' },
                { id: 'mp-code-review', name: '/code-review', icon: 'üëÄ', type: 'command', description: 'AI-powered code review', status: 'available',
                  source: 'community', summary: 'Laat Claude je code reviewen en suggesties geven.' },
                { id: 'mp-test-generator', name: '/test-generator', icon: 'üß™', type: 'command', description: 'Test generatie', status: 'available',
                  source: 'community', summary: 'Genereer unit tests voor je functies.' },
                { id: 'mp-api-builder', name: 'API Builder', icon: 'üîå', type: 'skill', description: 'REST/GraphQL API ontwerp', status: 'available',
                  source: 'anthropic', summary: 'Ontwerp en bouw APIs met best practices.' },
                { id: 'mp-security', name: 'Security Auditor', icon: 'üîí', type: 'agent', description: 'Security analyse', status: 'available',
                  source: 'anthropic', summary: 'Analyseer code op security vulnerabilities.' },
                { id: 'mp-docs-writer', name: 'Docs Writer', icon: 'üìù', type: 'agent', description: 'Documentatie generatie', status: 'available',
                  source: 'community', summary: 'Genereer README, API docs, en comments.' }
            ]
        };

        const videoData = {
            'video-1': {
                id: 'video-1',
                title: 'Alex Finn - Claude Life Setup',
                date: '4 jan 2026',
                category: 'AI Development',
                badges: ['Slash Commands', 'Subagents', 'Workflow'],
                summary: '"Claude Life" is een AI-gestuurd operating system met custom slash commands en subagents.',
                items: [
                    { id: 'cmd-newsletter-research', type: 'command', name: '/newsletter-research', description: 'Trending topics analyseren', code: '# Newsletter Research\n1. Search trending topics\n2. Analyze relevance\n3. Create notes' },
                    { id: 'cmd-brain-dump', type: 'command', name: '/brain-dump-analysis', description: 'Voice notes analyseren', code: '# Brain Dump Analysis\n1. Read brain dump\n2. Extract insights\n3. Categorize' },
                    { id: 'cmd-daily-brief', type: 'command', name: '/daily-brief', description: 'Dagelijkse briefing', code: '# Daily Brief\n- Calendar events\n- Top priorities\n- Pending tasks' },
                    { id: 'agent-content-researcher', type: 'subagent', name: 'Content Researcher', description: 'Diepgaand onderzoek', code: '# Content Researcher\n- Web research\n- Source verification\n- Summary generation' },
                    { id: 'agent-newsletter-writer', type: 'subagent', name: 'Newsletter Writer', description: 'Newsletter drafts', code: '# Newsletter Writer\n1. Read research\n2. Write content\n3. Format' }
                ],
                folderStructure: 'CLAUDELIFE/\n‚îú‚îÄ‚îÄ commands/\n‚îú‚îÄ‚îÄ subagents/\n‚îú‚îÄ‚îÄ braindumps/\n‚îî‚îÄ‚îÄ newsletter/',
                bestPractices: ['Subagents voor complexe taken', 'Commands per workflow', 'Markdown up-to-date']
            },
            'video-2': {
                id: 'video-2',
                title: 'Top 10 Claude Code Power Tips',
                date: '4 jan 2026',
                category: 'AI Development',
                badges: ['CLI Skills', 'claude.md', 'Prompting'],
                summary: '10 power tips voor Claude Code CLI uit Anthropic\'s prompting guide.',
                items: [
                    { id: 'rule-tool-summaries', type: 'claudemd', name: 'Tool Summaries', description: 'Summaries voor grote outputs', code: '# Tool Summaries\nAlways summarize tool outputs before presenting full results.' },
                    { id: 'rule-less-eager', type: 'claudemd', name: 'Less Eager', description: 'Minder proactief', code: '# Less Eager\nWait for explicit instructions before making changes.' },
                    { id: 'rule-more-eager', type: 'claudemd', name: 'More Eager', description: 'Meer proactief', code: '# More Eager\nBe proactive and autonomous. Take initiative.' },
                    { id: 'rule-parallel-tools', type: 'claudemd', name: 'Parallel Tools', description: 'Parallelle calls', code: '# Parallel Tool Calls\nUse parallel tool calls for efficiency.' },
                    { id: 'rule-investigation', type: 'claudemd', name: 'Investigation', description: 'Eerst onderzoeken', code: '# Investigation First\nRead files completely before making changes.' },
                    { id: 'rule-session-init', type: 'claudemd', name: 'Session Init', description: 'Context laden', code: '# Session Init\nRead README.md and key files at start.' }
                ],
                tipsTable: [
                    ['1', 'Explain Motivations', 'Prompt'],
                    ['2', 'Don\'t Worry Context', 'Practice'],
                    ['3', 'Load Context', 'Template'],
                    ['4', 'Use GIT', 'Practice'],
                    ['5', 'Tool Summaries', 'Rule'],
                    ['6', 'Adjust Eagerness', 'Rule'],
                    ['7', 'Careful with Think', 'Token'],
                    ['8', 'Use Vision', 'Feature'],
                    ['9', 'Parallel Tools', 'Rule'],
                    ['10', 'Reduce Hallucinations', 'Rule']
                ],
                bestPractices: ['Motivatie uitleggen', 'Vertrouw auto-compaction', 'Start met architecture review', 'Commit vaak']
            }
        };

        // State
        let currentView = 'videos';
        let currentVideoId = null;
        let selectedVideoId = null; // For analyze panel
        let selectedContentItem = null; // For 3-fase document analysis workflow
        let currentFolderId = null;
        let installedItems = new Set();
        let collapsedCategories = new Set();
        let collapsedFolders = new Set();
        let terminalHistory = [];

        // Folder structure: { id, name, parentId, children: [], items: [] }
        let folderData = {};
        // Folders worden geladen in DOMContentLoaded

        // App logging
        let appLogs = JSON.parse(localStorage.getItem('brain-app-logs') || '[]');
        function logApp(message, level = 'info') {
            const entry = { timestamp: new Date().toISOString(), level, message };
            appLogs.push(entry);
            if (appLogs.length > 500) appLogs = appLogs.slice(-500); // Keep last 500
            localStorage.setItem('brain-app-logs', JSON.stringify(appLogs));
            console.log(`[${level.toUpperCase()}] ${message}`);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Load folders from electron-store (via IPC - more reliable than localStorage)
            try {
                const foldersResult = await window.brain.getFolders();
                if (foldersResult.success) {
                    folderData = foldersResult.folders;
                    console.log('Loaded folders from electron-store:', Object.keys(folderData).length, folderData);
                } else {
                    console.error('Failed to load folders:', foldersResult.error);
                    // Fallback to localStorage
                    const storedFolders = localStorage.getItem('brain-folders');
                    folderData = JSON.parse(storedFolders || '{}');
                    console.log('Fallback to localStorage folders:', Object.keys(folderData).length);
                }
            } catch (error) {
                console.error('Error loading folders:', error);
                const storedFolders = localStorage.getItem('brain-folders');
                folderData = JSON.parse(storedFolders || '{}');
            }

            const saved = localStorage.getItem('brain-installed-items');
            if (saved) installedItems = new Set(JSON.parse(saved));

            // Load saved custom content from electron-store (via IPC)
            try {
                const contentResult = await window.brain.getCustomContent();
                if (contentResult.success && contentResult.content.length > 0) {
                    contentResult.content.forEach(item => {
                        videoData[item.id] = item;
                    });
                    console.log('Loaded custom content from electron-store:', contentResult.content.length, 'items');
                } else {
                    // Fallback to localStorage
                    const savedContent = JSON.parse(localStorage.getItem('brain-custom-videos') || '[]');
                    savedContent.forEach(item => {
                        videoData[item.id] = item;
                    });
                    console.log('Fallback to localStorage content:', savedContent.length, 'items');
                }
            } catch (error) {
                console.error('Error loading custom content:', error);
                const savedContent = JSON.parse(localStorage.getItem('brain-custom-videos') || '[]');
                savedContent.forEach(item => {
                    videoData[item.id] = item;
                });
            }

            renderBreinList();
            renderAnthropicList();
            renderVideoList();
            setupTabs();
            renderWelcomeOverview();

            // Check Claude CLI status on startup
            checkClaudeCLIStatus();

            // Start system stats monitoring
            startSystemStatsMonitoring();

            logToDevTools('Brain App loaded', 'info');
            logToDevTools('Brain App initialized', 'info');
        });

        // ============================================
        // SIDEBAR VIEW
        // ============================================
        function switchSidebarView(view) {
            currentView = view;
            document.querySelectorAll('.sidebar-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            document.getElementById('breinList').style.display = view === 'brein' ? 'block' : 'none';
            document.getElementById('anthropicList').style.display = view === 'anthropic' ? 'block' : 'none';
            document.getElementById('videoList').style.display = view === 'videos' ? 'block' : 'none';

            if (view === 'brein') renderWelcomeOverview();
            if (view === 'anthropic') renderAnthropicOverview();
        }

        // ============================================
        // ANTHROPIC / CLAUDE CODE LIST
        // ============================================
        function renderAnthropicList() {
            const container = document.getElementById('anthropicList');
            const categories = {
                'Commands': { icon: '‚ö°', items: anthropicData.commands },
                'Skills': { icon: 'üéØ', items: anthropicData.skills },
                'Agents': { icon: 'ü§ñ', items: anthropicData.agents },
                'Marketplace': { icon: 'üõí', items: anthropicData.marketplace }
            };

            let html = '';
            Object.entries(categories).forEach(([cat, data]) => {
                const isCollapsed = collapsedCategories.has(`anthropic-${cat}`);
                const installedCount = data.items.filter(i => i.status === 'installed').length;

                html += `
                    <div class="category-section">
                        <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('anthropic-${cat}')">
                            <span>${data.icon}</span>
                            <span>${cat}</span>
                            <span class="badge" style="font-size: 0.6rem;">${installedCount}/${data.items.length}</span>
                            <span class="chevron">‚ñº</span>
                        </div>
                        <div class="category-items ${isCollapsed ? 'collapsed' : ''}" style="max-height: ${data.items.length * 50}px;">
                            ${data.items.map(item => `
                                <div class="list-item ${item.status === 'installed' ? 'installed' : ''}" onclick="selectAnthropicItem('${item.id}', '${cat.toLowerCase()}')">
                                    <span>${item.icon}</span>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
                                        <div style="font-size: 0.65rem; color: var(--text-muted);">${item.description}</div>
                                    </div>
                                    <span style="font-size: 0.6rem; color: ${item.status === 'installed' ? 'var(--install-green)' : 'var(--text-muted)'};">
                                        ${item.status === 'installed' ? '‚úì' : '‚óã'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function selectAnthropicItem(itemId, category) {
            currentAnthropicItem = itemId;

            // Find item in anthropicData
            let item = null;
            if (category === 'commands') item = anthropicData.commands.find(i => i.id === itemId);
            else if (category === 'skills') item = anthropicData.skills.find(i => i.id === itemId);
            else if (category === 'agents') item = anthropicData.agents.find(i => i.id === itemId);
            else if (category === 'marketplace') item = anthropicData.marketplace.find(i => i.id === itemId);

            if (item) {
                renderAnthropicItemDetail(item, category);
            }

            // Highlight selected
            document.querySelectorAll('#anthropicList .list-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function renderAnthropicOverview() {
            const container = document.getElementById('overviewContent');
            const commandCount = anthropicData.commands.length;
            const skillCount = anthropicData.skills.length;
            const agentCount = anthropicData.agents.length;
            const marketplaceCount = anthropicData.marketplace.length;

            container.innerHTML = `
                <div class="note-section">
                    <h2 class="section-title">ü§ñ Claude Code Configuratie</h2>
                    <div class="section-content">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                            Beheer je Claude Code CLI configuratie: commands, skills, agents en ontdek nieuwe tools.
                        </p>

                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                            <div class="stat-card" style="background: var(--accent); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--ai-purple);">${commandCount}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Commands</div>
                            </div>
                            <div class="stat-card" style="background: var(--accent); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--ai-blue);">${skillCount}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Skills</div>
                            </div>
                            <div class="stat-card" style="background: var(--accent); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--install-green);">${agentCount}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Agents</div>
                            </div>
                            <div class="stat-card" style="background: var(--accent); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${marketplaceCount}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Marketplace</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">‚ö° Ge√Ønstalleerde Commands</h2>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            ${anthropicData.commands.map(cmd => `
                                <div class="install-item installed" style="cursor: pointer;" onclick="selectAnthropicItem('${cmd.id}', 'commands')">
                                    <span class="install-icon">${cmd.icon}</span>
                                    <div class="install-info">
                                        <div class="install-name">${cmd.name}</div>
                                        <div class="install-desc">${cmd.description}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">üéØ Actieve Skills</h2>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            ${anthropicData.skills.map(skill => `
                                <div class="install-item installed" style="cursor: pointer;" onclick="selectAnthropicItem('${skill.id}', 'skills')">
                                    <span class="install-icon">${skill.icon}</span>
                                    <div class="install-info">
                                        <div class="install-name">${skill.name}</div>
                                        <div class="install-desc">${skill.description}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">ü§ñ Beschikbare Agents</h2>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            ${anthropicData.agents.map(agent => `
                                <div class="install-item installed" style="cursor: pointer;" onclick="selectAnthropicItem('${agent.id}', 'agents')">
                                    <span class="install-icon">${agent.icon}</span>
                                    <div class="install-info">
                                        <div class="install-name">${agent.name}</div>
                                        <div class="install-desc">${agent.description}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">üõí Marketplace - Nieuwe Tools</h2>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            ${anthropicData.marketplace.map(item => `
                                <div class="install-item" style="cursor: pointer; border-color: var(--warning);" onclick="selectAnthropicItem('${item.id}', 'marketplace')">
                                    <span class="install-icon">${item.icon}</span>
                                    <div class="install-info">
                                        <div class="install-name">${item.name}</div>
                                        <div class="install-desc">${item.description}</div>
                                    </div>
                                    <span style="font-size: 0.6rem; color: var(--warning);">${item.source}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">üìÇ Claude Config Pad</h2>
                    <div class="section-content">
                        <div class="code-block"><pre>~/.claude/</pre></div>
                        <button class="btn btn-install" style="margin-top: 0.75rem;" onclick="openInFinder('/Users/franky13m3/.claude')">üìÇ Open in Finder</button>
                    </div>
                </div>
            `;
        }

        function renderAnthropicItemDetail(item, category) {
            const container = document.getElementById('overviewContent');
            const typeLabel = category === 'commands' ? 'Command' : category === 'skills' ? 'Skill' : category === 'agents' ? 'Agent' : 'Marketplace';
            const filePath = item.file ? `~/.claude/${category}/${item.file}` : '';

            container.innerHTML = `
                <div class="note-section">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <span style="font-size: 2.5rem;">${item.icon}</span>
                        <div>
                            <h2 class="section-title" style="margin: 0;">${item.name}</h2>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                                <span class="badge">${typeLabel}</span>
                                <span class="badge" style="background: ${item.status === 'installed' ? 'var(--install-green)' : 'var(--warning)'}; color: #000;">
                                    ${item.status === 'installed' ? '‚úì Ge√Ønstalleerd' : '‚óã Beschikbaar'}
                                </span>
                                ${item.source ? `<span class="badge" style="background: var(--ai-purple);">${item.source}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">üìù Beschrijving</h2>
                    <div class="section-content">
                        <p>${item.summary || item.description}</p>
                    </div>
                </div>

                ${filePath ? `
                <div class="note-section">
                    <h2 class="section-title">üìÇ Bestand</h2>
                    <div class="section-content">
                        <div class="code-block"><pre>${filePath}</pre></div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <button class="btn btn-install" onclick="openAnthropicFile('${category}', '${item.file}')">üìÑ Open Bestand</button>
                            <button class="btn" onclick="editAnthropicFile('${category}', '${item.file}')" style="background: var(--accent);">‚úèÔ∏è Bewerken</button>
                        </div>
                    </div>
                </div>
                ` : ''}

                ${item.status === 'available' ? `
                <div class="note-section">
                    <h2 class="section-title">üöÄ Installeren</h2>
                    <div class="section-content">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                            Klik om deze ${typeLabel.toLowerCase()} te installeren in je Claude Code configuratie.
                        </p>
                        <button class="btn btn-install" style="width: 100%;" onclick="installMarketplaceItem('${item.id}')">
                            ‚¨áÔ∏è Installeer ${item.name}
                        </button>
                    </div>
                </div>
                ` : ''}

                <div class="note-section">
                    <h2 class="section-title">üí° Gebruik</h2>
                    <div class="section-content">
                        ${category === 'commands' ? `
                            <p>Gebruik dit command in Claude Code CLI:</p>
                            <div class="code-block"><pre>${item.name}</pre></div>
                        ` : category === 'skills' ? `
                            <p>Activeer deze skill met:</p>
                            <div class="code-block"><pre>/skill:${item.file?.replace('.md', '') || item.name.toLowerCase().replace(/\s+/g, '-')}</pre></div>
                        ` : category === 'agents' ? `
                            <p>Roep deze agent aan met:</p>
                            <div class="code-block"><pre>@${item.file?.replace('.md', '') || item.name.toLowerCase().replace(/\s+/g, '-')}</pre></div>
                        ` : `
                            <p>Na installatie beschikbaar als ${item.type}.</p>
                        `}
                    </div>
                </div>
            `;
        }

        async function openAnthropicFile(category, filename) {
            const path = `/Users/franky13m3/.claude/${category}/${filename}`;
            if (window.brain?.openExternal) {
                window.brain.openExternal(path);
            }
            showToast(`Opening: ${filename}`);
        }

        async function editAnthropicFile(category, filename) {
            // For now, just open in Finder/default editor
            openAnthropicFile(category, filename);
        }

        function installMarketplaceItem(itemId) {
            const item = anthropicData.marketplace.find(i => i.id === itemId);
            if (!item) return;

            // TODO: Actually install the item by creating the file
            showToast(`Installeren: ${item.name} (coming soon)`);
            logToDevTools(`Installing marketplace item: ${item.name}`, 'info');
        }

        let currentAnthropicItem = null;

        // ============================================
        // BREIN LIST WITH COLLAPSIBLE CATEGORIES
        // ============================================
        function renderBreinList() {
            const container = document.getElementById('breinList');
            const categories = {};
            const categoryIcons = { 'AI & Dev': 'ü§ñ', 'Business': 'üíº', 'Music': 'üéµ', 'Knowledge': 'üìö' };

            mijnBreinData.folders.forEach(f => {
                if (!categories[f.category]) categories[f.category] = [];
                categories[f.category].push(f);
            });

            let html = '';
            Object.entries(categories).forEach(([cat, folders]) => {
                const isCollapsed = collapsedCategories.has(cat);
                html += `
                    <div class="category-section">
                        <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${cat}')">
                            <span>${categoryIcons[cat] || 'üìÅ'}</span>
                            <span>${cat}</span>
                            <span class="badge" style="font-size: 0.6rem;">${folders.length}</span>
                            <span class="chevron">‚ñº</span>
                        </div>
                        <div class="category-items ${isCollapsed ? 'collapsed' : ''}" style="max-height: ${folders.length * 50}px;">
                            ${folders.map(f => `
                                <div class="list-item ${f.id === currentFolderId ? 'active' : ''}" data-folder="${f.id}" onclick="selectFolder('${f.id}')">
                                    <span class="list-item-icon">${f.icon}</span>
                                    <div class="list-item-info">
                                        <div class="list-item-title">${f.name}</div>
                                        <div class="list-item-meta">${f.description}</div>
                                    </div>
                                    <span class="folder-status ${f.status === 'active' ? 'status-active' : 'status-setup'}">${f.status === 'active' ? '‚úì' : '‚óã'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleCategory(cat) {
            if (collapsedCategories.has(cat)) {
                collapsedCategories.delete(cat);
            } else {
                collapsedCategories.add(cat);
            }
            renderBreinList();
            logToDevTools(`Category ${cat} toggled`, 'info');
        }

        // ============================================
        // INPUT CONTENT LIST
        // ============================================
        function renderVideoList() {
            const container = document.getElementById('videoList');

            // Add input buttons at the top
            let html = `
                <div class="input-actions" style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-small btn-add" onclick="openInputModal('youtube')" style="flex: 1; min-width: 80px; padding: 0.5rem; font-size: 0.8rem; background: linear-gradient(135deg, #ff0000, #cc0000);">
                        ‚ñ∂Ô∏è YouTube
                    </button>
                    <button class="btn btn-small btn-add" onclick="openInputModal('audio')" style="flex: 1; min-width: 80px; padding: 0.5rem; font-size: 0.8rem; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        üéôÔ∏è Audio
                    </button>
                    <button class="btn btn-small btn-add" onclick="openInputModal('video')" style="flex: 1; min-width: 80px; padding: 0.5rem; font-size: 0.8rem; background: linear-gradient(135deg, #3498db, #2980b9);">
                        üé• Video
                    </button>
                    <button class="btn btn-small btn-add" onclick="openInputModal('document')" style="flex: 1; min-width: 80px; padding: 0.5rem; font-size: 0.8rem; background: linear-gradient(135deg, #27ae60, #229954);">
                        üìÑ Document
                    </button>
                </div>
                <div class="folder-actions" style="padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 0.5rem;">
                    <button class="btn btn-small" onclick="createNewFolder()" style="flex: 1; font-size: 0.75rem; padding: 0.4rem;">
                        üìÅ+ Nieuwe Map
                    </button>
                </div>
            `;

            // List existing content grouped by folders
            const videos = Object.values(videoData);
            const folders = Object.values(folderData);

            if (videos.length === 0 && folders.length === 0) {
                html += `
                    <div class="category-header"><span>üìö</span><span>Mijn Content</span></div>
                    <div style="padding: 1rem; color: var(--text-muted); text-align: center; font-size: 0.85rem;">
                        Nog geen content toegevoegd.<br>
                        Gebruik de knoppen hierboven om te beginnen.
                    </div>
                `;
            } else {
                // Helper function to render a content item
                const renderContentItem = (video, indent = 0) => {
                    const rating = parseInt(localStorage.getItem(`brain-rating-${video.id}`)) || 0;
                    const stars = rating > 0 ? '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating) : '';
                    const icon = video.type === 'audio' ? 'üéôÔ∏è' : video.type === 'document' ? 'üìÑ' : video.type === 'youtube' ? '‚ñ∂Ô∏è' : 'üé¨';
                    return `
                        <div class="list-item ${video.id === currentVideoId ? 'active' : ''}" data-video="${video.id}" onclick="selectVideo('${video.id}')" style="padding-left: ${0.75 + indent * 0.75}rem;">
                            <span class="list-item-icon">${icon}</span>
                            <div class="list-item-info">
                                <div class="list-item-title">${video.title}</div>
                                <div class="list-item-meta">${video.date} ‚Ä¢ ${video.items?.length || 0} items ${stars ? `<span style="color: var(--warning);">${stars}</span>` : ''}</div>
                            </div>
                            <button class="move-btn" onclick="showMoveToFolderMenu('${video.id}', event)" title="Verplaatsen">üìÅ</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteContent('${video.id}')" title="Verwijderen">√ó</button>
                        </div>
                    `;
                };

                // Helper function to render a folder and its contents
                const renderFolder = (folder, indent = 0) => {
                    const isCollapsed = collapsedFolders.has(folder.id);
                    const itemsInFolder = videos.filter(v => v.folderId === folder.id);
                    const subFolders = folders.filter(f => f.parentId === folder.id);
                    const totalItems = itemsInFolder.length + subFolders.length;

                    let folderHtml = `
                        <div class="folder-header" onclick="toggleFolder('${folder.id}')" style="padding-left: ${0.75 + indent * 0.75}rem;">
                            <span>${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
                            <span>üìÅ</span>
                            <span>${folder.name}</span>
                            <span style="font-size: 0.7rem; color: var(--text-muted);">(${totalItems})</span>
                            <div class="folder-actions-btns">
                                <button class="folder-action-btn" onclick="event.stopPropagation(); renameFolder('${folder.id}')" title="Hernoemen">‚úèÔ∏è</button>
                                <button class="folder-action-btn" onclick="event.stopPropagation(); createNewFolder('${folder.id}')" title="Submap maken">‚ûï</button>
                                <button class="folder-action-btn" onclick="event.stopPropagation(); showMoveFolderMenu('${folder.id}', event)" title="Verplaatsen">üìÇ</button>
                                <button class="folder-action-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')" title="Verwijderen">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;

                    if (!isCollapsed) {
                        folderHtml += '<div class="folder-items">';
                        // Render subfolders first
                        subFolders.forEach(sub => {
                            folderHtml += renderFolder(sub, indent + 1);
                        });
                        // Then render items
                        itemsInFolder.forEach(video => {
                            folderHtml += renderContentItem(video, indent + 1);
                        });
                        folderHtml += '</div>';
                    }

                    return folderHtml;
                };

                // Render root folders (no parent)
                const rootFolders = folders.filter(f => !f.parentId);
                rootFolders.forEach(folder => {
                    html += renderFolder(folder, 0);
                });

                // Render items without a folder (group by category)
                const unfiledItems = videos.filter(v => !v.folderId);
                if (unfiledItems.length > 0) {
                    // Group unfiled items by category
                    const categories = {};
                    unfiledItems.forEach(video => {
                        const cat = video.category || 'Overig';
                        if (!categories[cat]) categories[cat] = [];
                        categories[cat].push(video);
                    });

                    Object.keys(categories).sort().forEach(category => {
                        const catIcon = getCategoryIcon(category);
                        html += `<div class="category-header" style="cursor: pointer;" onclick="toggleContentCategory('${category}')">
                            <span>${catIcon}</span>
                            <span>${category}</span>
                            <span style="margin-left: auto; font-size: 0.75rem; color: var(--text-muted);">${categories[category].length}</span>
                        </div>`;

                        categories[category].forEach(video => {
                            html += renderContentItem(video, 0);
                        });
                    });
                }
            }

            container.innerHTML = html;

            // Update stats
            document.getElementById('stat-videos').textContent = videos.length;
        }

        function getCategoryIcon(category) {
            const icons = {
                'YouTube Analyse': '‚ñ∂Ô∏è',
                'Tutorials': 'üìö',
                'Code Reviews': 'üíª',
                'Documentatie': 'üìÑ',
                'Audio': 'üéôÔ∏è',
                'Audio Opname': 'üéôÔ∏è',
                'Video Analyse': 'üé¨',
                'Video Opname': 'üé•',
                'Document': 'üìÑ',
                'AI Development': 'ü§ñ'
            };
            return icons[category] || 'üìÅ';
        }

        // ============================================
        // WELCOME OVERVIEW
        // ============================================
        function renderWelcomeOverview() {
            const activeCount = mijnBreinData.folders.filter(f => f.status === 'active').length;

            document.getElementById('overviewContent').innerHTML = `
                <div class="note-header">
                    <h1 class="note-title">üß† Brain App Dashboard</h1>
                    <div class="note-badges">
                        <span class="badge badge-success">${activeCount} Actief</span>
                        <span class="badge">${mijnBreinData.folders.length} Folders</span>
                        <span class="badge">${Object.keys(videoData).length} Video's</span>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">‚ö° Quick Actions</h2>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="openInFinder('${mijnBreinData.documentsPath}')">üìÇ Documents</button>
                        <button class="quick-action-btn" onclick="openInFinder('${mijnBreinData.obsidianPath}')">üìö Obsidian</button>
                        <button class="quick-action-btn" onclick="openInFinder('${mijnBreinData.claudePath}')">ü§ñ ~/.claude</button>
                        <button class="quick-action-btn" onclick="switchSidebarView('videos')">üé¨ Video's</button>
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">ü§ñ Claude Config</h2>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${mijnBreinData.claudeConfig.map(c => `
                            <span class="badge" style="background: var(--ai-purple); color: white;">${c.icon} ${c.name} (${c.count})</span>
                        `).join('')}
                    </div>
                </div>

                <div class="note-section">
                    <h2 class="section-title">üìä Statistieken</h2>
                    <p style="color: var(--text-muted); font-size: 0.85rem;">
                        Gebruik de sidebar links om door je Brein folders te navigeren, of switch naar Video's voor analyses.
                    </p>
                </div>
            `;
        }

        // ============================================
        // FOLDER SELECTION
        // ============================================
        function selectFolder(folderId) {
            currentFolderId = folderId;
            currentVideoId = null;
            renderBreinList();

            const folder = mijnBreinData.folders.find(f => f.id === folderId);
            if (!folder) return;

            document.getElementById('overviewContent').innerHTML = `
                <div class="note-header">
                    <h1 class="note-title">${folder.icon} ${folder.name}</h1>
                    <div class="note-badges">
                        <span class="badge badge-category">${folder.category}</span>
                        <span class="badge ${folder.status === 'active' ? 'badge-success' : 'badge-warning'}">${folder.status === 'active' ? '‚úì Actief' : '‚óã Setup'}</span>
                    </div>
                </div>
                <div class="note-section">
                    <h2 class="section-title">üìù Beschrijving</h2>
                    <p class="section-content">${folder.description}</p>
                </div>
                <div class="note-section">
                    <h2 class="section-title">üìÇ Locatie</h2>
                    <div class="code-block"><pre>${mijnBreinData.documentsPath}/${folder.path}</pre></div>
                    <button class="btn btn-install" style="margin-top: 0.75rem;" onclick="openInFinder('${mijnBreinData.documentsPath}/${folder.path}')">üìÇ Open in Finder</button>
                </div>
            `;

            switchToTab('overview');
            logToDevTools(`Selected folder: ${folder.name}`, 'info');
        }

        // ============================================
        // VIDEO SELECTION
        // ============================================
        function selectVideo(videoId) {
            currentVideoId = videoId;
            selectedVideoId = videoId; // For analyze panel
            currentFolderId = null;
            renderVideoList();

            const video = videoData[videoId];
            if (!video) return;

            renderOverviewPanel(videoId);
            renderInstallPanel(videoId);
            renderCodePanel(videoId);
            updateAnalyzePanel(video.type); // Update analyze panel based on content type
            switchToTab('analyze'); // Default to Analyze tab when selecting content
            logToDevTools(`Selected video: ${video.title}`, 'info');
        }

        // Update Analyze panel based on selected content type
        function updateAnalyzePanel(contentType) {
            // Hide all analysis sections
            document.getElementById('noContentSelected').style.display = 'none';
            document.getElementById('youtubeAnalysisSection').style.display = 'none';
            document.getElementById('documentAnalysisSection').style.display = 'none';
            document.getElementById('videoAudioAnalysisSection').style.display = 'none';
            document.getElementById('analysisProgressSection').style.display = 'none';
            document.getElementById('analysisResultsSection').style.display = 'none';
            document.getElementById('transcriptSection').style.display = 'none';

            // Hide FASE 2 and FASE 3 sections by default (for non-document content)
            const fase2Section = document.getElementById('docFase2Section');
            const fase3Section = document.getElementById('docFase3Section');
            if (fase2Section) fase2Section.style.display = 'none';
            if (fase3Section) fase3Section.style.display = 'none';

            const content = videoData[selectedVideoId];
            if (!content) {
                document.getElementById('noContentSelected').style.display = 'block';
                return;
            }

            // Show appropriate section based on content type
            if (contentType === 'youtube') {
                document.getElementById('youtubeAnalysisSection').style.display = 'block';
                document.getElementById('ytSelectedTitle').textContent = content.title;
                document.getElementById('ytSelectedUrl').textContent = content.youtubeUrl || 'URL niet beschikbaar';

                // Update button states to show completed analyses
                updateAnalysisButtonStates(content);

                // If already analyzed, show results
                if (content.fullAnalysis) {
                    displayAnalysisResultsInPanel({ analysis: content.fullAnalysis, engine: content.engine });
                    if (content.transcript) {
                        document.getElementById('transcriptContent').textContent = content.transcript;
                        document.getElementById('transcriptSection').style.display = 'block';
                    }
                }
            } else if (contentType === 'document') {
                document.getElementById('documentAnalysisSection').style.display = 'block';
                document.getElementById('docSelectedTitle').textContent = content.title;
                const fileNames = content.filePaths ? content.filePaths.map(f => f.split('/').pop()).join(', ') : 'Geen bestanden';
                document.getElementById('docSelectedFiles').textContent = fileNames;

                // Set selectedContentItem for 3-fase workflow
                selectedContentItem = {
                    id: content.id,
                    title: content.title,
                    files: content.filePaths || [],
                    type: 'document'
                };

                // Update the 3-fase analyses UI for this document
                updateDocAnalysesUI();

                // Load existing fullAnalysis into unified card system
                if (content.fullAnalysis) {
                    displayAnalysisResultsInPanel({ analysis: content.fullAnalysis, engine: content.engine });
                }
            } else if (contentType === 'video' || contentType === 'audio') {
                document.getElementById('videoAudioAnalysisSection').style.display = 'block';
                document.getElementById('videoAudioSectionTitle').textContent = contentType === 'video' ? 'üé• Video Analyseren' : 'üéµ Audio Analyseren';
                document.getElementById('videoAudioSelectedTitle').textContent = content.title;
                document.getElementById('videoAudioSelectedFile').textContent = content.filePath ? content.filePath.split('/').pop() : 'Lokaal bestand';

                if (content.fullAnalysis) {
                    displayAnalysisResultsInPanel({ analysis: content.fullAnalysis, engine: content.engine });
                }
            } else {
                document.getElementById('noContentSelected').style.display = 'block';
            }
        }

        function renderOverviewPanel(videoId) {
            const video = videoData[videoId];
            const savedNote = localStorage.getItem(`brain-note-${videoId}`) || '';
            const savedRating = parseInt(localStorage.getItem(`brain-rating-${videoId}`)) || 0;

            let html = `
                <div class="note-header">
                    <h1 class="note-title">${video.title}</h1>
                    <div class="note-badges">
                        <span class="badge badge-category">${video.category}</span>
                        <span class="badge">üìÖ ${video.date}</span>
                        ${video.badges.map(b => `<span class="badge" style="background: var(--ai-purple); color: white;">${b}</span>`).join('')}
                    </div>
                </div>
                <div class="note-section">
                    <h2 class="section-title">üìù Samenvatting</h2>
                    <p class="section-content">${video.summary}</p>
                </div>
            `;

            if (video.tipsTable) {
                html += `<div class="note-section"><h2 class="section-title">üîü Tips</h2><table class="data-table"><thead><tr><th>#</th><th>Tip</th><th>Type</th></tr></thead><tbody>${video.tipsTable.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`).join('')}</tbody></table></div>`;
            }

            if (video.folderStructure) {
                html += `<div class="note-section"><h2 class="section-title">üìÇ Structuur</h2><div class="code-block"><pre>${video.folderStructure}</pre></div></div>`;
            }

            html += `
                <div class="note-section">
                    <h2 class="section-title"><span>üì¶ Items (${video.items.length})</span><button class="btn btn-install" onclick="switchToTab('install')">Installeer</button></h2>
                    <div style="display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.5rem;">
                        ${video.items.map(i => `<span class="badge" style="background: ${i.type === 'command' ? 'var(--highlight)' : i.type === 'subagent' ? 'var(--ai-blue)' : 'var(--ai-purple)'}; color: white;">${i.type === 'command' ? '‚ö°' : i.type === 'subagent' ? 'ü§ñ' : '‚öôÔ∏è'} ${i.name}</span>`).join('')}
                    </div>
                </div>
            `;

            if (video.bestPractices) {
                html += `<div class="note-section"><h2 class="section-title">‚úÖ Best Practices</h2><ul style="list-style: none; padding: 0;">${video.bestPractices.map(bp => `<li style="padding: 0.4rem 0; border-bottom: 1px solid var(--border); font-size: 0.85rem;"><span style="color: var(--success);">‚úì</span> ${bp}</li>`).join('')}</ul></div>`;
            }

            // Video Timeline Section (if segments available)
            if (video.segments && video.segments.length > 0 && video.videoId) {
                html += renderVideoTimeline(video);
            }

            html += `
                <div class="note-section">
                    <h2 class="section-title">üí≠ Notities & Rating</h2>
                    <textarea class="notes-textarea" id="noteInput" placeholder="Jouw gedachten..." onchange="saveNote('${videoId}')">${savedNote}</textarea>
                    <div class="star-rating">${[1,2,3,4,5].map(i => `<span class="star ${i <= savedRating ? 'filled' : ''}" onclick="saveRating('${videoId}', ${i})">‚òÖ</span>`).join('')}</div>
                </div>
            `;

            document.getElementById('overviewContent').innerHTML = html;
        }

        // Render video timeline with clickable segments
        function renderVideoTimeline(video) {
            const segments = video.segments || [];
            const videoId = video.videoId;
            const duration = video.videoDuration || segments[segments.length - 1]?.endTime || 0;

            let html = `
                <div class="note-section">
                    <h2 class="section-title">üìç Video Tijdslijn</h2>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem;">
                        Klik op een segment om naar dat moment in de video te gaan
                    </p>

                    <!-- Visual Timeline Bar -->
                    <div style="position: relative; height: 40px; background: var(--bg-dark); border-radius: 8px; margin-bottom: 1rem; overflow: hidden;">
                        ${segments.map((seg, idx) => {
                            const startPct = (seg.startTime / duration) * 100;
                            const widthPct = ((seg.endTime - seg.startTime) / duration) * 100;
                            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899', '#84cc16'];
                            const color = colors[idx % colors.length];
                            return `
                                <div onclick="openYouTubeAt('${videoId}', ${seg.startTime})"
                                     style="position: absolute; left: ${startPct}%; width: ${widthPct}%; height: 100%;
                                            background: ${color}; cursor: pointer; border-right: 1px solid var(--bg-primary);
                                            display: flex; align-items: center; justify-content: center; transition: filter 0.2s;"
                                     onmouseover="this.style.filter='brightness(1.2)'"
                                     onmouseout="this.style.filter='brightness(1)'"
                                     title="Segment ${seg.index}: ${seg.startFormatted} - ${seg.endFormatted}">
                                    <span style="color: white; font-size: 0.7rem; font-weight: bold;">${seg.index}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Segment List -->
                    <div style="display: grid; gap: 0.5rem;">
                        ${segments.map((seg, idx) => {
                            // Extract first code block or summary from content
                            const codeMatch = seg.content.match(/\`\`\`[\s\S]*?\`\`\`/);
                            const hasCode = codeMatch !== null;
                            const preview = seg.content.substring(0, 150).replace(/[#\`\*]/g, '').trim() + '...';

                            return `
                                <div style="display: flex; gap: 0.75rem; padding: 0.75rem; background: var(--bg-dark); border-radius: 8px; cursor: pointer; transition: background 0.2s;"
                                     onclick="openYouTubeAt('${videoId}', ${seg.startTime})"
                                     onmouseover="this.style.background='var(--bg-primary)'"
                                     onmouseout="this.style.background='var(--bg-dark)'">
                                    <div style="min-width: 70px; text-align: center;">
                                        <div style="font-size: 0.9rem; font-weight: bold; color: var(--ai-blue);">‚ñ∂ ${seg.startFormatted}</div>
                                        <div style="font-size: 0.65rem; color: var(--text-muted);">Segment ${seg.index}</div>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.75rem; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${hasCode ? 'üíª Code aanwezig' : 'üìù Tekst'} ‚Ä¢ ${preview}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            return html;
        }

        // Open YouTube at specific timestamp
        function openYouTubeAt(videoId, seconds) {
            const url = `https://www.youtube.com/watch?v=${videoId}&t=${Math.floor(seconds)}`;
            window.brain.openExternal(url);
            showToast(`YouTube opent op ${formatSecondsToTime(Math.floor(seconds))}`);
        }

        // Helper to format seconds to MM:SS or HH:MM:SS
        function formatSecondsToTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function renderInstallPanel(videoId) {
            const video = videoData[videoId];
            if (!video) return;

            const commands = video.items.filter(i => i.type === 'command');
            const subagents = video.items.filter(i => i.type === 'subagent');
            const claudemd = video.items.filter(i => i.type === 'claudemd');

            let html = `<div class="note-section"><h2 class="section-title">üöÄ Installeer: ${video.title}</h2></div>`;

            // Add Claude Code CLI Integration section for documents with analysis
            if (video.type === 'document' && video.fullAnalysis) {
                html += `
                    <div class="note-section">
                        <h2 class="section-title">üöÄ Claude Code CLI Builder</h2>
                        <div id="claudeCliStatus" style="padding: 0.5rem; background: var(--bg-primary); border-radius: 6px; margin-bottom: 1rem; font-size: 0.8rem;">
                            <span id="claudeCliStatusIcon">‚è≥</span> <span id="claudeCliStatusText">Controleren...</span>
                        </div>

                        <!-- Build Instructions Input -->
                        <div style="margin-bottom: 1rem;">
                            <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">
                                üìù Extra bouw instructies (optioneel):
                            </label>
                            <textarea id="buildInstructionsInput" placeholder="Bijv: Gebruik React met TypeScript, maak het responsive..." style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; min-height: 60px; resize: vertical;"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                            <button class="btn btn-install" onclick="startClaudeBuild('${video.id}')" style="flex: 2;" id="startBuildBtn-${video.id}">
                                üèóÔ∏è Start Bouwen met Claude
                            </button>
                            <button class="btn" onclick="exportToClaudeCodeCLI('${video.id}')" style="flex: 1;">
                                üì¶ Export
                            </button>
                        </div>

                        <!-- Alternative Actions -->
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn" onclick="openTerminalForProject('${video.id}')" style="flex: 1;">
                                üíª Open Terminal
                            </button>
                            <button class="btn" onclick="copyClaudePrompt('${video.id}')" style="flex: 1;">
                                üìã Kopieer Prompt
                            </button>
                        </div>

                        ${video.claudePrompt ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px; border-left: 3px solid var(--accent);">
                                <div style="font-size: 0.75rem; color: var(--accent); margin-bottom: 0.5rem;">üí° Gegenereerde Claude Prompt:</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${escapeHtml(video.claudePrompt.substring(0, 300))}${video.claudePrompt.length > 300 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Claude Build Output Section -->
                    <div class="note-section" id="claudeBuildOutput-${video.id}" style="display: none;">
                        <h2 class="section-title">
                            <span>üìü Claude Output</span>
                            <button class="btn" onclick="stopClaudeBuild('${video.id}')" id="stopBuildBtn-${video.id}" style="background: #ef4444;">
                                ‚èπÔ∏è Stop
                            </button>
                        </h2>
                        <div id="claudeOutput-${video.id}" style="background: #0d1117; color: #c9d1d9; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.8rem; max-height: 400px; overflow-y: auto; white-space: pre-wrap;"></div>
                        <div id="claudeProjectPath-${video.id}" style="margin-top: 0.5rem; display: none;">
                            <button class="btn btn-install" onclick="openProjectFolder()" style="width: 100%;">
                                üìÇ Open Project Map
                            </button>
                        </div>
                    </div>
                `;
            }

            if (commands.length) html += `<div class="note-section"><h2 class="section-title">‚ö° Commands (${commands.length})</h2>${commands.map(renderInstallItem).join('')}</div>`;
            if (subagents.length) html += `<div class="note-section"><h2 class="section-title">ü§ñ Subagents (${subagents.length})</h2>${subagents.map(renderInstallItem).join('')}</div>`;
            if (claudemd.length) html += `<div class="note-section"><h2 class="section-title">‚öôÔ∏è Rules (${claudemd.length})</h2>${claudemd.map(renderInstallItem).join('')}</div>`;

            // If no items at all, show helpful message
            if (!commands.length && !subagents.length && !claudemd.length && !(video.type === 'document' && video.fullAnalysis)) {
                html += `
                    <div class="note-section">
                        <p style="color: var(--text-muted); font-style: italic;">
                            Geen installeerbare items gevonden. Analyseer eerst de content om items te extraheren.
                        </p>
                    </div>
                `;
            }

            document.getElementById('installContent').innerHTML = html;
        }

        function renderInstallItem(item) {
            const isInstalled = installedItems.has(item.id);
            return `
                <div class="install-item ${isInstalled ? 'installed' : ''}" id="item-${item.id}">
                    <span class="install-icon">${item.type === 'command' ? '‚ö°' : item.type === 'subagent' ? 'ü§ñ' : '‚öôÔ∏è'}</span>
                    <div class="install-info"><div class="install-name">${item.name}</div><div class="install-desc">${item.description}</div></div>
                    <div class="install-actions">
                        <button class="btn" onclick="viewCode('${item.id}')">üëÅÔ∏è</button>
                        <button class="btn ${isInstalled ? '' : 'btn-install'}" onclick="installItem('${item.id}')">${isInstalled ? '‚úì' : 'üöÄ'}</button>
                    </div>
                </div>
            `;
        }

        function renderCodePanel(videoId) {
            const video = videoData[videoId];
            if (!video) return;

            let html = `<div class="note-section"><h2 class="section-title">üíª Code: ${video.title}</h2></div>`;

            // Find which segment each item belongs to (by matching code in segment content)
            video.items.forEach(item => {
                let timestampButton = '';

                // Try to find the segment containing this code
                if (video.segments && video.videoId) {
                    const matchingSegment = video.segments.find(seg =>
                        seg.content && seg.content.includes(item.code.substring(0, 50))
                    );
                    if (matchingSegment) {
                        timestampButton = `<button class="btn" onclick="openYouTubeAt('${video.videoId}', ${matchingSegment.startTime})" title="Bekijk in video" style="background: var(--ai-blue);">‚ñ∂ ${matchingSegment.startFormatted}</button>`;
                    }
                }

                html += `
                    <div class="note-section">
                        <h2 class="section-title">
                            <span>${item.type === 'command' ? '‚ö°' : item.type === 'subagent' ? 'ü§ñ' : '‚öôÔ∏è'} ${item.name}</span>
                            <div style="display: flex; gap: 0.5rem;">
                                ${timestampButton}
                                <button class="btn" onclick="copyCode('${item.id}')">üìã Kopieer</button>
                            </div>
                        </h2>
                        <div class="code-block"><pre id="code-${item.id}">${escapeHtml(item.code)}</pre></div>
                    </div>
                `;
            });
            document.getElementById('codeContent').innerHTML = html;
        }

        // ============================================
        // TABS
        // ============================================
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchToTab(tab.dataset.tab));
            });
        }

        function switchToTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            document.querySelectorAll('.content-panel').forEach(p => p.classList.add('panel-hidden'));
            document.getElementById(`panel-${tabName}`).classList.remove('panel-hidden');

            // Initialize backup system when Settings tab is opened
            if (tabName === 'settings') {
                initBackupSystem();
            }

            // Check Claude CLI when Install tab is opened
            if (tabName === 'install') {
                checkClaudeCLIStatus();
            }

            // Update Analyze panel when Analyze tab is opened
            if (tabName === 'analyze' && selectedVideoId && videoData[selectedVideoId]) {
                updateAnalyzePanel(videoData[selectedVideoId].type);
            }
        }

        // ============================================
        // RIGHT PANEL: TERMINAL & DEVTOOLS
        // ============================================
        function toggleRightPanel() {
            document.getElementById('rightPanel').classList.toggle('collapsed');
        }

        function toggleTerminal() {
            document.querySelector('.terminal-header').classList.toggle('collapsed');
            document.getElementById('terminalOutput').classList.toggle('collapsed');
        }

        function toggleDevTools() {
            document.querySelector('.devtools-header').classList.toggle('collapsed');
            document.getElementById('devtoolsOutput').classList.toggle('collapsed');
        }

        function handleTerminalInput(event) {
            if (event.key !== 'Enter') return;

            const input = event.target;
            const cmd = input.value.trim();
            if (!cmd) return;

            terminalHistory.push(cmd);
            addTerminalLine(`‚ùØ ${cmd}`, '');

            // Simple command handling
            switch(cmd.toLowerCase()) {
                case 'help':
                    addTerminalLine('Commands: help, clear, folders, videos, status', 'info');
                    break;
                case 'clear':
                    document.getElementById('terminalOutput').innerHTML = '';
                    break;
                case 'folders':
                    addTerminalLine(`${mijnBreinData.folders.length} folders loaded`, 'success');
                    break;
                case 'videos':
                    addTerminalLine(`${Object.keys(videoData).length} videos loaded`, 'success');
                    break;
                case 'status':
                    addTerminalLine('Brain App running OK', 'success');
                    break;
                default:
                    addTerminalLine(`Unknown: ${cmd}`, 'error');
            }

            input.value = '';
            logToDevTools(`Terminal: ${cmd}`, 'info');
        }

        function addTerminalLine(text, type = '') {
            const output = document.getElementById('terminalOutput');
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.textContent = text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function logToDevTools(msg, type = 'log') {
            const output = document.getElementById('devtoolsOutput');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'var(--highlight)' : type === 'info' ? 'var(--ai-blue)' : 'var(--text-muted)';
            output.innerHTML += `<div style="color: ${color};">[${time}] ${msg}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        // ============================================
        // ACTIONS
        // ============================================
        function viewCode(itemId) {
            switchToTab('code');
            setTimeout(() => {
                const el = document.getElementById(`code-${itemId}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function copyCode(itemId) {
            const video = videoData[currentVideoId];
            const item = video?.items.find(i => i.id === itemId);
            if (!item) return;
            navigator.clipboard.writeText(item.code).then(() => showToast('Gekopieerd!'));
            logToDevTools(`Copied: ${item.name}`, 'info');
        }

        function installItem(itemId) {
            installedItems.add(itemId);
            localStorage.setItem('brain-installed-items', JSON.stringify([...installedItems]));
            const el = document.getElementById(`item-${itemId}`);
            if (el) {
                el.classList.add('installed');
                const btn = el.querySelector('.btn-install');
                if (btn) { btn.classList.remove('btn-install'); btn.textContent = '‚úì'; }
            }
            showToast('Ge√Ønstalleerd!');
            logToDevTools(`Installed: ${itemId}`, 'success');
        }

        function saveNote(videoId) {
            const note = document.getElementById('noteInput').value;
            localStorage.setItem(`brain-note-${videoId}`, note);
            showToast('Notitie opgeslagen!');
        }

        function saveRating(videoId, rating) {
            localStorage.setItem(`brain-rating-${videoId}`, rating);
            document.querySelectorAll('.star').forEach((star, i) => star.classList.toggle('filled', i < rating));
            renderVideoList();
            showToast(`${rating} sterren`);
            logToDevTools(`Rating: ${videoId} = ${rating}`, 'info');
        }

        async function deleteContent(contentId) {
            const content = videoData[contentId];
            if (!content) return;

            const confirmDelete = confirm(`Weet je zeker dat je "${content.title}" wilt verwijderen?`);
            if (!confirmDelete) return;

            // Remove from videoData
            delete videoData[contentId];

            // Save to electron-store and localStorage
            await saveAllContentToStorage();

            // Remove associated data
            localStorage.removeItem(`brain-note-${contentId}`);
            localStorage.removeItem(`brain-rating-${contentId}`);

            // Clear selection if this was selected
            if (currentVideoId === contentId) {
                currentVideoId = null;
                selectedVideoId = null;
                document.getElementById('overviewContent').innerHTML = '<p style="color: var(--text-muted); padding: 2rem; text-align: center;">Selecteer content uit de sidebar</p>';
            }

            renderVideoList();
            showToast(`"${content.title}" verwijderd`);
            logToDevTools(`Deleted content: ${content.title}`, 'info');
            logApp(`Content deleted: ${content.title}`);
        }

        // ============================================
        // CUSTOM PROMPT MODAL (Electron doesn't support prompt())
        // ============================================
        let promptCallback = null;

        function showPromptModal(title, label, defaultValue = '', callback) {
            document.getElementById('promptModalTitle').textContent = title;
            document.getElementById('promptModalLabel').textContent = label;
            document.getElementById('promptModalInput').value = defaultValue;
            document.getElementById('promptModalInput').placeholder = defaultValue;
            promptCallback = callback;
            document.getElementById('promptModal').classList.add('active');
            document.getElementById('promptModalInput').focus();

            // Allow Enter key to submit
            document.getElementById('promptModalInput').onkeydown = (e) => {
                if (e.key === 'Enter') submitPromptModal();
                if (e.key === 'Escape') closePromptModal();
            };
        }

        function closePromptModal() {
            document.getElementById('promptModal').classList.remove('active');
            document.getElementById('promptModalInput').value = '';
            if (promptCallback) {
                promptCallback(null); // User cancelled
                promptCallback = null;
            }
        }

        function submitPromptModal() {
            const value = document.getElementById('promptModalInput').value.trim();
            document.getElementById('promptModal').classList.remove('active');
            if (promptCallback) {
                promptCallback(value || null);
                promptCallback = null;
            }
        }

        // ============================================
        // FOLDER MANAGEMENT
        // ============================================
        function createNewFolder(parentId = null) {
            console.log('createNewFolder called with parentId:', parentId);

            showPromptModal('Nieuwe Map', 'Naam voor de map:', 'Nieuwe Map', (name) => {
                console.log('User entered name:', name);
                if (!name || !name.trim()) {
                    console.log('Name empty or cancelled, returning');
                    return;
                }

                const folderId = `folder-${Date.now()}`;
                folderData[folderId] = {
                    id: folderId,
                    name: name.trim(),
                    parentId: parentId,
                    createdAt: new Date().toISOString()
                };
                console.log('Created folder:', folderData[folderId]);
                console.log('All folders now:', Object.keys(folderData).length, folderData);

                saveFolders();
                console.log('Folders saved to localStorage');
                renderVideoList();
                console.log('Video list re-rendered');
                showToast(`Map "${name}" aangemaakt`);
                logApp(`Folder created: ${name}`);
            });
        }

        function renameFolder(folderId) {
            const folder = folderData[folderId];
            if (!folder) return;

            showPromptModal('Map Hernoemen', 'Nieuwe naam:', folder.name, (newName) => {
                if (!newName || !newName.trim() || newName === folder.name) return;

                const oldName = folder.name;
                folder.name = newName.trim();
                saveFolders();
                renderVideoList();
                showToast(`Map hernoemd naar "${newName}"`);
                logApp(`Folder renamed: ${oldName} -> ${newName}`);
            });
        }

        function deleteFolder(folderId) {
            const folder = folderData[folderId];
            if (!folder) return;

            // Check if folder has content
            const itemsInFolder = Object.values(videoData).filter(v => v.folderId === folderId);
            const subFolders = Object.values(folderData).filter(f => f.parentId === folderId);

            let message = `Weet je zeker dat je map "${folder.name}" wilt verwijderen?`;
            if (itemsInFolder.length > 0 || subFolders.length > 0) {
                message += `\n\n‚ö†Ô∏è Deze map bevat ${itemsInFolder.length} items en ${subFolders.length} submappen.\nItems worden verplaatst naar "Niet ingedeeld".`;
            }

            if (!confirm(message)) return;

            // Move items to root (no folder)
            itemsInFolder.forEach(item => {
                item.folderId = null;
                updateContentInStorage(item);
            });

            // Move subfolders to root
            subFolders.forEach(sub => {
                sub.parentId = null;
            });

            // Delete the folder
            delete folderData[folderId];
            saveFolders();
            renderVideoList();
            showToast(`Map "${folder.name}" verwijderd`);
            logApp(`Folder deleted: ${folder.name}`);
        }

        function moveContentToFolder(contentId, folderId) {
            const content = videoData[contentId];
            if (!content) return;

            content.folderId = folderId;
            updateContentInStorage(content);
            renderVideoList();

            const folderName = folderId ? folderData[folderId]?.name : 'Niet ingedeeld';
            showToast(`"${content.title}" verplaatst naar ${folderName}`);
            logApp(`Content moved: ${content.title} -> ${folderName}`);
        }

        async function saveFolders() {
            // Save to electron-store via IPC (primary - reliable)
            try {
                const result = await window.brain.saveFolders(folderData);
                if (result.success) {
                    console.log('Folders saved to electron-store:', Object.keys(folderData).length, 'folders');
                } else {
                    console.error('Failed to save folders to electron-store:', result.error);
                }
            } catch (error) {
                console.error('Error saving folders:', error);
            }
            // Also save to localStorage as backup
            localStorage.setItem('brain-folders', JSON.stringify(folderData));
        }

        // Move a folder to another folder (or to root)
        function moveFolderToFolder(folderId, targetParentId) {
            const folder = folderData[folderId];
            if (!folder) return;

            // Prevent moving folder into itself or its descendants
            if (targetParentId) {
                let checkId = targetParentId;
                while (checkId) {
                    if (checkId === folderId) {
                        showToast('Kan map niet in zichzelf of submap verplaatsen');
                        return;
                    }
                    checkId = folderData[checkId]?.parentId;
                }
            }

            folder.parentId = targetParentId;
            saveFolders();
            renderVideoList();

            const targetName = targetParentId ? folderData[targetParentId]?.name : 'Root';
            showToast(`Map "${folder.name}" verplaatst naar ${targetName}`);
            logApp(`Folder moved: ${folder.name} -> ${targetName}`);
        }

        // Show context menu to move a folder
        function showMoveFolderMenu(folderId, event) {
            event.stopPropagation();

            // Remove existing menu
            const existing = document.getElementById('folderMoveMenu');
            if (existing) existing.remove();

            const currentFolder = folderData[folderId];
            if (!currentFolder) return;

            const menu = document.createElement('div');
            menu.id = 'folderMoveMenu';
            menu.className = 'folder-move-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${event.clientX}px;
                top: ${event.clientY}px;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 0.5rem 0;
                min-width: 200px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;

            // Get all valid target folders (exclude self and descendants)
            const getDescendantIds = (parentId) => {
                const ids = [parentId];
                Object.values(folderData).filter(f => f.parentId === parentId).forEach(child => {
                    ids.push(...getDescendantIds(child.id));
                });
                return ids;
            };
            const excludeIds = getDescendantIds(folderId);

            let menuHtml = `<div style="padding: 0.3rem 0.75rem; font-size: 0.7rem; color: var(--text-muted); border-bottom: 1px solid var(--border);">Verplaats "${currentFolder.name}" naar...</div>`;

            // Option to move to root
            if (currentFolder.parentId) {
                menuHtml += `<div class="folder-menu-item" onclick="moveFolderToFolder('${folderId}', null); document.getElementById('folderMoveMenu').remove();">üìÅ Root (hoofdniveau)</div>`;
            }

            // Build hierarchical folder list
            const buildFolderMenuItems = (parentId = null, depth = 0) => {
                let html = '';
                const childFolders = Object.values(folderData).filter(f => f.parentId === parentId && !excludeIds.includes(f.id));
                childFolders.forEach(folder => {
                    const indent = '&nbsp;&nbsp;'.repeat(depth);
                    const prefix = depth > 0 ? '‚îî ' : '';
                    html += `<div class="folder-menu-item" onclick="moveFolderToFolder('${folderId}', '${folder.id}'); document.getElementById('folderMoveMenu').remove();">${indent}${prefix}üìÅ ${folder.name}</div>`;
                    html += buildFolderMenuItems(folder.id, depth + 1);
                });
                return html;
            };

            menuHtml += buildFolderMenuItems();

            if (menuHtml.indexOf('folder-menu-item') === menuHtml.lastIndexOf('folder-menu-item') && !currentFolder.parentId) {
                menuHtml += '<div style="padding: 0.5rem 0.75rem; color: var(--text-muted); font-size: 0.8rem;">Geen andere mappen beschikbaar</div>';
            }

            menu.innerHTML = menuHtml;
            document.body.appendChild(menu);

            // Close on click outside
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        function toggleFolder(folderId) {
            if (collapsedFolders.has(folderId)) {
                collapsedFolders.delete(folderId);
            } else {
                collapsedFolders.add(folderId);
            }
            renderVideoList();
        }

        function showMoveToFolderMenu(contentId, event) {
            event.stopPropagation();

            // Remove existing menu
            const existing = document.getElementById('folderMoveMenu');
            if (existing) existing.remove();

            const menu = document.createElement('div');
            menu.id = 'folderMoveMenu';
            menu.className = 'folder-move-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${event.clientX}px;
                top: ${event.clientY}px;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 0.5rem 0;
                min-width: 180px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;

            let menuHtml = '<div style="padding: 0.3rem 0.75rem; font-size: 0.7rem; color: var(--text-muted); border-bottom: 1px solid var(--border-color);">Verplaats naar...</div>';
            menuHtml += `<div class="folder-menu-item" onclick="moveContentToFolder('${contentId}', null); document.getElementById('folderMoveMenu').remove();">üìÅ Niet ingedeeld</div>`;

            Object.values(folderData).forEach(folder => {
                menuHtml += `<div class="folder-menu-item" onclick="moveContentToFolder('${contentId}', '${folder.id}'); document.getElementById('folderMoveMenu').remove();">üìÅ ${folder.name}</div>`;
            });

            menuHtml += `<div style="border-top: 1px solid var(--border-color); margin-top: 0.3rem; padding-top: 0.3rem;">
                <div class="folder-menu-item" onclick="createNewFolder(); document.getElementById('folderMoveMenu').remove();">‚ûï Nieuwe map...</div>
            </div>`;

            menu.innerHTML = menuHtml;
            document.body.appendChild(menu);

            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        function openInFinder(path) {
            if (window.brain?.openExternal) {
                window.brain.openExternal(path);
            }
            showToast(`Open: ${path.split('/').pop()}`);
            logToDevTools(`Open: ${path}`, 'info');
        }

        function restartApp() {
            showToast('Herstart...');
            logToDevTools('Restarting app...', 'info');
            if (window.brain?.restartApp) {
                setTimeout(() => window.brain.restartApp(), 500);
            } else {
                setTimeout(() => location.reload(), 500);
            }
        }

        // ============================================
        // GEMINI VIDEO ANALYSIS
        // ============================================
        let lastAnalysisResult = null;

        async function checkGeminiStatus() {
            if (!window.brain?.getGeminiSettings) return;

            const settings = await window.brain.getGeminiSettings();
            const indicator = document.getElementById('geminiIndicator');
            const statusIcon = document.getElementById('geminiStatusIcon');
            const statusText = document.getElementById('geminiStatusText');
            const modelSelect = document.getElementById('geminiModelSettings');

            if (settings.hasApiKey) {
                if (indicator) indicator.textContent = 'üü¢';
                if (statusIcon) statusIcon.textContent = '‚úÖ';
                if (statusText) statusText.innerHTML = `<span style="color: var(--install-green);">API key geconfigureerd</span> - Model: <strong>${settings.model || 'gemini-2.0-flash'}</strong>`;

                // Update model selectors
                const model = settings.model || 'gemini-2.0-flash';
                if (modelSelect) modelSelect.value = model;
                if (document.getElementById('geminiModelSelect')) {
                    document.getElementById('geminiModelSelect').value = model;
                }
            } else {
                if (indicator) indicator.textContent = 'üî¥';
                if (statusIcon) statusIcon.textContent = '‚ùå';
                if (statusText) statusText.innerHTML = '<span style="color: var(--danger);">Geen API key geconfigureerd</span> - Voer hieronder je key in';
            }
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('geminiApiKeyInput');
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        async function saveGeminiApiKey() {
            const apiKey = document.getElementById('geminiApiKeyInput').value.trim();
            if (!apiKey) {
                showToast('Voer een API key in');
                return;
            }

            if (!apiKey.startsWith('AIza')) {
                showToast('Ongeldige API key format (moet beginnen met AIza)');
                return;
            }

            showToast('API key opslaan...');
            const result = await window.brain.setGeminiApiKey(apiKey);

            if (result.success) {
                showToast('API key succesvol opgeslagen!');
                document.getElementById('geminiApiKeyInput').value = '';
                document.getElementById('geminiApiKeyInput').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                await checkGeminiStatus();
                logToDevTools('Gemini API key configured', 'success');
            } else {
                showToast('Fout bij opslaan: ' + result.message);
                logToDevTools('API key save error: ' + result.message, 'error');
            }
        }

        async function saveGeminiModel() {
            const model = document.getElementById('geminiModelSettings').value;
            await window.brain.setGeminiModel(model);
            showToast(`Model gewijzigd naar ${model}`);
            await checkGeminiStatus();
        }

        async function testGeminiConnection() {
            showToast('Verbinding testen...');
            logToDevTools('Testing Gemini connection...', 'info');

            try {
                // Try a simple generation to test the API key
                const result = await window.brain.analyzeYouTubeVideo({
                    url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                    analysisType: 'full',
                    customPrompt: 'Zeg alleen "Test succesvol" en niets anders.'
                });

                if (result.success) {
                    showToast('‚úÖ Verbinding succesvol! API key werkt.');
                    logToDevTools('Gemini connection test: SUCCESS', 'success');
                    await checkGeminiStatus();
                } else {
                    showToast('‚ùå Test mislukt: ' + result.error);
                    logToDevTools('Gemini connection test failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('‚ùå Verbinding mislukt: ' + error.message);
                logToDevTools('Gemini connection error: ' + error.message, 'error');
            }
        }

        async function startVideoAnalysis() {
            const url = document.getElementById('videoUrlInput').value.trim();
            if (!url) {
                showToast('Voer een YouTube URL in');
                return;
            }

            const analysisType = document.getElementById('analysisType').value;
            const model = document.getElementById('geminiModelSelect').value;

            // Update model if changed
            await window.brain.setGeminiModel(model);

            // Show progress
            const progress = document.getElementById('analysisProgress');
            const progressText = document.getElementById('progressText');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultsSection = document.getElementById('analysisResultsSection');

            progress.style.display = 'block';
            analyzeBtn.disabled = true;
            resultsSection.style.display = 'none';

            progressText.textContent = 'Video analyseren met Gemini...';
            logToDevTools(`Starting ${analysisType} analysis of ${url}`, 'info');

            try {
                // Use combined analysis for full analysis, otherwise use specific type
                let result;
                if (analysisType === 'full') {
                    progressText.textContent = 'Volledige analyse (video + transcript)...';
                    result = await window.brain.analyzeVideoCombined({ url });
                } else {
                    progressText.textContent = `${analysisType} analyse uitvoeren...`;
                    result = await window.brain.analyzeVideoGemini({ url, analysisType });
                }

                if (result.success) {
                    lastAnalysisResult = result;
                    displayAnalysisResults(result);
                    logToDevTools(`Analysis complete: ${result.videoId}`, 'success');
                    showToast('Analyse voltooid!');
                } else {
                    showToast('Fout: ' + result.error);
                    logToDevTools('Analysis failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Fout: ' + error.message);
                logToDevTools('Analysis error: ' + error.message, 'error');
            } finally {
                progress.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }

        async function getTranscriptOnly() {
            const url = document.getElementById('videoUrlInput').value.trim();
            if (!url) {
                showToast('Voer een YouTube URL in');
                return;
            }

            const progress = document.getElementById('analysisProgress');
            const progressText = document.getElementById('progressText');

            progress.style.display = 'block';
            progressText.textContent = 'Transcript ophalen...';

            try {
                const result = await window.brain.getYouTubeTranscript(url);

                if (result.success) {
                    displayTranscript(result.transcript);
                    showToast('Transcript opgehaald!');
                    logToDevTools(`Transcript fetched: ${result.videoId}`, 'success');
                } else {
                    showToast('Fout: ' + result.error);
                    logToDevTools('Transcript error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Fout: ' + error.message);
            } finally {
                progress.style.display = 'none';
            }
        }

        function displayAnalysisResults(result) {
            const section = document.getElementById('analysisResultsSection');
            const metadata = document.getElementById('analysisMetadata');
            const content = document.getElementById('analysisResults');

            // Metadata
            metadata.innerHTML = `
                <strong>Video ID:</strong> ${result.videoId} |
                <strong>Model:</strong> ${result.model} |
                <strong>Type:</strong> ${result.analysisType || 'full'}
                ${result.note ? `<br><em style="color: var(--warning);">${result.note}</em>` : ''}
            `;

            // Convert markdown to HTML
            content.innerHTML = markdownToHtml(result.analysis);

            // Show transcript if available
            if (result.transcript && result.transcript.length > 0) {
                displayTranscript(result.transcript);
            }

            section.style.display = 'block';
        }

        function displayTranscript(transcript) {
            const section = document.getElementById('transcriptSection');
            const content = document.getElementById('transcriptContent');

            const lines = transcript.map(t => {
                const time = typeof t.time === 'number' ? t.time : t.start;
                const mins = Math.floor(time / 60);
                const secs = Math.floor(time % 60);
                return `<div class="transcript-line">
                    <span class="transcript-time">${mins}:${String(secs).padStart(2, '0')}</span>
                    <span class="transcript-text">${escapeHtml(t.text)}</span>
                </div>`;
            }).join('');

            content.innerHTML = lines;
            section.style.display = 'block';
        }

        function markdownToHtml(md) {
            if (!md) return '';
            return md
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold and italic
                .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Lists
                .replace(/^\s*[-*]\s(.+)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)\n(?=<li>)/g, '$1')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // Wrap in paragraph if not starting with header/list
                .replace(/^(?!<[hulo])/gm, '<p>')
                .replace(/(?<![>])$/gm, '</p>')
                // Clean up
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<[hulo])/g, '$1')
                .replace(/(<\/[hulo][^>]*>)<\/p>/g, '$1');
        }

        // LEGACY: Copy/Save functions for YouTube/Video/Audio analysis results (old section)
        function copyLegacyAnalysisToClipboard() {
            if (lastAnalysisResult?.analysis) {
                navigator.clipboard.writeText(lastAnalysisResult.analysis);
                showToast('Analyse gekopieerd naar klembord!');
            } else {
                // Fallback: try to copy from the analysisResults div
                const resultsDiv = document.getElementById('analysisResults');
                if (resultsDiv) {
                    navigator.clipboard.writeText(resultsDiv.innerText);
                    showToast('Analyse gekopieerd naar klembord!');
                }
            }
        }

        async function saveLegacyAnalysisToObsidian() {
            if (!lastAnalysisResult) {
                showToast('Geen analyse beschikbaar om op te slaan');
                return;
            }

            const filename = `Video-Analysis-${lastAnalysisResult.videoId}-${Date.now()}.md`;
            const content = `# Video Analyse: ${lastAnalysisResult.videoId}

**Model:** ${lastAnalysisResult.model}
**Type:** ${lastAnalysisResult.analysisType || 'full'}
**URL:** https://www.youtube.com/watch?v=${lastAnalysisResult.videoId}
**Datum:** ${new Date().toLocaleDateString('nl-NL')}

---

${lastAnalysisResult.analysis}
`;

            const result = await window.brain.saveToObsidian(filename, content, 'Gemini-Analyses');
            if (result.success) {
                showToast('Opgeslagen in Obsidian!');
                logToDevTools(`Saved to: ${result.path}`, 'success');
            } else {
                showToast('Fout: ' + result.error);
            }
        }

        async function addVideoToLibrary() {
            if (!lastAnalysisResult) return;

            // Extract title from analysis (first heading or first line)
            const titleMatch = lastAnalysisResult.analysis.match(/^#\s+(.+)/m) ||
                               lastAnalysisResult.analysis.match(/^##\s*(?:1\.\s*)?Video\s*(?:Overzicht|Overview)[:\s]*(.+)/mi);
            const title = titleMatch ? titleMatch[1].trim() : `Video ${lastAnalysisResult.videoId}`;

            const newVideo = {
                id: `video-${Date.now()}`,
                title: title,
                date: new Date().toLocaleDateString('nl-NL'),
                category: 'Gemini Analyse',
                badges: ['Gemini', lastAnalysisResult.model],
                summary: lastAnalysisResult.analysis.substring(0, 300) + '...',
                youtubeId: lastAnalysisResult.videoId,
                fullAnalysis: lastAnalysisResult.analysis,
                items: extractCodeItems(lastAnalysisResult.analysis)
            };

            // Add to videoData
            videoData[newVideo.id] = newVideo;

            // Save to electron-store and localStorage
            await saveAllContentToStorage();

            // Refresh video list
            renderVideoList();
            showToast('Video toegevoegd aan bibliotheek!');
            logToDevTools(`Added video: ${newVideo.title}`, 'success');

            // Switch to videos view
            switchSidebarView('videos');
        }

        function extractCodeItems(analysis) {
            const items = [];
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            let match;
            let index = 0;

            while ((match = codeBlockRegex.exec(analysis)) !== null) {
                const lang = match[1] || 'code';
                const code = match[2].trim();

                // Find context (previous heading or line)
                const beforeCode = analysis.substring(0, match.index);
                const headingMatch = beforeCode.match(/###?\s+(.+)\n[^#]*$/);
                const name = headingMatch ? headingMatch[1] : `Code Block ${index + 1}`;

                items.push({
                    id: `extracted-${Date.now()}-${index}`,
                    type: 'code',
                    name: name,
                    description: `${lang} code`,
                    code: code
                });
                index++;
            }

            return items;
        }

        // Initialize Gemini status on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkGeminiStatus, 500);

            // Load custom videos from localStorage
            const savedVideos = JSON.parse(localStorage.getItem('brain-custom-videos') || '[]');
            savedVideos.forEach(v => { videoData[v.id] = v; });
        });

        async function selectObsidianVault() {
            if (window.brain?.selectObsidianVault) {
                const path = await window.brain.selectObsidianVault();
                if (path) {
                    document.getElementById('obsidianPath').value = path;
                    showToast('Vault ingesteld!');
                }
            }
        }

        // ============================================
        // INPUT CONTENT MODAL
        // ============================================
        let currentInputType = 'youtube';
        let selectedAnalysisType = 'technical-deepdive';
        let selectedFilePath = null;
        let customCategories = JSON.parse(localStorage.getItem('brain-custom-categories') || '[]');
        let selectedYouTubeEngine = 'visual'; // Default to Gemini visual analysis

        // YouTube engine selection (transcript = Claude CLI, visual = Gemini)
        function selectYouTubeEngine(engine) {
            selectedYouTubeEngine = engine;

            // Update button styles (both in modal and analyze panel)
            document.querySelectorAll('[data-yt-engine]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.ytEngine === engine);
            });

            // Show/hide info sections in Analyze panel
            const analyzeTranscriptInfo = document.getElementById('analyzeTranscriptEngineInfo');
            const analyzeVisualInfo = document.getElementById('analyzeVisualEngineInfo');
            const analyzeVisualOptions = document.getElementById('analyzeVisualOptions');

            if (engine === 'transcript') {
                // Claude CLI - transcript based
                if (analyzeTranscriptInfo) analyzeTranscriptInfo.style.display = 'block';
                if (analyzeVisualInfo) analyzeVisualInfo.style.display = 'none';
                if (analyzeVisualOptions) analyzeVisualOptions.style.display = 'none';
            } else {
                // Gemini - visual based
                if (analyzeTranscriptInfo) analyzeTranscriptInfo.style.display = 'none';
                if (analyzeVisualInfo) analyzeVisualInfo.style.display = 'block';
                if (analyzeVisualOptions) analyzeVisualOptions.style.display = 'block';
            }

            logToDevTools(`YouTube engine changed to: ${engine}`, 'info');
        }

        // Update analysis button states based on completed analyses
        function updateAnalysisButtonStates(content) {
            if (!content || !content.analyses) return;

            const analyses = content.analyses;

            // Analysis type buttons
            document.querySelectorAll('[data-type]').forEach(btn => {
                const type = btn.dataset.type;
                // Check if this type was done with any engine
                const doneWithVisual = analyses[`${type}_gemini-visual`];
                const doneWithTranscript = analyses[`${type}_claude-cli`];

                if (doneWithVisual && doneWithTranscript) {
                    btn.classList.add('completed-both');
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    btn.style.borderColor = '#10b981';
                    btn.title = `‚úì Gedaan met Visueel & Transcript`;
                } else if (doneWithVisual) {
                    btn.classList.add('completed-visual');
                    btn.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
                    btn.style.borderColor = '#3b82f6';
                    btn.title = `‚úì Gedaan met Visueel (Gemini)`;
                } else if (doneWithTranscript) {
                    btn.classList.add('completed-transcript');
                    btn.style.background = 'linear-gradient(135deg, #8b5cf6, #6d28d9)';
                    btn.style.borderColor = '#8b5cf6';
                    btn.title = `‚úì Gedaan met Transcript (Claude)`;
                } else {
                    btn.classList.remove('completed-both', 'completed-visual', 'completed-transcript');
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.title = '';
                }
            });

            // Engine buttons
            document.querySelectorAll('[data-yt-engine]').forEach(btn => {
                const engine = btn.dataset.ytEngine;
                const engineKey = engine === 'visual' ? 'gemini-visual' : 'claude-cli';
                // Check if any analysis was done with this engine
                const doneWithEngine = Object.keys(analyses).some(key => key.endsWith(`_${engineKey}`));

                if (doneWithEngine) {
                    btn.classList.add('completed');
                    if (!btn.querySelector('.done-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.className = 'done-indicator';
                        indicator.textContent = ' ‚úì';
                        indicator.style.color = '#10b981';
                        btn.appendChild(indicator);
                    }
                }
            });

            // Show summary of completed analyses
            updateAnalysisSummary(content);
        }

        // Show summary of what analyses have been completed
        function updateAnalysisSummary(content) {
            let summaryEl = document.getElementById('analysisSummary');
            if (!summaryEl) {
                const container = document.querySelector('#youtubeAnalyzeOptions');
                if (container) {
                    summaryEl = document.createElement('div');
                    summaryEl.id = 'analysisSummary';
                    summaryEl.style.cssText = 'padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 8px; margin-bottom: 1rem; font-size: 0.75rem;';
                    container.insertBefore(summaryEl, container.firstChild);
                }
            }

            if (summaryEl && content.analyses) {
                const analyses = content.analyses;
                const completed = Object.keys(analyses).map(key => {
                    const a = analyses[key];
                    const engineIcon = a.engine === 'gemini-visual' ? 'üëÅÔ∏è' : 'ü§ñ';
                    const typeLabel = {
                        'full': 'Volledig',
                        'technical-deepdive': 'Tech Deep-Dive',
                        'code-extraction': 'Code Extract',
                        'tutorial': 'Tutorial',
                        'extraction': 'Extractie'
                    }[a.type] || a.type;
                    return `${engineIcon} ${typeLabel}`;
                });

                if (completed.length > 0) {
                    summaryEl.innerHTML = `<strong style="color: #10b981;">‚úì Voltooide analyses:</strong><br>${completed.join(' ‚Ä¢ ')}`;
                    summaryEl.style.display = 'block';
                } else {
                    summaryEl.style.display = 'none';
                }
            }
        }

        function handleCategoryChange() {
            const select = document.getElementById('contentCategorySelect');
            const newInput = document.getElementById('newCategoryInput');

            if (select.value === '__new__') {
                newInput.style.display = 'block';
                newInput.focus();
            } else {
                newInput.style.display = 'none';
            }
        }

        function getSelectedCategory() {
            const select = document.getElementById('contentCategorySelect');
            const newInput = document.getElementById('newCategoryInput');

            if (select.value === '__new__') {
                const newCat = newInput.value.trim();
                if (newCat) {
                    // Add to custom categories if not exists
                    if (!customCategories.includes(newCat)) {
                        customCategories.push(newCat);
                        localStorage.setItem('brain-custom-categories', JSON.stringify(customCategories));

                        // Add to dropdown for future use
                        const option = document.createElement('option');
                        option.value = newCat;
                        option.textContent = newCat;
                        select.insertBefore(option, select.querySelector('option[value="__new__"]'));
                    }
                    return newCat;
                }
                return 'YouTube Analyse';
            }
            return select.value;
        }

        function loadCustomCategories() {
            const select = document.getElementById('contentCategorySelect');
            if (!select) return;

            customCategories.forEach(cat => {
                // Check if already exists
                if (!select.querySelector(`option[value="${cat}"]`)) {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.insertBefore(option, select.querySelector('option[value="__new__"]'));
                }
            });
        }

        // Populate folder dropdowns in upload modals
        function populateFolderDropdowns() {
            const folderSelects = [
                'youtubeFolderSelect',
                'audioFolderSelect',
                'videoFolderSelect',
                'documentFolderSelect'
            ];

            const folders = Object.values(folderData);

            // Build hierarchical folder list
            const buildFolderOptions = (parentId = null, depth = 0) => {
                let options = [];
                const childFolders = folders.filter(f => f.parentId === parentId);
                childFolders.forEach(folder => {
                    const indent = '\u00A0\u00A0'.repeat(depth); // Non-breaking spaces for indent
                    options.push({
                        id: folder.id,
                        name: `${indent}${depth > 0 ? '‚îî ' : ''}üìÅ ${folder.name}`
                    });
                    // Recursively add subfolders
                    options = options.concat(buildFolderOptions(folder.id, depth + 1));
                });
                return options;
            };

            const folderOptions = buildFolderOptions();

            folderSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;

                // Clear existing options except the first one
                select.innerHTML = '<option value="">-- Geen map (root) --</option>';

                // Add folder options
                folderOptions.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    select.appendChild(option);
                });

                // Add "new folder" option
                const newOption = document.createElement('option');
                newOption.value = '__new_folder__';
                newOption.textContent = '+ Nieuwe map maken...';
                newOption.style.color = 'var(--ai-purple)';
                select.appendChild(newOption);

                // Handle new folder creation
                select.onchange = () => {
                    if (select.value === '__new_folder__') {
                        showPromptModal('Nieuwe Map', 'Naam voor de map:', 'Nieuwe Map', (name) => {
                            if (name && name.trim()) {
                                const folderId = `folder-${Date.now()}`;
                                folderData[folderId] = {
                                    id: folderId,
                                    name: name.trim(),
                                    parentId: null,
                                    createdAt: new Date().toISOString()
                                };
                                saveFolders();
                                populateFolderDropdowns();
                                select.value = folderId;
                                showToast(`Map "${name}" aangemaakt`);
                            } else {
                                select.value = ''; // Reset to root
                            }
                        });
                    }
                };
            });
        }

        // Handle folder selection change - now handled inline via onchange
        // Note: Using showPromptModal for new folder creation when __new_folder__ is selected

        function openInputModal(type) {
            currentInputType = type;
            selectedFilePath = null;
            const modal = document.getElementById('inputModal');
            const title = document.getElementById('modalTitle');

            // Load custom categories
            loadCustomCategories();

            // Populate folder dropdowns
            populateFolderDropdowns();

            // Reset new category input
            const newCatInput = document.getElementById('newCategoryInput');
            if (newCatInput) {
                newCatInput.style.display = 'none';
                newCatInput.value = '';
            }

            // Hide all sections
            document.getElementById('youtubeInputSection').style.display = 'none';
            document.getElementById('audioInputSection').style.display = 'none';
            document.getElementById('videoInputSection').style.display = 'none';
            document.getElementById('documentInputSection').style.display = 'none';
            document.getElementById('modalProgress').style.display = 'none';

            // Show relevant section
            switch (type) {
                case 'youtube':
                    title.textContent = '‚ñ∂Ô∏è YouTube Video Toevoegen';
                    document.getElementById('youtubeInputSection').style.display = 'block';
                    document.getElementById('modalSubmitBtn').textContent = 'üöÄ Analyseren';
                    // Reset to default engine (Claude CLI transcript)
                    selectedYouTubeEngine = 'transcript';
                    selectYouTubeEngine('transcript');
                    break;
                case 'audio':
                    title.textContent = 'üéôÔ∏è Audio Toevoegen';
                    document.getElementById('audioInputSection').style.display = 'block';
                    document.getElementById('modalSubmitBtn').textContent = '‚ûï Toevoegen';
                    break;
                case 'video':
                    title.textContent = 'üé• Video Bestand Toevoegen';
                    document.getElementById('videoInputSection').style.display = 'block';
                    document.getElementById('modalSubmitBtn').textContent = 'üöÄ Analyseren';
                    break;
                case 'document':
                    title.textContent = 'üìÑ Document Toevoegen';
                    document.getElementById('documentInputSection').style.display = 'block';
                    document.getElementById('modalSubmitBtn').textContent = '‚ûï Toevoegen';
                    break;
            }

            modal.classList.add('active');
            logToDevTools(`Input modal opened: ${type}`, 'info');
        }

        function closeInputModal() {
            document.getElementById('inputModal').classList.remove('active');

            // Reset inputs safely (check if elements exist)
            const resetInput = (id) => { const el = document.getElementById(id); if (el) el.value = ''; };
            const resetSelect = (id, defaultVal) => { const el = document.getElementById(id); if (el) el.value = defaultVal; };

            resetInput('youtubeUrlInput');
            resetInput('contentTitleInput');
            resetInput('audioFileInput');
            resetInput('audioTitleInput');
            resetInput('videoFileInput');
            resetInput('videoTitleInput');
            resetInput('documentTitleInput');

            // Reset selects to defaults
            resetSelect('contentCategorySelect', 'YouTube');
            resetSelect('audioCategorySelect', 'Audio');
            resetSelect('videoCategorySelect', 'Video');
            resetSelect('documentCategorySelect', 'Documenten');

            // Reset document files list
            selectedDocumentFiles = [];
            updateDocumentFilesList();

            // Reset state
            selectedFilePath = null;
            recordedBlob = null;
        }

        function selectAnalysisType(type) {
            selectedAnalysisType = type;
            document.querySelectorAll('.analysis-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
        }

        async function selectAudioFile() {
            if (window.brain?.selectFile) {
                const path = await window.brain.selectFile(['mp3', 'wav', 'm4a', 'ogg', 'flac']);
                if (path) {
                    selectedFilePath = path;
                    document.getElementById('audioFileInput').value = path.split('/').pop();
                }
            }
        }

        async function selectVideoFile() {
            if (window.brain?.selectFile) {
                const path = await window.brain.selectFile(['mp4', 'mov', 'avi', 'mkv', 'webm']);
                if (path) {
                    selectedFilePath = path;
                    document.getElementById('videoFileInput').value = path.split('/').pop();
                }
            }
        }

        async function selectDocumentFile() {
            if (window.brain?.selectFile) {
                const path = await window.brain.selectFile(['pdf', 'txt', 'md', 'doc', 'docx']);
                if (path) {
                    selectedFilePath = path;
                    document.getElementById('documentFileInput').value = path.split('/').pop();
                }
            }
        }

        // ============================================
        // DOCUMENT ANALYSIS SYSTEM
        // ============================================
        let selectedDocumentFiles = [];
        let selectedDocAnalysisType = 'technical';
        let selectedAnalysisEngine = 'claude'; // Default to Claude CLI (more powerful)

        function selectAnalysisEngine(engine) {
            selectedAnalysisEngine = engine;

            // Update button styles (in Analyze panel)
            document.querySelectorAll('[data-engine]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.engine === engine);
            });

            // Show/hide Claude options in Analyze panel
            const analyzeClaudeOptions = document.getElementById('analyzeClaudeOptions');
            if (engine === 'claude') {
                if (analyzeClaudeOptions) analyzeClaudeOptions.style.display = 'block';
            } else {
                if (analyzeClaudeOptions) analyzeClaudeOptions.style.display = 'none';
            }

            logToDevTools(`Analysis engine changed to: ${engine}`, 'info');
        }

        async function selectDocumentFiles() {
            if (window.brain?.selectFiles) {
                const paths = await window.brain.selectFiles(['pdf', 'txt', 'md', 'doc', 'docx', 'json', 'csv', 'xml', 'html']);
                if (paths && paths.length > 0) {
                    selectedDocumentFiles = [...selectedDocumentFiles, ...paths];
                    updateDocumentFilesList();
                }
            } else if (window.brain?.selectFile) {
                // Fallback to single file selection
                const path = await window.brain.selectFile(['pdf', 'txt', 'md', 'doc', 'docx', 'json', 'csv', 'xml', 'html']);
                if (path) {
                    selectedDocumentFiles.push(path);
                    updateDocumentFilesList();
                }
            }
        }

        function clearDocumentFiles() {
            selectedDocumentFiles = [];
            updateDocumentFilesList();
        }

        function removeDocumentFile(index) {
            selectedDocumentFiles.splice(index, 1);
            updateDocumentFilesList();
        }

        function updateDocumentFilesList() {
            const container = document.getElementById('documentFilesList');
            if (selectedDocumentFiles.length === 0) {
                container.innerHTML = '<span style="color: var(--text-muted);">Geen bestanden geselecteerd</span>';
            } else {
                container.innerHTML = selectedDocumentFiles.map((path, idx) => {
                    const filename = path.split('/').pop();
                    const ext = filename.split('.').pop().toUpperCase();
                    return `<div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                        <span style="background: var(--accent); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.65rem;">${ext}</span>
                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${filename}</span>
                        <button onclick="removeDocumentFile(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0.2rem;">√ó</button>
                    </div>`;
                }).join('');
            }
        }

        function selectDocAnalysisType(type) {
            selectedDocAnalysisType = type;
            document.querySelectorAll('#documentInputSection .analysis-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
        }

        // Handle persona selection change
        document.addEventListener('DOMContentLoaded', () => {
            const personaSelect = document.getElementById('documentPersonaSelect');
            const customInput = document.getElementById('customPersonaInput');
            if (personaSelect) {
                personaSelect.addEventListener('change', () => {
                    customInput.style.display = personaSelect.value === 'custom' ? 'block' : 'none';
                });
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 3-FASE DOCUMENT ANALYSE WORKFLOW
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Storage for document analyses per content item - PERSISTENT via localStorage
        const ANALYSES_STORAGE_KEY = 'brain-app-document-analyses';
        let documentAnalyses = new Map();

        // Load analyses from localStorage on startup
        function loadDocumentAnalyses() {
            try {
                const stored = localStorage.getItem(ANALYSES_STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    // Fix stuck "running" analyses - they were interrupted by app restart
                    for (const docId in data) {
                        if (data[docId].analyses) {
                            data[docId].analyses = data[docId].analyses.filter(a => {
                                // Remove analyses that were stuck in "running" state
                                if (a.status === 'running') {
                                    console.log('Removing stuck running analysis:', a.name);
                                    return false;
                                }
                                return true;
                            });
                        }
                    }
                    documentAnalyses = new Map(Object.entries(data));
                    console.log('Loaded document analyses from storage:', documentAnalyses.size, 'documents');
                    // Save cleaned data back
                    saveDocumentAnalyses();
                }
            } catch (e) {
                console.error('Error loading document analyses:', e);
                documentAnalyses = new Map();
            }
        }

        // Save analyses to localStorage
        function saveDocumentAnalyses() {
            try {
                const data = Object.fromEntries(documentAnalyses);
                localStorage.setItem(ANALYSES_STORAGE_KEY, JSON.stringify(data));
                console.log('Saved document analyses to storage');
            } catch (e) {
                console.error('Error saving document analyses:', e);
            }
        }

        // Load on startup
        loadDocumentAnalyses();

        function getDocumentAnalysisState(contentId) {
            if (!documentAnalyses.has(contentId)) {
                documentAnalyses.set(contentId, { analyses: [], summary: null });
            }
            return documentAnalyses.get(contentId);
        }

        function showNewAnalysisPanel() {
            document.getElementById('newAnalysisPanel').style.display = 'block';
        }

        function hideNewAnalysisPanel() {
            document.getElementById('newAnalysisPanel').style.display = 'none';
        }

        function updateDocAnalysesUI() {
            if (!selectedContentItem) return;

            const state = getDocumentAnalysisState(selectedContentItem.id);
            const listEl = document.getElementById('docAnalysesList');
            const summaryBtn = document.getElementById('generateSummaryBtn');
            const buildBtn = document.getElementById('buildAppBtn');
            const buildPanel = document.getElementById('buildOptionsPanel');
            const summaryStatus = document.getElementById('docSummaryStatus');
            const summaryPreview = document.getElementById('docSummaryPreview');

            // Update analyses list
            if (state.analyses.length === 0) {
                listEl.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 2rem;">
                    Nog geen analyses uitgevoerd.<br>
                    <span style="font-size: 0.8rem;">Configureer hierboven een analyse en klik op "Start Analyse"</span>
                </p>`;
            } else {
                listEl.innerHTML = state.analyses.map((analysis, idx) => {
                    const statusColors = {
                        'completed': { bg: 'rgba(34, 197, 94, 0.15)', border: '#22c55e', icon: '‚úÖ' },
                        'running': { bg: 'rgba(59, 130, 246, 0.15)', border: 'var(--ai-blue)', icon: '‚è≥' },
                        'error': { bg: 'rgba(239, 68, 68, 0.15)', border: '#ef4444', icon: '‚ùå' }
                    };
                    const colors = statusColors[analysis.status] || statusColors['running'];
                    const timestamp = analysis.timestamp ? new Date(analysis.timestamp).toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' }) : '';

                    // Badges for saved/selected status
                    const badges = [];
                    if (analysis.savedToObsidian) badges.push('<span style="background: #238636; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">üìù Obsidian</span>');
                    if (analysis.selectedForOverview) badges.push('<span style="background: var(--ai-purple); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">‚úì Overview</span>');

                    return `
                    <div class="analysis-card" style="
                        background: ${colors.bg};
                        border: 2px solid ${analysis.selectedForOverview ? 'var(--ai-purple)' : colors.border};
                        border-radius: 10px;
                        padding: 1rem;
                        cursor: ${analysis.status === 'completed' ? 'pointer' : 'default'};
                        transition: all 0.2s ease;
                        margin-bottom: 0.5rem;
                    " ${analysis.status === 'completed' ? `onclick="viewAnalysis(${idx})"` : ''}>
                        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <span style="font-size: 1.8rem;">${analysis.icon}</span>
                                <span style="font-size: 1rem;">${colors.icon}</span>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; flex-wrap: wrap;">
                                    <span style="font-weight: 600; font-size: 0.95rem; color: #e6edf3;">${analysis.name}</span>
                                    ${badges.join(' ')}
                                </div>
                                <div style="font-size: 0.75rem; color: #8b949e; display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.35rem;">
                                    <span>üïê ${timestamp}</span>
                                    ${analysis.wordCount ? `<span>üìù ${analysis.wordCount} woorden</span>` : ''}
                                </div>
                                <div style="font-size: 0.8rem; color: #58a6ff;">
                                    ${analysis.status === 'completed' ? 'üëÜ Klik om te bekijken, opslaan of selecteren' : ''}
                                    ${analysis.status === 'running' ? '<span style="color: var(--ai-blue);">‚è≥ Bezig met analyseren...</span>' : ''}
                                    ${analysis.status === 'error' ? '<span style="color: #ef4444;">‚ùå Analyse mislukt - klik voor details</span>' : ''}
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); removeAnalysis(${idx})" style="
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                color: #ef4444;
                                cursor: pointer;
                                font-size: 1rem;
                                padding: 0.3rem 0.5rem;
                                border-radius: 4px;
                                opacity: 0.7;
                                transition: opacity 0.2s;
                            " onmouseover="this.style.opacity='1';" onmouseout="this.style.opacity='0.7';" title="Verwijder analyse">üóëÔ∏è</button>
                        </div>
                    </div>
                `}).join('');
            }

            // Enable/disable summary button based on completed analyses
            const completedAnalyses = state.analyses.filter(a => a.status === 'completed');
            const hasCompletedAnalyses = completedAnalyses.length > 0;

            // Safe element access
            if (summaryBtn) summaryBtn.disabled = !hasCompletedAnalyses;

            // Update analyses count badge
            const countBadge = document.getElementById('analysesCount');
            if (countBadge) countBadge.textContent = state.analyses.length;

            // Update FASE 2 section in Overview tab
            const fase2Section = document.getElementById('docFase2Section');
            const fase2Title = document.getElementById('fase2DocTitle');
            const fase2Count = document.getElementById('fase2AnalysesCount');
            const fase2Requirement = document.getElementById('fase2RequirementNote');

            if (fase2Section && selectedContentItem) {
                fase2Section.style.display = 'block';
                if (fase2Title) fase2Title.textContent = selectedContentItem.title;
                if (fase2Count) fase2Count.textContent = `Voltooide analyses: ${completedAnalyses.length}`;
                if (fase2Requirement) fase2Requirement.style.display = hasCompletedAnalyses ? 'none' : 'block';
            }

            // Update summary preview if we have one
            if (summaryStatus && summaryPreview) {
                if (state.summary) {
                    summaryStatus.innerHTML = `<p style="color: var(--success); font-size: 0.8rem;">‚úÖ Samenvatting gegenereerd</p>`;
                    summaryPreview.style.display = 'block';
                    const summaryContent = document.getElementById('docSummaryContent');
                    if (summaryContent) summaryContent.textContent = state.summary.text || state.summary.appDescription || 'Samenvatting beschikbaar';
                } else {
                    summaryStatus.innerHTML = hasCompletedAnalyses
                        ? `<p style="color: var(--text-muted); font-size: 0.8rem;">Klik op de knop om een samenvatting te genereren.</p>`
                        : '';
                    summaryPreview.style.display = 'none';
                }
            }

            // Update FASE 3 section in Install tab
            const fase3Section = document.getElementById('docFase3Section');
            const fase3Title = document.getElementById('fase3DocTitle');
            const fase3Info = document.getElementById('fase3AnalysesInfo');
            const fase3Requirement = document.getElementById('fase3RequirementNote');

            if (fase3Section && selectedContentItem) {
                fase3Section.style.display = 'block';
                if (fase3Title) fase3Title.textContent = selectedContentItem.title;
                if (fase3Info) fase3Info.textContent = `Analyses: ${completedAnalyses.length} voltooid | Samenvatting: ${state.summary ? '‚úÖ' : '‚ùå'}`;
                if (fase3Requirement) fase3Requirement.style.display = state.summary ? 'none' : 'block';
            }

            // Enable/disable build button and panel
            if (buildBtn) buildBtn.disabled = !state.summary;
            if (buildPanel) {
                buildPanel.style.opacity = state.summary ? '1' : '0.5';
                buildPanel.style.pointerEvents = state.summary ? 'auto' : 'none';
            }
        }

        async function runNewAnalysis() {
            if (!selectedContentItem) {
                showToast('Selecteer eerst een document', 'error');
                return;
            }

            const persona = document.getElementById('newAnalysisPersona').value;
            const type = document.getElementById('newAnalysisType').value;
            const instructions = document.getElementById('newAnalysisInstructions').value;

            // Type mapping - empty string means "general analysis"
            const typeNames = {
                '': { name: 'Algemene Analyse', icon: 'üìÑ' },
                'readable': { name: 'Leesbare Analyse', icon: 'üìñ' },
                'summary': { name: 'Samenvatting', icon: 'üìù' },
                'technical': { name: 'Technische Analyse', icon: 'üîß' },
                'business': { name: 'Business Analyse', icon: 'üíº' },
                'data-extraction': { name: 'Data Extractie', icon: 'üìä' },
                'requirements': { name: 'Requirements Analyse', icon: 'üìã' },
                'risk': { name: 'Risico Analyse', icon: '‚ö†Ô∏è' },
                'implementation': { name: 'Implementatie Plan', icon: 'üöÄ' }
            };

            // Persona mapping - empty string means "general perspective"
            const personaNames = {
                '': 'Algemeen',
                'engineer': 'Burgerlijk Ingenieur',
                'developer': 'Software Developer',
                'architect': 'Software Architect',
                'analyst': 'Business Analyst',
                'researcher': 'Onderzoeker',
                'student': 'Student'
            };

            // Build analysis name based on what was selected
            let analysisName = '';
            let analysisIcon = 'üìÑ';

            if (type && persona) {
                // Both selected - show combination
                analysisName = `${typeNames[type].name} (${personaNames[persona]})`;
                analysisIcon = typeNames[type].icon;
            } else if (type) {
                // Only type selected
                analysisName = typeNames[type].name;
                analysisIcon = typeNames[type].icon;
            } else if (persona) {
                // Only persona selected
                analysisName = `Analyse door ${personaNames[persona]}`;
                analysisIcon = 'üë§';
            } else {
                // Neither selected - general analysis
                analysisName = 'Algemene Document Analyse';
                analysisIcon = 'üìÑ';
            }

            const state = getDocumentAnalysisState(selectedContentItem.id);
            const analysis = {
                id: Date.now(),
                type: type || 'general',
                persona: persona || 'general',
                name: analysisName,
                icon: analysisIcon,
                status: 'running',
                result: null,
                wordCount: 0,
                timestamp: new Date().toISOString()
            };

            state.analyses.push(analysis);
            updateDocAnalysesUI();

            // Show active analysis log
            const activeLog = document.getElementById('activeAnalysisLog');
            const activeLogName = document.getElementById('activeAnalysisName');
            const activeLogProgress = document.getElementById('activeAnalysisProgress');
            activeLog.style.display = 'block';
            activeLogName.textContent = `${analysis.icon} ${analysis.name}`;
            activeLogProgress.innerHTML = '<span>Verbinden met Claude CLI...</span>';

            // Build prompt based on combinations of persona and type
            let prompt = '';

            // Add persona context if selected
            if (persona) {
                prompt += `Je bent een ${personaNames[persona]}. Analyseer vanuit dit perspectief. `;
            }

            // Add type-specific instructions
            switch(type) {
                case 'readable':
                    prompt += `Schrijf een LEESBARE analyse van de documenten in /docs/.

BELANGRIJK - OUTPUT FORMAT:
- Schrijf in GEWONE NEDERLANDSE TEKST, GEEN code of JSON
- Schrijf in volledige zinnen en paragrafen
- GEEN code blocks, GEEN markdown tabellen, GEEN technische formatting
- Maak het geschikt om als PDF te printen

Structureer je analyse als volgt:

SAMENVATTING
Schrijf 2-3 alinea's over wat dit document behandelt.

KERNBEVINDINGEN
Beschrijf de belangrijkste punten in gewone tekst. Leg elk punt uit in 2-3 zinnen.

DETAILS EN UITLEG
Ga dieper in op de belangrijkste onderwerpen. Schrijf als een samenhangend verhaal.

CONCLUSIE
Vat de belangrijkste lessen samen.`;
                    break;
                case 'summary':
                    prompt += `Maak een duidelijke SAMENVATTING van de documenten in /docs/.
                    Schrijf in gewone tekst, geschikt voor PDF export.
                    Geef: kern boodschap, hoofdpunten, en belangrijkste conclusies.`;
                    break;
                case 'technical':
                    prompt += `Maak een GEDETAILLEERDE technische analyse van de documenten in /docs/.
                    Extraheer alle technische specificaties, parameters, normen en vereisten.
                    Structureer je output in duidelijke secties met bullet points.`;
                    break;
                case 'business':
                    prompt += `Maak een business analyse van de documenten in /docs/.
                    Identificeer kansen, risico's, stakeholders en strategische overwegingen.
                    Focus op de business value en implementatie-impact.`;
                    break;
                case 'data-extraction':
                    prompt += `Extraheer ALLE gestructureerde data uit de documenten in /docs/.
                    Output in JSON-achtige structuren waar mogelijk.
                    Identificeer tabellen, lijsten, parameters, waarden en hun relaties.`;
                    break;
                case 'requirements':
                    prompt += `Analyseer de documenten in /docs/ en extraheer alle requirements.
                    Categoriseer in: functionele requirements, niet-functionele requirements, constraints.
                    Prioriteer waar mogelijk (must-have, should-have, nice-to-have).`;
                    break;
                case 'risk':
                    prompt += `Voer een risico-analyse uit op de documenten in /docs/.
                    Identificeer technische risico's, implementatie-risico's, compliance-risico's.
                    Geef per risico: beschrijving, impact, waarschijnlijkheid, mitigatie.`;
                    break;
                case 'implementation':
                    prompt += `Maak een IMPLEMENTATIE PLAN op basis van de documenten in /docs/.
                    Beschrijf: project definitie, technologie stack, data model, stap-voor-stap plan.
                    Dit plan kan direct naar Claude Code CLI voor uitvoering.`;
                    break;
                default:
                    // No type selected - do general analysis
                    prompt += `Maak een uitgebreide analyse van de documenten in /docs/.
                    Geef een overzicht van de inhoud, belangrijkste punten en relevante details.
                    Structureer je output in duidelijke secties.`;
                    break;
            }

            if (instructions) {
                prompt += `\n\nExtra instructies: ${instructions}`;
            }

            // Analyses moeten leesbaar zijn, maar visuele formatting is toegestaan
            prompt = `=== OUTPUT FORMAT ===

Schrijf een LEESBAAR document in het Nederlands.

VERBODEN:
- Raw JSON zoals {"key": "value"}
- Ongeformatteerde data dumps

TOEGESTAAN:
- Normale tekst en paragrafen
- Markdown tabellen voor data
- Flowcharts (ASCII of Mermaid)
- Bullet points en opsommingen
- Kopjes met ## of HOOFDLETTERS
- Diagrammen waar nuttig

REGEL: Gebruik TABELLEN in plaats van JSON.

Voorbeeld GOED:
| Pad | Doel | Regulering |
|-----|------|------------|
| Plastic-to-Plastic | Nieuw plastic | SUPD, PPWR |
| Plastic-to-Fuel | Brandstof | RED III |

Voorbeeld FOUT:
{"pad_A": {"naam": "Plastic-to-Plastic", "doel": "Nieuw plastic"}}

=== START ANALYSE ===

${prompt}`;

            try {
                activeLogProgress.innerHTML = '<span>Claude CLI gestart - analyseren...</span>';
                console.log('Starting analysis with:', {
                    title: selectedContentItem.title,
                    files: selectedContentItem.files,
                    promptLength: prompt.length
                });

                // Use Claude CLI for analysis - use window.brain (not electronAPI!)
                const result = await window.brain.runClaudeWithContext({
                    title: selectedContentItem.title,
                    filePaths: selectedContentItem.files,
                    claudePrompt: prompt,
                    persona: persona,
                    goalType: 'extract-specs',
                    analysis: '',
                    buildInstructions: prompt
                });

                console.log('Analysis result received:', result);

                // Check if result indicates success
                if (result && (result.output || result.result || result.success)) {
                    activeLogProgress.innerHTML = '<span style="color: var(--success);">Analyse voltooid! Resultaat wordt verwerkt...</span>';

                    analysis.status = 'completed';
                    analysis.result = result.output || result.result || 'Analyse voltooid zonder tekst output';
                    analysis.wordCount = (analysis.result.match(/\S+/g) || []).length;
                    analysis.projectPath = result.projectPath;

                    console.log('Analysis completed:', analysis.name, 'Words:', analysis.wordCount);
                } else {
                    // Result returned but no output
                    console.warn('Analysis returned but no output:', result);
                    analysis.status = 'completed';
                    analysis.result = result.error || 'Analyse uitgevoerd - geen tekst output ontvangen';
                    analysis.wordCount = 0;
                    analysis.projectPath = result.projectPath;
                }

            } catch (error) {
                console.error('Analysis error:', error);
                activeLogProgress.innerHTML = `<span style="color: #ef4444;">Fout: ${error.message}</span>`;
                analysis.status = 'error';
                analysis.result = `Error: ${error.message}\n\nStack: ${error.stack || 'geen stack trace'}`;
            }

            // Hide active log after a short delay
            setTimeout(() => {
                activeLog.style.display = 'none';
            }, 1500);

            // SAVE analyses to persistent storage
            saveDocumentAnalyses();

            updateDocAnalysesUI();
            showToast(analysis.status === 'completed' ? `‚úÖ ${analysis.name} voltooid!` : 'Analyse mislukt', analysis.status === 'completed' ? 'success' : 'error');
        }

        function viewAnalysis(idx) {
            if (!selectedContentItem) return;
            const state = getDocumentAnalysisState(selectedContentItem.id);
            const analysis = state.analyses[idx];

            if (analysis && analysis.result) {
                // Show in a FULL-SCREEN modal with SOLID background for readability
                const modal = document.createElement('div');
                modal.id = 'analysisModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0d1117; z-index: 10000; display: flex; flex-direction: column;';

                const timestamp = analysis.timestamp ? new Date(analysis.timestamp).toLocaleString('nl-NL') : '';

                modal.innerHTML = `
                    <div style="background: #161b22; border-bottom: 1px solid #30363d; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; color: #e6edf3; font-size: 1.2rem;">${analysis.icon} ${analysis.name}</h2>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #8b949e;">
                                ${timestamp} | ${analysis.wordCount || 0} woorden | Document: ${selectedContentItem.title}
                            </p>
                        </div>
                        <button onclick="document.getElementById('analysisModal').remove()" style="background: #21262d; border: 1px solid #30363d; color: #e6edf3; font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">√ó</button>
                    </div>

                    <div style="flex: 1; overflow-y: auto; padding: 1.5rem; background: #0d1117;">
                        <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1.5rem; max-width: 900px; margin: 0 auto;">
                            <pre id="analysisContent" style="white-space: pre-wrap; font-family: 'SF Pro Text', -apple-system, sans-serif; font-size: 0.9rem; line-height: 1.8; color: #e6edf3; margin: 0;">${analysis.result}</pre>
                        </div>
                    </div>

                    <div style="background: #161b22; border-top: 1px solid #30363d; padding: 1rem 1.5rem; display: flex; gap: 0.75rem; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #8b949e; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="selectForOverview" ${analysis.selectedForOverview ? 'checked' : ''} onchange="toggleAnalysisSelection(${idx}, this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                                Selecteer voor Overview
                            </label>
                            ${analysis.savedToObsidian ? '<span style="color: #3fb950; font-size: 0.8rem;">‚úÖ Opgeslagen</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button onclick="copyAnalysisToClipboard()" class="btn" style="font-size: 0.85rem; padding: 0.6rem 1rem; background: #21262d; border: 1px solid #30363d; color: #e6edf3;">
                                üìã Kopieer
                            </button>
                            <button onclick="saveAnalysisToObsidian(${idx})" class="btn" style="font-size: 0.85rem; padding: 0.6rem 1rem; background: #238636; border: none; color: white;">
                                üìù Obsidian
                            </button>
                            <button onclick="document.getElementById('analysisModal').remove()" class="btn btn-install" style="font-size: 0.85rem; padding: 0.6rem 1rem;">
                                Sluiten
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function copyAnalysisToClipboard() {
            const content = document.getElementById('analysisContent');
            if (content) {
                navigator.clipboard.writeText(content.textContent);
                showToast('Analyse gekopieerd naar klembord!', 'success');
            }
        }

        function toggleAnalysisSelection(idx, selected) {
            if (!selectedContentItem) return;
            const state = getDocumentAnalysisState(selectedContentItem.id);
            if (state.analyses[idx]) {
                state.analyses[idx].selectedForOverview = selected;
                saveDocumentAnalyses();
                updateDocAnalysesUI();
                showToast(selected ? 'Geselecteerd voor Overview' : 'Deselecteerd', 'info');
            }
        }

        async function saveAnalysisToObsidian(idx) {
            if (!selectedContentItem) return;
            const state = getDocumentAnalysisState(selectedContentItem.id);
            const analysis = state.analyses[idx];

            if (!analysis) return;

            const filename = `${selectedContentItem.title} - ${analysis.name}`.replace(/[^a-zA-Z0-9\s-]/g, '').trim();
            const timestamp = new Date().toISOString().split('T')[0];

            const content = `# ${analysis.icon} ${analysis.name}

**Document:** ${selectedContentItem.title}
**Datum:** ${timestamp}
**Type:** ${analysis.type || 'Algemeen'}
**Perspectief:** ${analysis.persona || 'Algemeen'}
**Woorden:** ${analysis.wordCount || 0}

---

${analysis.result}

---

*Gegenereerd door Brain App met Claude CLI*
`;

            try {
                await window.brain.saveToObsidian(filename + '.md', content, 'Brain-Analyses');
                showToast('Opgeslagen in Obsidian: ' + filename, 'success');
                analysis.savedToObsidian = true;
                analysis.obsidianPath = 'Brain-Analyses/' + filename + '.md';
                saveDocumentAnalyses();

                // Refresh modal to show saved state
                document.getElementById('analysisModal').remove();
                viewAnalysis(idx);
            } catch (error) {
                console.error('Save to Obsidian error:', error);
                showToast('Opslaan naar Obsidian mislukt', 'error');
            }
        }

        function removeAnalysis(idx) {
            if (!selectedContentItem) return;
            const state = getDocumentAnalysisState(selectedContentItem.id);
            state.analyses.splice(idx, 1);
            // Invalidate summary if exists
            state.summary = null;
            // SAVE to persistent storage
            saveDocumentAnalyses();
            updateDocAnalysesUI();
        }

        async function generateDocSummary() {
            if (!selectedContentItem) return;
            const state = getDocumentAnalysisState(selectedContentItem.id);

            const completedAnalyses = state.analyses.filter(a => a.status === 'completed');
            if (completedAnalyses.length === 0) {
                showToast('Geen voltooide analyses om samen te vatten', 'error');
                return;
            }

            const summaryBtn = document.getElementById('generateSummaryBtn');
            summaryBtn.disabled = true;
            summaryBtn.textContent = '‚è≥ Genereren...';

            // Combine all analyses into one prompt
            let combinedAnalyses = completedAnalyses.map(a =>
                `=== ${a.name} ===\n${a.result}`
            ).join('\n\n---\n\n');

            const prompt = `Je hebt de volgende analyses van documenten ontvangen:

${combinedAnalyses}

Maak nu een GECONSOLIDEERDE SAMENVATTING die dient als blauwdruk voor een applicatie.

Je output moet bevatten:
1. **App Beschrijving**: Wat moet de app doen? (2-3 zinnen)
2. **Kernfunctionaliteiten**: Lijst van features die de app moet hebben
3. **Data Modellen**: Welke data-structuren zijn nodig (als TypeScript interfaces)
4. **UI Componenten**: Welke schermen/pagina's zijn nodig
5. **Technische Vereisten**: Frameworks, libraries, APIs
6. **Prioriteiten**: Wat moet eerst gebouwd worden (MVP)

Output in een gestructureerd formaat dat direct kan worden gebruikt als specificatie voor Claude CLI.`;

            try {
                const result = await window.brain.runClaudeWithContext({
                    title: selectedContentItem.title,
                    filePaths: selectedContentItem.files,
                    claudePrompt: prompt,
                    persona: 'architect',
                    goalType: 'create-plan',
                    analysis: combinedAnalyses,
                    buildInstructions: prompt
                });

                state.summary = {
                    content: result.output || result.result || result.analysis,
                    appDescription: extractAppDescription(result.output || result.result || result.analysis || ''),
                    timestamp: new Date().toISOString(),
                    projectPath: result.projectPath
                };

                // SAVE to persistent storage
                saveDocumentAnalyses();
                showToast('Samenvatting gegenereerd!', 'success');
            } catch (error) {
                console.error('Summary error:', error);
                showToast('Samenvatting genereren mislukt', 'error');
            }

            summaryBtn.disabled = false;
            summaryBtn.textContent = 'üìä Genereer Samenvatting';
            updateDocAnalysesUI();
        }

        function extractAppDescription(text) {
            // Try to extract app description from summary
            const match = text.match(/App Beschrijving[:\s]*([^\n]+(?:\n(?![#*\d])[^\n]+)*)/i);
            if (match) return match[1].trim().substring(0, 200) + '...';
            return text.substring(0, 200) + '...';
        }

        // Helper functions for FASE 2
        function copySummaryToClipboard() {
            const content = document.getElementById('docSummaryContent');
            if (content) {
                navigator.clipboard.writeText(content.textContent);
                showToast('Samenvatting gekopieerd!', 'success');
            }
        }

        function copySpecsToClipboard() {
            const content = document.getElementById('docSpecsContent');
            if (content) {
                navigator.clipboard.writeText(content.textContent);
                showToast('Specificaties gekopieerd!', 'success');
            }
        }

        async function extractDocSpecs() {
            if (!selectedContentItem) return;
            const state = getDocumentAnalysisState(selectedContentItem.id);

            const completedAnalyses = state.analyses.filter(a => a.status === 'completed');
            if (completedAnalyses.length === 0) {
                showToast('Geen voltooide analyses beschikbaar', 'error');
                return;
            }

            const specsBtn = document.getElementById('extractSpecsBtn');
            const specsStatus = document.getElementById('docSpecsStatus');
            if (specsBtn) {
                specsBtn.disabled = true;
                specsBtn.textContent = '‚è≥ Extraheren...';
            }

            let combinedAnalyses = completedAnalyses.map(a =>
                `=== ${a.name} ===\n${a.result}`
            ).join('\n\n---\n\n');

            const prompt = `Analyseer de volgende documenten en EXTRAHEER alle TECHNISCHE SPECIFICATIES:

${combinedAnalyses}

Geef ALLEEN een gestructureerde lijst van:
1. **Technische Parameters**: Alle getallen, maten, gewichten, toleranties
2. **Normen & Standaarden**: Alle referenties naar ISO, NEN, EU-richtlijnen
3. **Requirements**: Functionele en niet-functionele eisen
4. **Constraints**: Beperkingen en randvoorwaarden
5. **Data Structuren**: Identificeer welke data moet worden opgeslagen/verwerkt

Output als een overzichtelijke JSON-achtige structuur of bullet list.`;

            try {
                const result = await window.brain.runClaudeWithContext({
                    title: selectedContentItem.title + ' - Specs',
                    filePaths: selectedContentItem.files,
                    claudePrompt: prompt,
                    persona: 'engineer',
                    goalType: 'extract-specs',
                    analysis: combinedAnalyses,
                    buildInstructions: prompt
                });

                state.specs = {
                    content: result.output || result.result || 'Specificaties ge√´xtraheerd',
                    timestamp: new Date().toISOString()
                };

                // Update UI
                const specsPreview = document.getElementById('docSpecsPreview');
                const specsContent = document.getElementById('docSpecsContent');
                if (specsPreview && specsContent) {
                    specsPreview.style.display = 'block';
                    specsContent.textContent = state.specs.content;
                }
                if (specsStatus) specsStatus.innerHTML = `<p style="color: var(--success); font-size: 0.8rem;">‚úÖ Specificaties ge√´xtraheerd</p>`;

                saveDocumentAnalyses();
                showToast('Specificaties ge√´xtraheerd!', 'success');
            } catch (error) {
                console.error('Specs extraction error:', error);
                if (specsStatus) specsStatus.innerHTML = `<p style="color: #ef4444; font-size: 0.8rem;">‚ùå Extractie mislukt</p>`;
                showToast('Specificaties extraheren mislukt', 'error');
            }

            if (specsBtn) {
                specsBtn.disabled = false;
                specsBtn.textContent = 'üîß Extraheer Specificaties';
            }
        }

        // Helper functions for FASE 3
        let lastBuildPath = null;

        function openBuildFolder() {
            if (lastBuildPath) {
                window.brain.openProjectFolder(lastBuildPath);
            }
        }

        function openBuildInTerminal() {
            if (lastBuildPath) {
                window.brain.openTerminalInProject(lastBuildPath);
            }
        }

        async function buildAppFromAnalysis() {
            if (!selectedContentItem) return;
            const state = getDocumentAnalysisState(selectedContentItem.id);

            if (!state.summary) {
                showToast('Genereer eerst een samenvatting in de Overview tab', 'error');
                return;
            }

            // Get values from new element IDs
            const appType = document.getElementById('buildAppType')?.value || 'web-app';
            const techStack = document.getElementById('buildTechStack')?.value || '';
            const extraInstructions = document.getElementById('buildInstructions')?.value || '';

            const buildBtn = document.getElementById('buildAppBtn');
            const buildLog = document.getElementById('activeBuildLog');
            const buildProgress = document.getElementById('activeBuildProgress');

            if (buildBtn) {
                buildBtn.disabled = true;
                buildBtn.innerHTML = '‚è≥ Bouwen...';
            }
            if (buildLog) buildLog.style.display = 'block';
            if (buildProgress) buildProgress.innerHTML = '<span>Verbinden met Claude CLI...</span>';

            const appTypeNames = {
                'web-app': 'moderne web applicatie',
                'electron': 'desktop applicatie met Electron',
                'api': 'backend API server',
                'cli': 'command-line interface tool',
                'dashboard': 'interactief data dashboard',
                'automation': 'automatisering script'
            };

            const prompt = `Op basis van de volgende specificaties, BOUW een complete ${appTypeNames[appType] || 'applicatie'}.

=== SPECIFICATIES ===
${state.summary.content}

${techStack ? `\n=== TECH STACK ===\n${techStack}` : ''}

=== INSTRUCTIES ===
1. Maak een COMPLETE, WERKENDE applicatie
2. Gebruik moderne best practices
3. Maak het visueel aantrekkelijk met goede UI/UX
4. Voeg alle benodigde configuratie bestanden toe (package.json, tsconfig, etc.)
5. De app moet direct runbaar zijn met "npm install && npm run dev"

${extraInstructions ? `EXTRA INSTRUCTIES: ${extraInstructions}` : ''}

Begin nu met bouwen. Maak ALLE benodigde bestanden.`;

            try {
                if (buildProgress) buildProgress.innerHTML = '<span>Claude CLI gestart - bouwen...</span>';

                const result = await window.brain.runClaudeWithContext({
                    title: selectedContentItem.title + ' - App Build',
                    filePaths: selectedContentItem.files,
                    claudePrompt: prompt,
                    persona: 'architect',
                    goalType: 'build-app',
                    analysis: state.summary.content,
                    buildInstructions: prompt
                });

                // Show build result
                const buildResult = document.getElementById('buildResult');
                const buildResultPath = document.getElementById('buildResultPath');

                if (result.projectPath) {
                    lastBuildPath = result.projectPath;
                    if (buildResult) buildResult.style.display = 'block';
                    if (buildResultPath) buildResultPath.textContent = `Project pad: ${result.projectPath}`;
                    if (buildProgress) buildProgress.innerHTML = '<span style="color: var(--success);">Build voltooid!</span>';
                    showToast(`App gebouwd in: ${result.projectPath}`, 'success');
                } else {
                    if (buildProgress) buildProgress.innerHTML = '<span style="color: var(--success);">Build voltooid!</span>';
                    showToast('App build voltooid!', 'success');
                }
            } catch (error) {
                console.error('Build error:', error);
                if (buildProgress) buildProgress.innerHTML = `<span style="color: #ef4444;">Fout: ${error.message}</span>`;
                showToast('Build mislukt: ' + error.message, 'error');
            }

            // Hide build log after delay
            setTimeout(() => {
                if (buildLog) buildLog.style.display = 'none';
            }, 2000);

            if (buildBtn) {
                buildBtn.disabled = false;
                buildBtn.innerHTML = 'üöÄ Start App Building';
            }
        }

        // Override showDocumentAnalysisSection to update UI
        const originalShowDocumentAnalysisSection = typeof showDocumentAnalysisSection === 'function' ? showDocumentAnalysisSection : null;

        function showDocumentAnalysisSectionOverride() {
            if (originalShowDocumentAnalysisSection) originalShowDocumentAnalysisSection();
            updateDocAnalysesUI();
        }

        function getPersonaDescription() {
            const select = document.getElementById('documentPersonaSelect');
            const customInput = document.getElementById('customPersonaInput');

            if (select.value === 'custom') {
                return customInput.value.trim() || 'Software Developer';
            }

            const personas = {
                'developer': 'Software Developer met focus op clean code en best practices',
                'engineer': 'Burgerlijk Ingenieur met technische en analytische achtergrond',
                'architect': 'Software Architect met focus op systeem design en schaalbaarheid',
                'analyst': 'Business Analyst met focus op requirements en processen',
                'student': 'Student die wil leren en concepten wil begrijpen',
                'entrepreneur': 'Ondernemer met focus op business value en MVP development',
                'researcher': 'Onderzoeker met focus op diepgaande analyse en documentatie'
            };

            return personas[select.value] || 'Software Developer';
        }

        function getGoalDescription() {
            const select = document.getElementById('documentGoalSelect');
            const goals = {
                'understand': 'Maak een duidelijke uitleg zodat ik de inhoud volledig begrijp',
                'build-app': 'Extraheer alle informatie die nodig is om een werkende applicatie te bouwen',
                'extract-specs': 'Haal alle technische specificaties, requirements en constraints eruit',
                'create-plan': 'Maak een stap-voor-stap implementatieplan met concrete taken',
                'claude-prompt': 'Genereer een complete prompt die ik kan gebruiken in Claude Code CLI om dit project te bouwen'
            };
            return goals[select.value] || goals['understand'];
        }

        // ============================================
        // AUDIO/VIDEO RECORDING
        // ============================================
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStream = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let recordedBlob = null;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        async function startAudioRecording() {
            try {
                recordingStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(recordingStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    document.getElementById('audioFileInput').value = `opname-${timestamp}.webm`;
                    document.getElementById('audioTitleInput').value = `Audio Opname ${new Date().toLocaleDateString('nl-NL')}`;
                    logToDevTools('Audio recording saved', 'success');
                };

                mediaRecorder.start(1000);
                recordingSeconds = 0;
                document.getElementById('recordingTime').textContent = '00:00';
                document.getElementById('audioRecordingControls').style.display = 'block';
                document.getElementById('recordAudioBtn').style.display = 'none';

                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    document.getElementById('recordingTime').textContent = formatTime(recordingSeconds);
                }, 1000);

                logToDevTools('Audio recording started', 'info');

            } catch (error) {
                showToast('Fout: ' + error.message);
                logToDevTools('Audio recording error: ' + error.message, 'error');
            }
        }

        function stopAudioRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            clearInterval(recordingTimer);
            document.getElementById('audioRecordingControls').style.display = 'none';
            document.getElementById('recordAudioBtn').style.display = 'block';
            showToast('Opname gestopt');
        }

        function cancelAudioRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            clearInterval(recordingTimer);
            recordedChunks = [];
            recordedBlob = null;
            document.getElementById('audioRecordingControls').style.display = 'none';
            document.getElementById('recordAudioBtn').style.display = 'block';
            document.getElementById('audioFileInput').value = '';
            showToast('Opname geannuleerd');
        }

        async function startVideoRecording() {
            try {
                recordingStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = recordingStream;

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(recordingStream, {
                    mimeType: 'video/webm;codecs=vp9,opus'
                });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(recordedChunks, { type: 'video/webm' });
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    document.getElementById('videoFileInput').value = `video-${timestamp}.webm`;
                    document.getElementById('videoTitleInput').value = `Video Opname ${new Date().toLocaleDateString('nl-NL')}`;
                    logToDevTools('Video recording saved', 'success');
                };

                mediaRecorder.start(1000);
                recordingSeconds = 0;
                document.getElementById('videoRecordingTime').textContent = '00:00';
                document.getElementById('videoRecordingControls').style.display = 'block';
                document.getElementById('recordVideoBtn').style.display = 'none';

                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    document.getElementById('videoRecordingTime').textContent = formatTime(recordingSeconds);
                }, 1000);

                logToDevTools('Video recording started', 'info');

            } catch (error) {
                showToast('Fout: ' + error.message);
                logToDevTools('Video recording error: ' + error.message, 'error');
            }
        }

        function stopVideoRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            clearInterval(recordingTimer);
            document.getElementById('videoPreview').srcObject = null;
            document.getElementById('videoRecordingControls').style.display = 'none';
            document.getElementById('recordVideoBtn').style.display = 'block';
            showToast('Opname gestopt');
        }

        function cancelVideoRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            clearInterval(recordingTimer);
            recordedChunks = [];
            recordedBlob = null;
            document.getElementById('videoPreview').srcObject = null;
            document.getElementById('videoRecordingControls').style.display = 'none';
            document.getElementById('recordVideoBtn').style.display = 'block';
            document.getElementById('videoFileInput').value = '';
            showToast('Opname geannuleerd');
        }

        // ============================================
        // SIMPLIFIED CONTENT SUBMISSION (No Analysis)
        // ============================================
        async function submitInputContent() {
            try {
                if (currentInputType === 'youtube') {
                    const url = document.getElementById('youtubeUrlInput').value.trim();
                    const customTitle = document.getElementById('contentTitleInput').value.trim();
                    const selectedCategory = getSelectedCategory();
                    const selectedFolderId = document.getElementById('youtubeFolderSelect')?.value || null;

                    if (!url) {
                        showToast('Voer een YouTube URL in');
                        return;
                    }

                    // Extract video ID from URL
                    const videoIdMatch = url.match(/(?:v=|\/)([\w-]{11})(?:\?|&|$)/);
                    const videoId = videoIdMatch ? videoIdMatch[1] : 'unknown';

                    // Create content entry (no analysis yet)
                    const newContent = {
                        id: `content-${Date.now()}`,
                        type: 'youtube',
                        title: customTitle || `YouTube Video ${videoId}`,
                        date: new Date().toLocaleDateString('nl-NL'),
                        category: selectedCategory,
                        badges: ['YouTube', selectedCategory],
                        summary: 'Nog niet geanalyseerd - ga naar Analyseer tab',
                        youtubeUrl: url,
                        youtubeId: videoId,
                        status: 'pending',
                        items: [],
                        folderId: selectedFolderId || null
                    };

                    videoData[newContent.id] = newContent;
                    await saveAllContentToStorage();

                    closeInputModal();
                    renderVideoList();
                    selectVideo(newContent.id);
                    showToast('YouTube video toegevoegd! Ga naar Analyseer tab om te analyseren.');

                } else if (currentInputType === 'audio') {
                    const title = document.getElementById('audioTitleInput').value.trim();
                    const category = document.getElementById('audioCategorySelect')?.value || 'Audio';
                    const selectedFolderId = document.getElementById('audioFolderSelect')?.value || null;

                    if (!selectedFilePath && !recordedBlob) {
                        showToast('Selecteer een audiobestand of maak een opname');
                        return;
                    }

                    const newContent = {
                        id: `content-${Date.now()}`,
                        type: 'audio',
                        title: title || (recordedBlob ? 'Audio Opname' : 'Audio bestand'),
                        date: new Date().toLocaleDateString('nl-NL'),
                        category: category,
                        badges: recordedBlob ? ['Opname', category] : ['Audio', category],
                        summary: 'Nog niet geanalyseerd - ga naar Analyseer tab',
                        filePath: selectedFilePath,
                        status: 'pending',
                        items: [],
                        folderId: selectedFolderId || null
                    };

                    if (recordedBlob) {
                        newContent.audioData = { isRecording: true, blob: recordedBlob, blobUrl: URL.createObjectURL(recordedBlob) };
                    }

                    videoData[newContent.id] = newContent;
                    await saveAllContentToStorage();

                    recordedBlob = null;
                    selectedFilePath = null;
                    closeInputModal();
                    renderVideoList();
                    showToast('Audio toegevoegd! Ga naar Analyseer tab om te analyseren.');

                } else if (currentInputType === 'video') {
                    const title = document.getElementById('videoTitleInput').value.trim();
                    const category = document.getElementById('videoCategorySelect')?.value || 'Video';
                    const selectedFolderId = document.getElementById('videoFolderSelect')?.value || null;

                    if (!selectedFilePath && !recordedBlob) {
                        showToast('Selecteer of neem een video op');
                        return;
                    }

                    const newContent = {
                        id: `content-${Date.now()}`,
                        type: 'video',
                        title: title || `Video ${new Date().toLocaleDateString('nl-NL')}`,
                        date: new Date().toLocaleDateString('nl-NL'),
                        category: category,
                        badges: recordedBlob ? ['Opname', 'Video'] : ['Video'],
                        summary: 'Nog niet geanalyseerd',
                        filePath: selectedFilePath,
                        status: 'pending',
                        items: [],
                        folderId: selectedFolderId || null
                    };

                    if (recordedBlob) {
                        newContent.videoData = { isRecording: true, blob: recordedBlob, blobUrl: URL.createObjectURL(recordedBlob) };
                    }

                    videoData[newContent.id] = newContent;
                    await saveAllContentToStorage();

                    recordedBlob = null;
                    closeInputModal();
                    renderVideoList();
                    showToast('Video toegevoegd! Ga naar Analyseer tab om te analyseren.');

                } else if (currentInputType === 'document') {
                    const title = document.getElementById('documentTitleInput').value.trim();
                    const category = document.getElementById('documentCategorySelect')?.value || 'Documenten';
                    const selectedFolderId = document.getElementById('documentFolderSelect')?.value || null;

                    if (selectedDocumentFiles.length === 0) {
                        showToast('Selecteer minimaal √©√©n document');
                        return;
                    }

                    // Make a copy of the file paths (important!)
                    const filePaths = [...selectedDocumentFiles];
                    const fileNames = filePaths.map(f => f.split('/').pop());

                    const newContent = {
                        id: `content-${Date.now()}`,
                        type: 'document',
                        title: title || fileNames[0] || 'Documenten',
                        date: new Date().toLocaleDateString('nl-NL'),
                        category: category,
                        badges: ['Document', category],
                        summary: `${fileNames.length} bestand(en): ${fileNames.join(', ').substring(0, 100)}`,
                        filePaths: filePaths, // Use the copy
                        status: 'pending',
                        items: [],
                        folderId: selectedFolderId || null
                    };

                    videoData[newContent.id] = newContent;
                    await saveAllContentToStorage();

                    // Reset document files BEFORE closing modal
                    selectedDocumentFiles = [];

                    closeInputModal();
                    renderVideoList();
                    selectVideo(newContent.id);
                    showToast('Document(en) toegevoegd! Ga naar Analyseer tab om te analyseren.');
                }
            } catch (error) {
                showToast('Fout: ' + error.message);
                logToDevTools('Submit error: ' + error.message, 'error');
            }
        }

        // ============================================
        // ANALYZE SELECTED CONTENT (From Analyze Tab)
        // ============================================

        // Helper function to update progress bar and percentage
        function updateAnalysisProgress(percent) {
            const bar = document.getElementById('analyzeProgressBar');
            const pct = document.getElementById('analyzeProgressPercent');
            const rounded = Math.round(percent);
            if (bar) bar.style.width = `${rounded}%`;
            if (pct) pct.textContent = `${rounded}%`;
        }

        // Helper function to update modal progress bar and percentage
        function updateModalProgress(percent) {
            const bar = document.getElementById('modalProgressBar');
            const pct = document.getElementById('modalProgressPercent');
            const rounded = Math.round(percent);
            if (bar) bar.style.width = `${rounded}%`;
            if (pct) pct.textContent = `${rounded}%`;
        }

        async function analyzeSelectedContent() {
            if (!selectedVideoId || !videoData[selectedVideoId]) {
                showToast('Selecteer eerst content in de sidebar');
                return;
            }

            const content = videoData[selectedVideoId];
            const progressSection = document.getElementById('analysisProgressSection');
            const progressBar = document.getElementById('analyzeProgressBar');
            const progressMessage = document.getElementById('analyzeProgressMessage');
            const progressIcon = document.getElementById('analyzeProgressIcon');
            const progressDetail = document.getElementById('analyzeProgressDetail');
            const progressPercent = document.getElementById('analyzeProgressPercent');

            // Reset progress
            progressBar.style.width = '0%';
            if (progressPercent) progressPercent.textContent = '0%';

            // Hide all analysis sections, show progress
            document.getElementById('noContentSelected').style.display = 'none';
            document.getElementById('youtubeAnalysisSection').style.display = 'none';
            document.getElementById('documentAnalysisSection').style.display = 'none';
            document.getElementById('videoAudioAnalysisSection').style.display = 'none';
            progressSection.style.display = 'block';

            try {
                if (content.type === 'youtube') {
                    await analyzeYouTubeContent(content, progressBar, progressMessage, progressIcon, progressDetail);
                } else if (content.type === 'document') {
                    await analyzeDocumentContent(content, progressBar, progressMessage, progressIcon, progressDetail);
                } else if (content.type === 'video' || content.type === 'audio') {
                    await analyzeVideoAudioContent(content, progressBar, progressMessage, progressIcon, progressDetail);
                }
            } catch (error) {
                progressSection.style.display = 'none';
                showToast('Analyse fout: ' + error.message);
                logToDevTools('Analysis error: ' + error.message, 'error');
                updateAnalyzePanel(content.type);
            }
        }

        // YouTube Analysis from Analyze tab
        async function analyzeYouTubeContent(content, progressBar, progressMessage, progressIcon, progressDetail) {
            const useVisualAnalysis = selectedYouTubeEngine === 'visual';
            const context = document.getElementById('analyzeContextInput')?.value.trim() || '';

            logToDevTools(`Analyzing YouTube: ${content.youtubeUrl} (Engine: ${selectedYouTubeEngine})`, 'info');

            let result;

            if (useVisualAnalysis) {
                progressMessage.textContent = 'Visuele video analyse starten (Gemini)...';
                progressIcon.textContent = 'üì•';

                const videoQuality = document.getElementById('analyzeVideoQualitySelect')?.value || '1080';
                const chunkMinutes = parseInt(document.getElementById('analyzeChunkDurationSelect')?.value || '10');

                window.brain.onAnalysisProgress((progressData) => {
                    if (progressData.stage === 'download') progressIcon.textContent = 'üì•';
                    else if (progressData.stage === 'split') progressIcon.textContent = '‚úÇÔ∏è';
                    else if (progressData.stage === 'analyze') progressIcon.textContent = 'üîç';
                    else if (progressData.stage === 'merge') progressIcon.textContent = 'üìù';
                    else if (progressData.stage === 'complete') progressIcon.textContent = '‚úÖ';
                    progressMessage.textContent = progressData.message;
                    updateAnalysisProgress(progressData.progress);
                    if (progressData.currentChunk) {
                        progressDetail.textContent = `Segment ${progressData.currentChunk} van ${progressData.totalChunks}`;
                    }
                });

                result = await window.brain.analyzeYouTubeFull({
                    url: content.youtubeUrl,
                    analysisType: selectedAnalysisType,
                    quality: videoQuality,
                    chunkMinutes: chunkMinutes
                });

                window.brain.removeAnalysisProgressListener();
                if (result.success) {
                    result.engine = 'gemini-visual';
                    result.analysisMethod = 'visual-frames';
                }
            } else {
                progressMessage.textContent = 'Transcript ophalen...';
                progressIcon.textContent = 'üìù';
                updateAnalysisProgress(10);

                const cliStatus = await window.brain.checkClaudeCLI();
                if (!cliStatus.available) throw new Error('Claude Code CLI is niet ge√Ønstalleerd');

                const transcriptResult = await window.brain.getYouTubeTranscript(content.youtubeUrl);
                if (!transcriptResult.success) throw new Error(transcriptResult.error || 'Kon transcript niet ophalen');

                updateAnalysisProgress(30);
                progressMessage.textContent = 'Claude CLI analyseren...';
                progressIcon.textContent = 'ü§ñ';

                let claudePrompt = `Analyseer dit YouTube video transcript:\n\nVIDEO: ${content.title}\nTRANSCRIPT:\n${transcriptResult.transcript}\n\n`;
                if (selectedAnalysisType === 'technical-deepdive') claudePrompt += `Maak een COMPLETE technische deep-dive.`;
                else if (selectedAnalysisType === 'code-extraction') claudePrompt += `Extraheer ALLE code en commando's.`;
                else if (selectedAnalysisType === 'tutorial') claudePrompt += `Maak een stap-voor-stap tutorial.`;
                else claudePrompt += `Maak een volledige analyse met samenvatting.`;
                if (context) claudePrompt += `\n\nExtra context: ${context}`;

                let fullOutput = '';
                window.brain.onClaudeStream((data) => {
                    if (data.content) { fullOutput += data.content; progressMessage.textContent = `Claude analyseert: ${fullOutput.length} karakters...`; }
                    if (data.progress) updateAnalysisProgress(30 + (data.progress * 0.6));
                });

                const claudeResult = await window.brain.runClaudeAgent({ prompt: claudePrompt, allowedTools: ['Read'], permissionMode: 'bypassPermissions' });
                window.brain.removeClaudeListeners();

                if (claudeResult.success) {
                    result = { success: true, analysis: claudeResult.output || fullOutput, title: content.title, transcript: transcriptResult.transcript, engine: 'claude-cli', analysisMethod: 'transcript-claude' };
                } else throw new Error(claudeResult.error || 'Claude analyse mislukt');
            }

            if (result.success) {
                // Store analyses per type+engine combination
                if (!content.analyses) content.analyses = {};
                const analysisKey = `${selectedAnalysisType}_${result.engine}`;
                content.analyses[analysisKey] = {
                    analysis: result.analysis,
                    type: selectedAnalysisType,
                    engine: result.engine,
                    method: result.analysisMethod,
                    date: new Date().toISOString(),
                    segments: result.segments || [] // Store timeline segments
                };

                // Keep backward compatibility
                content.fullAnalysis = result.analysis;
                content.transcript = result.transcript;
                content.engine = result.engine;
                content.analysisMethod = result.analysisMethod;
                content.lastAnalysisType = selectedAnalysisType;
                content.segments = result.segments || []; // Store segments for timeline
                content.videoId = result.videoId; // Store videoId for YouTube links
                content.videoDuration = result.videoInfo?.duration || 0;
                content.status = 'analyzed';
                content.badges = [result.engine === 'claude-cli' ? 'Claude CLI' : 'Gemini', selectedAnalysisType, content.category];
                content.items = extractCodeItems(result.analysis || '');
                updateContentInStorage(content);
                document.getElementById('analysisProgressSection').style.display = 'none';
                displayAnalysisResultsInPanel(result);
                renderVideoList();
                renderOverviewPanel(selectedVideoId); // Refresh overview with timeline
                updateAnalysisButtonStates(content); // Update button colors
                showToast(`Video geanalyseerd met ${result.engine === 'claude-cli' ? 'Claude CLI' : 'Gemini'} (${selectedAnalysisType})!`);
            } else throw new Error(result.error || 'Analyse mislukt');
        }

        // Document Analysis from Analyze tab
        async function analyzeDocumentContent(content, progressBar, progressMessage, progressIcon, progressDetail) {
            const persona = document.getElementById('analyzeDocPersonaSelect')?.value || 'developer';
            const goalType = document.getElementById('analyzeDocGoalSelect')?.value || 'understand';
            const extraInstructions = document.getElementById('analyzeDocInstructionsInput')?.value.trim() || '';
            const useClaudeCLI = selectedAnalysisEngine === 'claude';
            const buildDirectly = document.getElementById('analyzeClaudeBuildToggle')?.checked || false;

            progressMessage.textContent = 'Documenten verwerken...';
            progressIcon.textContent = 'üìÑ';
            updateAnalysisProgress(10);

            const filesToAnalyze = content.filePaths || [];
            if (filesToAnalyze.length === 0) throw new Error('Geen bestanden om te analyseren');

            let result;

            if (useClaudeCLI) {
                const cliStatus = await window.brain.checkClaudeCLI();
                if (!cliStatus.available) throw new Error('Claude Code CLI is niet ge√Ønstalleerd');

                updateAnalysisProgress(20);
                progressMessage.textContent = 'Claude CLI analyseren...';
                progressIcon.textContent = 'ü§ñ';

                let claudePrompt = `Analyseer de documenten in /docs/ en `;
                if (goalType === 'build-app' || buildDirectly) claudePrompt += `bouw een complete applicatie.`;
                else if (goalType === 'extract-specs') claudePrompt += `extraheer alle technische specificaties.`;
                else if (goalType === 'create-plan') claudePrompt += `maak een gedetailleerd implementatieplan.`;
                else claudePrompt += `maak een duidelijke samenvatting.`;
                if (extraInstructions) claudePrompt += ` ${extraInstructions}`;

                let fullOutput = '';
                window.brain.onClaudeStream((data) => {
                    if (data.data?.message?.content) {
                        const text = data.data.message.content.filter(c => c.type === 'text').map(c => c.text).join('');
                        fullOutput += text;
                        progressMessage.textContent = `Claude werkt: ${fullOutput.length} karakters...`;
                    }
                    if (data.progress) updateAnalysisProgress(20 + (data.progress * 0.7));
                });

                // runClaudeWithContext now handles both export AND running Claude
                const claudeResult = await window.brain.runClaudeWithContext({
                    title: content.title,
                    filePaths: filesToAnalyze,
                    persona: persona,
                    goalType: goalType,
                    claudePrompt: claudePrompt
                });
                window.brain.removeClaudeListeners();

                if (claudeResult.success) result = { success: true, analysis: claudeResult.output || fullOutput, engine: 'claude-cli', projectPath: claudeResult.projectPath };
                else throw new Error(claudeResult.error || 'Claude analyse mislukt');
            } else {
                progressMessage.textContent = 'Gemini analyseren...';
                progressIcon.textContent = '‚ö°';
                result = await window.brain.analyzeDocuments({ filePaths: filesToAnalyze, analysisType: selectedDocAnalysisType, persona: persona, goal: goalType, extraInstructions: extraInstructions });
            }

            if (result.success) {
                content.fullAnalysis = result.analysis;
                content.engine = result.engine || 'gemini';
                content.status = 'analyzed';
                content.projectPath = result.projectPath;
                content.badges = [content.engine === 'claude-cli' ? 'Claude CLI' : 'Gemini', selectedDocAnalysisType, content.category];
                content.items = extractCodeItems(result.analysis || '');
                updateContentInStorage(content);
                document.getElementById('analysisProgressSection').style.display = 'none';
                displayAnalysisResultsInPanel(result);
                renderVideoList();
                showToast(`Document geanalyseerd met ${content.engine === 'claude-cli' ? 'Claude CLI' : 'Gemini'}!`);
            } else throw new Error(result.error || 'Analyse mislukt');
        }

        // Video/Audio Analysis from Analyze tab
        async function analyzeVideoAudioContent(content, progressBar, progressMessage, progressIcon, progressDetail) {
            progressMessage.textContent = 'Video/audio analyseren met Gemini...';
            progressIcon.textContent = 'üëÅÔ∏è';
            updateAnalysisProgress(20);

            const filePath = content.filePath;
            if (!filePath) throw new Error('Geen bestand beschikbaar voor analyse');

            const result = await window.brain.analyzeLocalVideo({ filePath: filePath, analysisType: selectedAnalysisType });

            if (result.success) {
                content.fullAnalysis = result.analysis;
                content.engine = 'gemini';
                content.status = 'analyzed';
                content.badges = ['Gemini', selectedAnalysisType, content.category];
                content.items = extractCodeItems(result.analysis || '');
                updateContentInStorage(content);
                document.getElementById('analysisProgressSection').style.display = 'none';
                displayAnalysisResultsInPanel(result);
                renderVideoList();
                showToast('Video/audio geanalyseerd met Gemini!');
            } else throw new Error(result.error || 'Analyse mislukt');
        }

        // Helper: Update content in storage (electron-store via IPC + localStorage backup)
        async function updateContentInStorage(content) {
            try {
                const savedContent = JSON.parse(localStorage.getItem('brain-custom-videos') || '[]');
                const index = savedContent.findIndex(c => c.id === content.id);
                if (index >= 0) savedContent[index] = content;
                else savedContent.push(content);
                // Save to localStorage as backup
                localStorage.setItem('brain-custom-videos', JSON.stringify(savedContent));
                // Save to electron-store via IPC (primary - reliable)
                try {
                    await window.brain.saveCustomContent(savedContent);
                    console.log('Content saved to electron-store:', savedContent.length, 'items');
                } catch (ipcError) {
                    console.error('Error saving to electron-store:', ipcError);
                }
            } catch (error) {
                logToDevTools('Error updating storage: ' + error.message, 'error');
            }
        }

        // Helper: Save all current content to both localStorage and electron-store
        async function saveAllContentToStorage() {
            try {
                // Get all custom content (non-example items)
                const customContent = Object.values(videoData).filter(v => v.id && !v.id.startsWith('example-'));
                // Save to localStorage as backup
                localStorage.setItem('brain-custom-videos', JSON.stringify(customContent));
                // Save to electron-store via IPC (primary - reliable)
                try {
                    await window.brain.saveCustomContent(customContent);
                    console.log('All content saved to electron-store:', customContent.length, 'items');
                } catch (ipcError) {
                    console.error('Error saving all content to electron-store:', ipcError);
                }
            } catch (error) {
                logToDevTools('Error saving all content: ' + error.message, 'error');
            }
        }

        // Helper: Display results in Analyze panel - NOW UNIFIED with state.analyses[] card system
        function displayAnalysisResultsInPanel(result) {
            // Hide old legacy section - we now use the unified card system
            const oldSection = document.getElementById('analysisResultsSection');
            if (oldSection) oldSection.style.display = 'none';

            // Only add to state.analyses if we have a selectedContentItem (document context)
            if (selectedContentItem && selectedContentItem.id) {
                const state = getDocumentAnalysisState(selectedContentItem.id);

                // Check if this analysis already exists (to avoid duplicates on page refresh)
                const engineLabel = result.engine === 'claude-cli' ? 'Claude CLI' : (result.engine || 'Gemini');
                const analysisName = `${engineLabel} Analyse`;

                // Look for existing legacy analysis OR analysis with same name
                const existingIdx = state.analyses.findIndex(a =>
                    (a.isLegacy && a.status === 'completed') ||
                    (a.name === analysisName && a.status === 'completed')
                );

                if (existingIdx >= 0) {
                    // Update existing analysis - keep original name if it was legacy
                    state.analyses[existingIdx].result = result.analysis;
                    state.analyses[existingIdx].wordCount = (result.analysis || '').split(/\s+/).length;
                    state.analyses[existingIdx].timestamp = new Date().toISOString();
                    // Update engine info if available
                    if (result.engine) {
                        state.analyses[existingIdx].engine = result.engine;
                    }
                    console.log('Updated existing legacy analysis at index', existingIdx);
                } else {
                    // Add as new analysis card - this is the "Originele Analyse" from fullAnalysis
                    const analysis = {
                        id: 'legacy_' + Date.now(),
                        name: `üìÑ Originele ${engineLabel} Analyse`,
                        icon: result.engine === 'claude-cli' ? 'ü§ñ' : '‚ö°',
                        status: 'completed',
                        result: result.analysis,
                        wordCount: (result.analysis || '').split(/\s+/).length,
                        timestamp: new Date().toISOString(),
                        engine: result.engine || 'unknown',
                        isLegacy: true // Mark as legacy/original analysis
                    };
                    // Add at the BEGINNING so it appears first (as it was the first analysis done)
                    state.analyses.unshift(analysis);
                    console.log('Added new legacy analysis card:', analysis.name);
                }

                // Save state and update UI
                saveDocumentAnalyses();
                updateDocAnalysesUI();
            } else {
                // Fallback for non-document content (YouTube, video, audio) - show in old section
                const section = document.getElementById('analysisResultsSection');
                const metadata = document.getElementById('analysisMetadata');
                const resultsContent = document.getElementById('analysisResults');

                if (section && metadata && resultsContent) {
                    metadata.innerHTML = `<strong>Engine:</strong> ${result.engine || 'unknown'} | <strong>Datum:</strong> ${new Date().toLocaleDateString('nl-NL')}`;

                    let formattedContent = result.analysis || 'Geen resultaten';

                    // Make segment headers clickable (links to YouTube timestamp)
                    const content = videoData[selectedVideoId];
                    if (content && content.videoId) {
                        formattedContent = formattedContent.replace(
                            /# SEGMENT (\d+) \((\d{2}:\d{2}:\d{2}) - (\d{2}:\d{2}:\d{2})\)/g,
                            (match, segNum, startTime, endTime) => {
                                const seconds = timeToSeconds(startTime);
                                return `<div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0; padding: 0.5rem; background: var(--bg-dark); border-radius: 8px;">
                                    <button onclick="openYouTubeAt('${content.videoId}', ${seconds})" style="background: var(--ai-blue); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                        ‚ñ∂ ${startTime}
                                    </button>
                                    <span style="font-weight: bold; font-size: 1.1rem;">SEGMENT ${segNum}</span>
                                    <span style="color: var(--text-muted); font-size: 0.85rem;">${startTime} - ${endTime}</span>
                                </div>`;
                            }
                        );
                    }

                    formattedContent = formattedContent.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="code-block"><code class="language-$1">$2</code></pre>');
                    formattedContent = formattedContent.replace(/\n/g, '<br>');

                    resultsContent.innerHTML = formattedContent;
                    section.style.display = 'block';
                }
            }
        }

        // Helper to convert time string to seconds
        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            }
            return 0;
        }

        // Helper: Cancel analysis
        function cancelAnalysis() {
            if (window.brain?.removeClaudeListeners) window.brain.removeClaudeListeners();
            if (window.brain?.removeAnalysisProgressListener) window.brain.removeAnalysisProgressListener();
            document.getElementById('analysisProgressSection').style.display = 'none';
            if (selectedVideoId && videoData[selectedVideoId]) updateAnalyzePanel(videoData[selectedVideoId].type);
            showToast('Analyse geannuleerd');
        }

        // OLD FUNCTION - KEPT FOR REFERENCE (will be removed later)
        async function submitInputContent_OLD() {
            const progress = document.getElementById('modalProgress');
            const progressBar = document.getElementById('modalProgressBar');
            const progressText = document.getElementById('modalProgressText');

            try {
                if (currentInputType === 'youtube') {
                    const url = document.getElementById('youtubeUrlInput').value.trim();
                    const customTitle = document.getElementById('contentTitleInput').value.trim();
                    const context = document.getElementById('contextInput')?.value?.trim() || '';
                    const useVisualAnalysis = selectedYouTubeEngine === 'visual';
                    const videoQuality = document.getElementById('videoQualitySelect')?.value || '1080';
                    const chunkMinutes = parseInt(document.getElementById('chunkDurationSelect')?.value || '10');

                    if (!url) {
                        showToast('Voer een YouTube URL in');
                        return;
                    }

                    // Show progress
                    progress.style.display = 'block';
                    progressBar.style.width = '5%';

                    logToDevTools(`Analyzing YouTube: ${url} (Engine: ${selectedYouTubeEngine})`, 'info');

                    let result;

                    if (useVisualAnalysis) {
                        // ==========================================
                        // GEMINI - Visuele Video Analyse
                        // ==========================================
                        progressText.textContent = 'Visuele video analyse starten (Gemini)...';

                        // Show full analysis progress UI
                        const fullProgress = document.getElementById('fullAnalysisProgress');
                        if (fullProgress) fullProgress.style.display = 'block';

                        // Set up progress listener
                        window.brain.onAnalysisProgress((progressData) => {
                            const progressIcon = document.getElementById('progressIcon');
                            const progressMessage = document.getElementById('progressMessage');
                            const progressBarFull = document.getElementById('progressBar');
                            const progressDetail = document.getElementById('progressDetail');

                            if (progressIcon) {
                                if (progressData.stage === 'download') progressIcon.textContent = 'üì•';
                                else if (progressData.stage === 'split') progressIcon.textContent = '‚úÇÔ∏è';
                                else if (progressData.stage === 'analyze') progressIcon.textContent = 'üîç';
                                else if (progressData.stage === 'merge') progressIcon.textContent = 'üìù';
                                else if (progressData.stage === 'complete') progressIcon.textContent = '‚úÖ';
                            }
                            if (progressMessage) progressMessage.textContent = progressData.message;
                            if (progressBarFull) progressBarFull.style.width = `${progressData.progress}%`;
                            if (progressDetail && progressData.currentChunk) {
                                progressDetail.textContent = `Segment ${progressData.currentChunk} van ${progressData.totalChunks}`;
                            }

                            // Also update modal progress
                            progressBar.style.width = `${Math.min(95, progressData.progress * 0.9)}%`;
                            progressText.textContent = progressData.message;
                        });

                        // Call full video analysis with Gemini
                        result = await window.brain.analyzeYouTubeFull({
                            url: url,
                            analysisType: selectedAnalysisType,
                            quality: videoQuality,
                            chunkMinutes: chunkMinutes
                        });

                        // Clean up listener
                        window.brain.removeAnalysisProgressListener();

                        if (result.success) {
                            result.engine = 'gemini-visual';
                            result.analysisMethod = 'visual-frames';
                        }
                    } else {
                        // ==========================================
                        // CLAUDE CLI - Transcript Analyse (Default)
                        // ==========================================
                        progressText.textContent = 'Transcript ophalen...';

                        // Check if Claude CLI is available
                        const cliStatus = await window.brain.checkClaudeCLI();
                        if (!cliStatus.available) {
                            throw new Error('Claude Code CLI is niet ge√Ønstalleerd. Installeer met: npm install -g @anthropic-ai/claude-code');
                        }

                        progressBar.style.width = '15%';

                        // Get YouTube transcript first
                        const transcriptResult = await window.brain.getYouTubeTranscript(url);
                        if (!transcriptResult.success) {
                            throw new Error(transcriptResult.error || 'Kon transcript niet ophalen');
                        }

                        progressBar.style.width = '30%';
                        progressText.textContent = 'Claude CLI analyseren...';

                        // Extract video ID from URL
                        const videoIdMatch = url.match(/(?:v=|\/)([\w-]{11})(?:\?|&|$)/);
                        const videoId = videoIdMatch ? videoIdMatch[1] : 'unknown';

                        // Build Claude prompt based on analysis type
                        let claudePrompt = `Analyseer dit YouTube video transcript:\n\n`;
                        claudePrompt += `VIDEO: ${customTitle || url}\n`;
                        claudePrompt += `TRANSCRIPT:\n${transcriptResult.transcript}\n\n`;

                        if (selectedAnalysisType === 'technical-deepdive') {
                            claudePrompt += `Maak een COMPLETE technische deep-dive met:
1. Alle technische concepten uitgelegd
2. Code voorbeelden en commando's die genoemd worden
3. Setup instructies en configuraties
4. Dependencies en tools
5. Best practices en tips
${context ? `\nExtra context: ${context}` : ''}`;
                        } else if (selectedAnalysisType === 'code-extraction') {
                            claudePrompt += `Extraheer ALLE code, commando's en technische instructies uit dit transcript.
Format als uitvoerbare snippets met uitleg.
${context ? `\nExtra context: ${context}` : ''}`;
                        } else if (selectedAnalysisType === 'tutorial') {
                            claudePrompt += `Maak een stap-voor-stap tutorial gebaseerd op deze video.
Inclusief alle instructies, tips en waarschuwingen.
${context ? `\nExtra context: ${context}` : ''}`;
                        } else {
                            claudePrompt += `Maak een volledige analyse met samenvatting, hoofdpunten en conclusies.
${context ? `\nExtra context: ${context}` : ''}`;
                        }

                        // Set up streaming listener
                        let fullOutput = '';
                        window.brain.onClaudeStream((data) => {
                            if (data.content) {
                                fullOutput += data.content;
                                progressText.textContent = `Claude analyseert: ${fullOutput.length} karakters...`;
                            }
                            if (data.progress) {
                                progressBar.style.width = `${30 + (data.progress * 0.6)}%`;
                            }
                        });

                        // Run Claude CLI
                        const claudeResult = await window.brain.runClaudeAgent({
                            prompt: claudePrompt,
                            allowedTools: ['Read'],
                            permissionMode: 'bypassPermissions'
                        });

                        // Clean up listener
                        window.brain.removeClaudeListeners();

                        if (claudeResult.success) {
                            result = {
                                success: true,
                                analysis: claudeResult.output || fullOutput,
                                title: customTitle || transcriptResult.title || `YouTube ${videoId}`,
                                videoId: videoId,
                                transcript: transcriptResult.transcript,
                                engine: 'claude-cli',
                                analysisMethod: 'transcript-claude'
                            };
                        } else {
                            throw new Error(claudeResult.error || 'Claude analyse mislukt');
                        }
                    }

                    progressBar.style.width = '95%';
                    progressText.textContent = 'Resultaten verwerken...';

                    if (result.success) {
                        // Get selected category
                        const selectedCategory = getSelectedCategory();

                        // Determine engine badge
                        const engineBadge = result.engine === 'claude-cli' ? 'Claude CLI' : 'Gemini';
                        const methodBadge = result.analysisMethod === 'visual-frames' ? 'Visueel' : 'Transcript';

                        // Add to content library
                        const newContent = {
                            id: `content-${Date.now()}`,
                            type: 'youtube',
                            title: customTitle || result.title || `YouTube Video ${result.videoId}`,
                            date: new Date().toLocaleDateString('nl-NL'),
                            category: selectedCategory,
                            badges: [engineBadge, selectedAnalysisType, methodBadge, selectedCategory],
                            summary: result.analysis?.substring(0, 300) + '...',
                            youtubeId: result.videoId,
                            fullAnalysis: result.analysis,
                            transcript: result.transcript,
                            videoInfo: result.videoInfo,
                            chunksAnalyzed: result.chunksAnalyzed,
                            analysisMethod: result.analysisMethod || 'transcript',
                            engine: result.engine,
                            items: extractCodeItems(result.analysis || '')
                        };

                        videoData[newContent.id] = newContent;

                        // Save to electron-store and localStorage
                        await saveAllContentToStorage();

                        progressBar.style.width = '100%';
                        progressText.textContent = 'Klaar!';

                        setTimeout(() => {
                            closeInputModal();
                            renderVideoList();
                            selectVideo(newContent.id);
                            const engineName = result.engine === 'claude-cli' ? 'Claude CLI' : 'Gemini';
                            const method = result.analysisMethod === 'visual-frames' ? `Visueel (${result.chunksAnalyzed} segmenten)` : 'Transcript';
                            showToast(`Video geanalyseerd met ${engineName}! (${method})`);
                            logToDevTools(`Content added: ${newContent.title} - ${engineName} ${method}`, 'success');
                        }, 500);
                    } else {
                        throw new Error(result.error || 'Analyse mislukt');
                    }
                } else if (currentInputType === 'audio') {
                    const title = document.getElementById('audioTitleInput').value.trim();
                    const desc = document.getElementById('audioDescInput').value.trim();

                    if (!title) {
                        showToast('Voer een titel in');
                        return;
                    }

                    // Check if we have a recorded blob or a file path
                    let audioData = null;
                    if (recordedBlob) {
                        // Save recorded blob
                        audioData = {
                            isRecording: true,
                            blob: recordedBlob,
                            blobUrl: URL.createObjectURL(recordedBlob)
                        };
                    }

                    const newContent = {
                        id: `content-${Date.now()}`,
                        type: 'audio',
                        title: title,
                        date: new Date().toLocaleDateString('nl-NL'),
                        category: recordedBlob ? 'Audio Opname' : 'Audio',
                        badges: recordedBlob ? ['Opname', 'Audio'] : ['Audio'],
                        summary: desc || (recordedBlob ? 'Live audio opname' : 'Audio bestand'),
                        filePath: selectedFilePath,
                        audioData: audioData,
                        items: []
                    };

                    videoData[newContent.id] = newContent;
                    await saveAllContentToStorage();

                    recordedBlob = null; // Reset
                    closeInputModal();
                    renderVideoList();
                    showToast('Audio toegevoegd!');
                } else if (currentInputType === 'video') {
                    const title = document.getElementById('videoTitleInput').value.trim();

                    // Check for recorded video or file
                    if (!selectedFilePath && !recordedBlob) {
                        showToast('Selecteer of neem een video op');
                        return;
                    }

                    // If we have a recorded blob but no file, use the recording
                    if (recordedBlob && !selectedFilePath) {
                        const newContent = {
                            id: `content-${Date.now()}`,
                            type: 'video',
                            title: title || `Video Opname ${new Date().toLocaleDateString('nl-NL')}`,
                            date: new Date().toLocaleDateString('nl-NL'),
                            category: 'Video Opname',
                            badges: ['Opname', 'Video'],
                            summary: 'Live video opname',
                            videoData: {
                                isRecording: true,
                                blob: recordedBlob,
                                blobUrl: URL.createObjectURL(recordedBlob)
                            },
                            items: []
                        };

                        videoData[newContent.id] = newContent;
                        await saveAllContentToStorage();

                        recordedBlob = null;
                        closeInputModal();
                        renderVideoList();
                        showToast('Video opname toegevoegd!');
                        return;
                    }

                    if (!selectedFilePath) {
                        showToast('Selecteer een video bestand');
                        return;
                    }

                    progress.style.display = 'block';
                    progressBar.style.width = '10%';
                    progressText.textContent = 'Video analyseren...';

                    // Analyze local video with Gemini
                    const result = await window.brain.analyzeLocalVideo({
                        filePath: selectedFilePath,
                        analysisType: selectedAnalysisType
                    });

                    if (result.success) {
                        const newContent = {
                            id: `content-${Date.now()}`,
                            type: 'video',
                            title: title || selectedFilePath.split('/').pop(),
                            date: new Date().toLocaleDateString('nl-NL'),
                            category: 'Video Analyse',
                            badges: ['Gemini', 'Local Video'],
                            summary: result.analysis?.substring(0, 300) + '...',
                            filePath: selectedFilePath,
                            fullAnalysis: result.analysis,
                            items: extractCodeItems(result.analysis || '')
                        };

                        videoData[newContent.id] = newContent;
                        await saveAllContentToStorage();

                        closeInputModal();
                        renderVideoList();
                        selectVideo(newContent.id);
                        showToast('Video geanalyseerd en toegevoegd!');
                    } else {
                        throw new Error(result.error || 'Analyse mislukt');
                    }
                } else if (currentInputType === 'document') {
                    const title = document.getElementById('documentTitleInput').value.trim();
                    const persona = getPersonaDescription();
                    const goal = getGoalDescription();
                    const extraInstructions = document.getElementById('documentInstructionsInput')?.value.trim() || '';
                    const generateClaudePrompt = document.getElementById('generateClaudePromptToggle')?.checked || false;
                    const goalType = document.getElementById('documentGoalSelect')?.value || 'understand';
                    const useClaudeCLI = selectedAnalysisEngine === 'claude';

                    logToDevTools(`Document analysis started. Engine: ${selectedAnalysisEngine}, Files: ${selectedDocumentFiles.length}`, 'info');

                    if (selectedDocumentFiles.length === 0 && !selectedFilePath) {
                        showToast('Selecteer minimaal √©√©n document');
                        return;
                    }

                    // Use new multi-file array or fallback to single file
                    const filesToAnalyze = selectedDocumentFiles.length > 0 ? selectedDocumentFiles : [selectedFilePath];

                    // Show progress
                    progress.style.display = 'block';
                    progressBar.style.width = '10%';

                    let result;

                    if (useClaudeCLI) {
                        // ==========================================
                        // CLAUDE CODE CLI ANALYSE (Krachtig)
                        // ==========================================
                        progressText.textContent = 'Claude CLI voorbereiden...';
                        logToDevTools(`Using Claude CLI for analysis. Goal: ${goalType}`, 'info');

                        // Check if Claude CLI is available
                        const cliStatus = await window.brain.checkClaudeCLI();
                        if (!cliStatus.available) {
                            throw new Error('Claude Code CLI is niet ge√Ønstalleerd. Installeer met: npm install -g @anthropic-ai/claude-code');
                        }

                        progressBar.style.width = '20%';
                        progressText.textContent = 'Project exporteren voor Claude...';

                        // First export project structure
                        const fileNames = filesToAnalyze.map(f => f.split('/').pop()).join(', ');
                        const projectTitle = title || fileNames.substring(0, 40);

                        const exportResult = await window.brain.exportToClaudeCode({
                            title: projectTitle,
                            analysis: `Documenten voor analyse: ${fileNames}`,
                            filePaths: filesToAnalyze,
                            persona: persona,
                            goalType: goalType,
                            date: new Date().toLocaleDateString('nl-NL')
                        });

                        if (!exportResult.success) {
                            throw new Error(exportResult.error || 'Export mislukt');
                        }

                        progressBar.style.width = '40%';
                        progressText.textContent = 'Claude CLI analyseren en bouwen...';

                        // Build the Claude prompt based on goal
                        let claudePrompt = `Analyseer de documenten in /docs/ en `;
                        if (goalType === 'build-app' || generateClaudePrompt) {
                            claudePrompt += `bouw een complete applicatie op basis van de specificaties. Mijn rol is: ${persona}. ${extraInstructions || ''}`;
                        } else if (goalType === 'extract-specs') {
                            claudePrompt += `extraheer alle technische specificaties, requirements en constraints. ${extraInstructions || ''}`;
                        } else if (goalType === 'create-plan') {
                            claudePrompt += `maak een gedetailleerd implementatieplan met concrete taken. ${extraInstructions || ''}`;
                        } else {
                            claudePrompt += `maak een duidelijke samenvatting zodat ik de inhoud begrijp. ${extraInstructions || ''}`;
                        }

                        // Set up streaming listener
                        let fullOutput = '';
                        window.brain.onClaudeStream((data) => {
                            if (data.content) {
                                fullOutput += data.content;
                                progressText.textContent = `Claude werkt: ${fullOutput.length} karakters...`;
                            }
                            if (data.progress) {
                                progressBar.style.width = `${40 + (data.progress * 0.5)}%`;
                            }
                        });

                        // Run Claude with context
                        const claudeResult = await window.brain.runClaudeWithContext({
                            prompt: claudePrompt,
                            projectPath: exportResult.projectPath,
                            allowedTools: ['Read', 'Write', 'Edit', 'Glob', 'Grep'],
                            permissionMode: 'default'
                        });

                        // Clean up listener
                        window.brain.removeClaudeListeners();

                        if (claudeResult.success) {
                            result = {
                                success: true,
                                analysis: claudeResult.output || fullOutput,
                                generatedTitle: projectTitle,
                                claudePrompt: claudePrompt,
                                projectPath: exportResult.projectPath,
                                engine: 'claude-cli'
                            };
                        } else {
                            throw new Error(claudeResult.error || 'Claude analyse mislukt');
                        }

                    } else {
                        // ==========================================
                        // GEMINI ANALYSE (Snel)
                        // ==========================================
                        progressText.textContent = 'Documenten analyseren met Gemini...';
                        logToDevTools(`Using Gemini for analysis. Goal: ${goalType}`, 'info');

                        result = await window.brain.analyzeDocuments({
                            files: filesToAnalyze,
                            analysisType: selectedDocAnalysisType,
                            persona: persona,
                            goal: goal,
                            goalType: goalType,
                            extraInstructions: extraInstructions,
                            generateClaudePrompt: generateClaudePrompt
                        });

                        if (result.success) {
                            result.engine = 'gemini';
                        }
                    }

                    logToDevTools(`Document analysis result: success=${result.success}, engine=${result.engine}, hasAnalysis=${!!result.analysis}`, result.success ? 'success' : 'error');

                    progressBar.style.width = '80%';
                    progressText.textContent = 'Resultaten verwerken...';

                    if (result.success) {
                        // Get selected category - use AI-generated category based on content
                        let selectedCategory = getSelectedCategory();

                        // If default category, try to use a smarter default based on goalType
                        if (selectedCategory === 'YouTube Analyse' || !selectedCategory) {
                            if (goalType === 'build-app' || goalType === 'claude-prompt') {
                                selectedCategory = 'AI Development';
                            } else if (goalType === 'extract-specs') {
                                selectedCategory = 'Documentatie';
                            } else {
                                selectedCategory = 'Documenten';
                            }
                        }

                        const fileNames = filesToAnalyze.map(f => f.split('/').pop()).join(', ');

                        // Use priority: user title > AI generated title > fallback
                        const finalTitle = title || result.generatedTitle || (filesToAnalyze.length > 1 ? `${filesToAnalyze.length} Documenten Analyse` : filesToAnalyze[0].split('/').pop());

                        const newContent = {
                            id: `content-${Date.now()}`,
                            type: 'document',
                            title: finalTitle,
                            date: new Date().toLocaleDateString('nl-NL'),
                            category: selectedCategory,
                            badges: [result.engine === 'claude-cli' ? 'Claude CLI' : 'Gemini', selectedDocAnalysisType, generateClaudePrompt ? 'Claude Prompt' : '', selectedCategory].filter(Boolean),
                            summary: result.analysis?.substring(0, 300) + '...',
                            filePaths: filesToAnalyze,
                            fullAnalysis: result.analysis,
                            claudePrompt: result.claudePrompt,
                            projectPath: result.projectPath,
                            persona: persona,
                            goalType: goalType,
                            analysisMethod: result.engine === 'claude-cli' ? 'claude-cli-analysis' : 'gemini-analysis',
                            items: extractCodeItems(result.analysis || '')
                        };

                        logToDevTools(`Saving content: id=${newContent.id}, title=${newContent.title}, category=${newContent.category}, engine=${result.engine}`, 'info');

                        // Add to in-memory data
                        videoData[newContent.id] = newContent;

                        // Save to electron-store and localStorage
                        try {
                            await saveAllContentToStorage();
                            logToDevTools(`Saved to electron-store. Total items: ${Object.values(videoData).filter(v => v.id && !v.id.startsWith('example-')).length}`, 'success');
                        } catch (storageError) {
                            logToDevTools(`Storage error: ${storageError.message}`, 'error');
                            // Content is still in memory, continue
                        }

                        progressBar.style.width = '100%';
                        progressText.textContent = 'Klaar!';

                        setTimeout(() => {
                            closeInputModal();
                            renderVideoList();
                            selectVideo(newContent.id);

                            // Show success message with engine info
                            if (result.engine === 'claude-cli' && result.projectPath) {
                                showToast(`‚úÖ Claude CLI analyse compleet! Project: ${result.projectPath.split('/').pop()}`);
                                // Optionally open the project folder
                                if (confirm(`Analyse voltooid!\n\nProject locatie: ${result.projectPath}\n\nWil je de project folder openen?`)) {
                                    window.brain.openProjectFolder(result.projectPath);
                                }
                            } else {
                                showToast(`${filesToAnalyze.length} document(en) geanalyseerd en opgeslagen in "${selectedCategory}"!`);
                            }

                            logToDevTools(`Documents analyzed and saved: ${fileNames} (engine: ${result.engine})`, 'success');

                            // Clear selected files
                            selectedDocumentFiles = [];
                        }, 500);
                    } else {
                        logToDevTools(`Analysis failed: ${result?.error || 'Unknown error'}`, 'error');
                        throw new Error(result?.error || 'Document analyse mislukt');
                    }
                }
            } catch (error) {
                progress.style.display = 'none';
                showToast('Fout: ' + error.message);
                logToDevTools('Document analysis error: ' + error.message + '\n' + (error.stack || ''), 'error');
                console.error('Full error:', error);
                // Clean up Claude listeners if active
                if (window.brain?.removeClaudeListeners) {
                    window.brain.removeClaudeListeners();
                }
            }
        }

        // ============================================
        // CLAUDE CODE CLI EXPORT
        // ============================================
        async function exportToClaudeCodeCLI(videoId) {
            const video = videoData[videoId];
            if (!video) {
                showToast('Content niet gevonden');
                return;
            }

            try {
                showToast('Project exporteren...');
                logToDevTools('Exporting to Claude Code CLI...', 'info');

                const result = await window.brain.exportToClaudeCode({
                    title: video.title,
                    analysis: video.fullAnalysis,
                    claudePrompt: video.claudePrompt,
                    filePaths: video.filePaths || [],
                    persona: video.persona,
                    goalType: video.goalType,
                    date: video.date
                });

                if (result.success) {
                    showToast(`Project ge√´xporteerd naar: ${result.projectPath}`);
                    logToDevTools(`Exported to: ${result.projectPath}`, 'success');

                    // Show instructions
                    const instructions = `
üì¶ Project ge√´xporteerd!

üìÅ Locatie: ${result.projectPath}

üöÄ Om te starten in Claude Code CLI:
1. Open terminal
2. cd "${result.projectPath}"
3. claude

Het project bevat:
- CLAUDE.md (instructies voor Claude)
- PROJECT_CONTEXT.md (volledige analyse)
- /docs/ (originele documenten)
${result.claudePromptFile ? '- PROMPT.txt (kant-en-klare prompt)' : ''}
                    `;

                    alert(instructions);
                } else {
                    throw new Error(result.error || 'Export mislukt');
                }
            } catch (error) {
                showToast('Export fout: ' + error.message);
                logToDevTools('Export error: ' + error.message, 'error');
            }
        }

        async function copyClaudePrompt(videoId) {
            const video = videoData[videoId];
            if (!video) {
                showToast('Content niet gevonden');
                return;
            }

            const prompt = video.claudePrompt || video.fullAnalysis?.substring(0, 2000);
            if (!prompt) {
                showToast('Geen prompt beschikbaar');
                return;
            }

            try {
                await navigator.clipboard.writeText(prompt);
                showToast('Claude prompt gekopieerd naar klembord!');
                logToDevTools('Claude prompt copied to clipboard', 'success');
            } catch (error) {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = prompt;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Claude prompt gekopieerd!');
            }
        }

        // ============================================
        // CLAUDE CODE CLI INTEGRATION
        // ============================================
        let activeClaudeProcess = null;
        let currentProjectPath = null;

        // Store CLI status globally
        let claudeCliStatus = { available: false, path: null, version: null };

        // Check Claude CLI availability on page load
        async function checkClaudeCLIStatus() {
            try {
                const result = await window.brain.checkClaudeCLI();
                claudeCliStatus = result;

                // Update header indicator
                const headerDot = document.getElementById('cliStatusDot');
                const headerLabel = document.getElementById('cliStatusLabel');

                // Update install panel indicator (if exists)
                const statusIcon = document.getElementById('claudeCliStatusIcon');
                const statusText = document.getElementById('claudeCliStatusText');

                if (result.available) {
                    // Header indicator - green
                    if (headerDot) {
                        headerDot.className = 'status-dot status-connected';
                    }
                    if (headerLabel) {
                        headerLabel.textContent = 'CLI ‚úì';
                        headerLabel.style.color = '#10b981';
                    }

                    // Install panel
                    if (statusIcon) statusIcon.textContent = '‚úÖ';
                    if (statusText) statusText.textContent = `Claude CLI beschikbaar (${result.path})`;
                    logToDevTools('Claude CLI found: ' + result.path, 'success');
                } else {
                    // Header indicator - red
                    if (headerDot) {
                        headerDot.className = 'status-dot status-disconnected';
                    }
                    if (headerLabel) {
                        headerLabel.textContent = 'CLI ‚úó';
                        headerLabel.style.color = '#ef4444';
                    }

                    // Install panel
                    if (statusIcon) statusIcon.textContent = '‚ùå';
                    if (statusText) statusText.innerHTML = `Claude CLI niet gevonden. <a href="#" onclick="showClaudeInstallInstructions()">Installatie instructies</a>`;
                    logToDevTools('Claude CLI not found', 'warning');
                }
            } catch (error) {
                logToDevTools('Error checking Claude CLI: ' + error.message, 'error');
            }
        }

        // Show Claude CLI details popup
        function showClaudeCliDetails() {
            if (claudeCliStatus.available) {
                alert(`‚úÖ Claude Code CLI is ge√Ønstalleerd!

Locatie: ${claudeCliStatus.path}

Je kunt nu:
‚Ä¢ Documenten analyseren en direct bouwen
‚Ä¢ Ga naar een document ‚Üí Installeer tab ‚Üí "Start Bouwen"

Brain App gebruikt Claude CLI om automatisch apps te genereren op basis van je geanalyseerde documenten.`);
            } else {
                const install = confirm(`‚ùå Claude Code CLI is niet ge√Ønstalleerd.

Om de volledige kracht van Brain App te gebruiken heb je Claude Code CLI nodig.

Wil je de installatie instructies zien?`);

                if (install) {
                    showClaudeInstallInstructions();
                }
            }
        }

        function showClaudeInstallInstructions() {
            alert(`Claude Code CLI Installatie:

1. Zorg dat je Node.js hebt ge√Ønstalleerd
2. Open terminal en run:
   npm install -g @anthropic-ai/claude-code

3. Log in met je Anthropic account:
   claude login

4. Herstart Brain App

Meer info: https://claude.ai/code`);
        }

        // System Stats Monitoring
        let systemStats = { cpu: 0, memory: 0 };
        let systemStatsInterval = null;

        async function updateSystemStats() {
            try {
                const stats = await window.brain.getSystemStats();
                systemStats = stats;

                const dot = document.getElementById('sysStatusDot');
                const label = document.getElementById('sysStatusLabel');

                if (dot && label) {
                    // Determine status color based on load
                    const maxLoad = Math.max(stats.cpu, stats.memory);

                    dot.className = 'status-dot';
                    if (maxLoad >= 80) {
                        dot.classList.add('status-disconnected'); // Red - high load
                        label.textContent = `${maxLoad}%`;
                    } else if (maxLoad >= 50) {
                        dot.classList.add('status-checking'); // Orange/yellow - medium load
                        label.textContent = `${maxLoad}%`;
                    } else {
                        dot.classList.add('status-connected'); // Green - low load
                        label.textContent = 'OK';
                    }
                }
            } catch (error) {
                console.error('Error getting system stats:', error);
            }
        }

        function startSystemStatsMonitoring() {
            // Update immediately
            updateSystemStats();
            // Then every 5 seconds
            systemStatsInterval = setInterval(updateSystemStats, 5000);
        }

        function showSystemStats() {
            const s = systemStats;
            alert(`üñ•Ô∏è Systeem Status

CPU Belasting: ${s.cpu}% (Load: ${s.loadAvg})
Geheugen: ${s.memory}% (${s.memUsedGB}GB / ${s.memTotalGB}GB)
CPU Cores: ${s.cpuCount}

${s.cpu >= 80 || s.memory >= 80 ? '‚ö†Ô∏è HOGE BELASTING - Sluit onnodige apps' :
  s.cpu >= 50 || s.memory >= 50 ? '‚ö° MEDIUM BELASTING' :
  '‚úÖ SYSTEEM DRAAIT GOED'}

Tips voor MacBook Air:
‚Ä¢ Sluit ongebruikte browser tabs
‚Ä¢ Sluit Claude Desktop als je Brain App gebruikt
‚Ä¢ Check Activity Monitor voor zware processen`);
        }

        async function startClaudeBuild(videoId) {
            const video = videoData[videoId];
            if (!video) {
                showToast('Content niet gevonden');
                return;
            }

            // Get extra build instructions
            const buildInstructions = document.getElementById('buildInstructionsInput')?.value.trim() || '';

            // Show output section
            const outputSection = document.getElementById(`claudeBuildOutput-${videoId}`);
            const outputDiv = document.getElementById(`claudeOutput-${videoId}`);
            if (outputSection) outputSection.style.display = 'block';
            if (outputDiv) outputDiv.textContent = 'üöÄ Project voorbereiden...\n';

            // Disable start button
            const startBtn = document.getElementById(`startBuildBtn-${videoId}`);
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.innerHTML = '‚è≥ Bezig...';
            }

            logToDevTools('Starting Claude build for: ' + video.title, 'info');

            try {
                // First, prepare the project
                const prepResult = await window.brain.runClaudeWithContext({
                    title: video.title,
                    analysis: video.fullAnalysis,
                    claudePrompt: video.claudePrompt,
                    filePaths: video.filePaths || [],
                    persona: video.persona,
                    goalType: video.goalType,
                    buildInstructions: buildInstructions
                });

                if (!prepResult.success) {
                    throw new Error(prepResult.error || 'Project voorbereiding mislukt');
                }

                currentProjectPath = prepResult.projectPath;
                if (outputDiv) outputDiv.textContent += `üìÅ Project map: ${prepResult.projectPath}\n\n`;

                // Set up streaming listeners
                window.brain.onClaudeStream((data) => {
                    if (outputDiv) {
                        if (data.type === 'text') {
                            outputDiv.textContent += data.data + '\n';
                        } else if (data.type === 'assistant' || data.type === 'message') {
                            const content = data.data?.message?.content || data.data;
                            if (typeof content === 'string') {
                                outputDiv.textContent += content;
                            } else if (Array.isArray(content)) {
                                content.forEach(c => {
                                    if (c.type === 'text') outputDiv.textContent += c.text;
                                });
                            }
                        } else if (data.type === 'error') {
                            outputDiv.textContent += `‚ö†Ô∏è ${data.data}\n`;
                        }
                        outputDiv.scrollTop = outputDiv.scrollHeight;
                    }
                });

                window.brain.onClaudeComplete((result) => {
                    if (result.success) {
                        if (outputDiv) outputDiv.textContent += '\n\n‚úÖ Build voltooid!\n';
                        showToast('Claude build voltooid!');
                        logToDevTools('Claude build completed', 'success');
                    } else {
                        if (outputDiv) outputDiv.textContent += `\n\n‚ùå Build mislukt: ${result.error || 'Onbekende fout'}\n`;
                        showToast('Build mislukt');
                        logToDevTools('Claude build failed: ' + (result.error || 'Unknown'), 'error');
                    }

                    // Show project path button
                    const pathDiv = document.getElementById(`claudeProjectPath-${videoId}`);
                    if (pathDiv && currentProjectPath) {
                        pathDiv.style.display = 'block';
                    }

                    // Re-enable start button
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.innerHTML = 'üèóÔ∏è Start Bouwen met Claude';
                    }

                    // Clean up listeners
                    window.brain.removeClaudeListeners();
                    activeClaudeProcess = null;
                });

                // Now run Claude
                if (outputDiv) outputDiv.textContent += 'ü§ñ Claude starten...\n\n';

                const runResult = await window.brain.runClaudeAgent({
                    prompt: prepResult.prompt,
                    projectPath: prepResult.projectPath,
                    allowedTools: ['Read', 'Write', 'Edit', 'Bash', 'Glob', 'Grep']
                });

                activeClaudeProcess = runResult.processId;

            } catch (error) {
                showToast('Fout: ' + error.message);
                logToDevTools('Claude build error: ' + error.message, 'error');
                if (outputDiv) outputDiv.textContent += `\n‚ùå Fout: ${error.message}\n`;

                // Re-enable start button
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'üèóÔ∏è Start Bouwen met Claude';
                }
            }
        }

        async function stopClaudeBuild(videoId) {
            if (activeClaudeProcess) {
                try {
                    await window.brain.stopClaudeAgent(activeClaudeProcess);
                    showToast('Claude build gestopt');
                    logToDevTools('Claude build stopped', 'info');
                } catch (error) {
                    logToDevTools('Error stopping Claude: ' + error.message, 'error');
                }
            }
        }

        async function openTerminalForProject(videoId) {
            const video = videoData[videoId];
            if (!video) return;

            try {
                // First export the project
                const result = await window.brain.exportToClaudeCode({
                    title: video.title,
                    analysis: video.fullAnalysis,
                    claudePrompt: video.claudePrompt,
                    filePaths: video.filePaths || [],
                    persona: video.persona,
                    goalType: video.goalType,
                    date: video.date
                });

                if (result.success) {
                    currentProjectPath = result.projectPath;
                    await window.brain.openTerminalInProject(result.projectPath);
                    showToast('Terminal geopend in project map');
                    logToDevTools('Opened terminal in: ' + result.projectPath, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showToast('Fout: ' + error.message);
                logToDevTools('Error opening terminal: ' + error.message, 'error');
            }
        }

        async function openProjectFolder() {
            if (currentProjectPath) {
                await window.brain.openProjectFolder(currentProjectPath);
            }
        }

        // ============================================
        // BACKUP SYSTEM
        // ============================================
        async function createBackup() {
            const nameInput = document.getElementById('backupNameInput');
            const descInput = document.getElementById('backupDescInput');
            const name = nameInput?.value.trim() || '';
            const description = descInput?.value.trim() || '';

            try {
                showToast('Backup maken...');
                logToDevTools('Creating backup...', 'info');

                const result = await window.brain.createBackup({ name, description });

                if (result.success) {
                    showToast(`Backup "${result.name}" gemaakt!`);
                    logToDevTools(`Backup created: ${result.name}`, 'success');

                    // Clear inputs
                    if (nameInput) nameInput.value = '';
                    if (descInput) descInput.value = '';

                    // Refresh backup list
                    await loadBackupList();
                } else {
                    showToast('Fout: ' + result.error);
                    logToDevTools('Backup error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Backup fout: ' + error.message);
                logToDevTools('Backup error: ' + error.message, 'error');
            }
        }

        async function loadBackupList() {
            const listEl = document.getElementById('backupList');
            if (!listEl) return;

            try {
                const result = await window.brain.listBackups();

                if (!result.success || !result.backups || result.backups.length === 0) {
                    listEl.innerHTML = '<div style="color: var(--text-muted); font-style: italic;">Geen backups gevonden</div>';
                    return;
                }

                const html = result.backups.map(backup => {
                    const isProtected = backup.name === 'v1.0-20260105';
                    return `
                        <div class="backup-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary);">
                                    ${isProtected ? 'üîí ' : 'üíæ '}${escapeHtml(backup.name)}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    ${backup.description || 'Geen beschrijving'}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    üìÖ ${backup.date} | üìÅ ${backup.files?.length || 0} bestanden
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="restoreBackup('${escapeHtml(backup.name)}')" style="padding: 0.4rem 0.75rem; font-size: 0.85rem;">
                                    ‚ôªÔ∏è Herstel
                                </button>
                                ${!isProtected ? `
                                    <button class="btn btn-small" onclick="deleteBackup('${escapeHtml(backup.name)}')" style="padding: 0.4rem 0.75rem; font-size: 0.85rem; background: var(--danger);">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                listEl.innerHTML = html;
            } catch (error) {
                listEl.innerHTML = `<div style="color: var(--danger);">Fout bij laden: ${error.message}</div>`;
                logToDevTools('Load backups error: ' + error.message, 'error');
            }
        }

        async function restoreBackup(name) {
            if (!confirm(`Weet je zeker dat je wilt herstellen naar "${name}"?\n\nDit zal de huidige app bestanden overschrijven. Maak eerst een backup van de huidige versie!`)) {
                return;
            }

            try {
                showToast('Herstellen...');
                logToDevTools(`Restoring backup: ${name}`, 'info');

                const result = await window.brain.restoreBackup(name);

                if (result.success) {
                    showToast('Backup hersteld! App herstart...');
                    logToDevTools(`Backup restored: ${name}. Restarting...`, 'success');

                    // Restart app after brief delay
                    setTimeout(async () => {
                        await window.brain.restartApp();
                    }, 1500);
                } else {
                    showToast('Fout: ' + result.error);
                    logToDevTools('Restore error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Herstel fout: ' + error.message);
                logToDevTools('Restore error: ' + error.message, 'error');
            }
        }

        async function deleteBackup(name) {
            if (!confirm(`Weet je zeker dat je backup "${name}" wilt verwijderen?\n\nDit kan niet ongedaan gemaakt worden.`)) {
                return;
            }

            try {
                const result = await window.brain.deleteBackup(name);

                if (result.success) {
                    showToast('Backup verwijderd');
                    logToDevTools(`Backup deleted: ${name}`, 'success');
                    await loadBackupList();
                } else {
                    showToast('Fout: ' + result.error);
                    logToDevTools('Delete error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Verwijder fout: ' + error.message);
                logToDevTools('Delete error: ' + error.message, 'error');
            }
        }

        async function exportToObsidian() {
            try {
                showToast('Exporteren naar Obsidian...');
                logToDevTools('Exporting to Obsidian...', 'info');

                const result = await window.brain.exportToObsidian();

                if (result.success) {
                    showToast(`Ge√´xporteerd: ${result.files?.length || 0} bestanden`);
                    logToDevTools(`Export complete: ${result.path}`, 'success');
                } else {
                    showToast('Fout: ' + result.error);
                    logToDevTools('Export error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Export fout: ' + error.message);
                logToDevTools('Export error: ' + error.message, 'error');
            }
        }

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        function updateDataStats() {
            const contentCount = Object.keys(videoData).length;
            const folderCount = Object.keys(folderData).length;
            document.getElementById('statContentCount').textContent = contentCount;
            document.getElementById('statFolderCount').textContent = folderCount;
        }

        async function removeDuplicates() {
            const savedContent = JSON.parse(localStorage.getItem('brain-custom-videos') || '[]');
            const seen = new Map();
            const duplicates = [];

            savedContent.forEach(item => {
                // Create a unique key based on title and type
                const key = `${item.title}-${item.type}`;
                if (seen.has(key)) {
                    duplicates.push(item);
                } else {
                    seen.set(key, item);
                }
            });

            if (duplicates.length === 0) {
                showToast('Geen duplicaten gevonden');
                return;
            }

            if (!confirm(`${duplicates.length} duplicaten gevonden. Wil je deze verwijderen?\n\nDuplicaten:\n${duplicates.map(d => '- ' + d.title).join('\n')}`)) {
                return;
            }

            // Keep only unique items
            const unique = Array.from(seen.values());

            // Update videoData
            Object.keys(videoData).forEach(key => {
                if (!key.startsWith('example-')) {
                    delete videoData[key];
                }
            });
            unique.forEach(item => {
                videoData[item.id] = item;
            });

            // Save to electron-store and localStorage
            await saveAllContentToStorage();

            renderVideoList();
            updateDataStats();
            showToast(`${duplicates.length} duplicaten verwijderd`);
            logApp(`Removed ${duplicates.length} duplicates`);
        }

        function clearAllContent() {
            const count = Object.keys(videoData).filter(k => !k.startsWith('example-')).length;

            if (!confirm(`‚ö†Ô∏è WAARSCHUWING!\n\nDit verwijdert ${count} content items PERMANENT.\n\nWeet je dit zeker?`)) {
                return;
            }

            if (!confirm('Laatste kans: Heb je een backup gemaakt?')) {
                return;
            }

            // Clear custom content
            localStorage.removeItem('brain-custom-videos');
            localStorage.removeItem('brain-folders');

            // Clear videoData except examples
            Object.keys(videoData).forEach(key => {
                if (!key.startsWith('example-')) {
                    delete videoData[key];
                }
            });

            // Clear folders
            folderData = {};

            renderVideoList();
            updateDataStats();
            showToast('Alle content verwijderd');
            logApp('All content cleared');
        }

        function showContentManager() {
            const content = Object.values(videoData).filter(v => !v.id?.startsWith('example-'));

            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            html += '<table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">';
            html += '<thead><tr style="background: var(--bg-dark);"><th style="padding: 0.5rem; text-align: left;">Titel</th><th>Type</th><th>Datum</th><th>Actie</th></tr></thead>';
            html += '<tbody>';

            content.forEach(item => {
                html += `<tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.5rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${item.title}</td>
                    <td style="padding: 0.5rem; text-align: center;">${item.type}</td>
                    <td style="padding: 0.5rem; text-align: center;">${item.date}</td>
                    <td style="padding: 0.5rem; text-align: center;">
                        <button class="btn btn-small" onclick="deleteContent('${item.id}'); showContentManager();" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #ef4444;">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            // Show in a modal
            const modal = document.createElement('div');
            modal.id = 'contentManagerModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üìã Content Manager (${content.length} items)</h3>
                        <button onclick="document.getElementById('contentManagerModal').remove()" style="background: transparent; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Load backup list when Settings panel becomes visible
        function initBackupSystem() {
            loadBackupList();
            updateDataStats();

            // Display app version
            if (window.brain?.getAppVersion) {
                window.brain.getAppVersion().then(result => {
                    if (result.success) {
                        const versionEl = document.getElementById('appVersionInfo');
                        if (versionEl) {
                            versionEl.innerHTML = `<strong>Brain App v${result.version}</strong> - ${result.date}`;
                        }
                    }
                });
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(msg) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'toast success';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        // Console override for DevTools
        const origLog = console.log;
        console.log = (...args) => {
            origLog(...args);
            logToDevTools(args.join(' '), 'log');
        };

        console.log('Brain App loaded');
    </script>
</body>
</html>
